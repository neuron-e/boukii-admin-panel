<div style="width: 100%; gap: 8px; display: flex; flex-direction: column;">
  <ng-container *ngFor="let item of asArray(courseFormGroup.controls['levelGrop'].value); index as i">
    <div *ngIf="item.active" style="height: 100%;width: 100%;">
      <div [style.backgroundColor]="item.color+'33'" [style.border]="'1px solid '+item.color"
           (click)="item.modal=!item.modal"
           style="height: 74px; padding: 10px;border-radius: 4px; cursor: pointer;">
        <div [style.color]="item.color"
             style="font-size: 14px; font-weight: 600; display: flex;align-items: center; margin-bottom: 5px;">
          <img src="assets/icons/icon/award.png" class="icon24">
          <span>
					{{item.annotation}} {{item.level}}
				</span>
          <mat-icon *ngIf="!item.modal" class="icon24" style="margin-left:auto;">
            keyboard_arrow_up
          </mat-icon>
          <mat-icon *ngIf="item.modal" class="icon24" style="margin-left:auto;">
            keyboard_arrow_down
          </mat-icon>
        </div>
        <div style="display: flex;align-items: center;">
          <img src="assets/icons/icon/people.png" class="icon16">
          <span>
  {{ countSubgroups(courseDates, item.id) }}g
  · {{ countBookingUsersForDegree(courseFormGroup.controls.booking_users.value, courseDates, item.id) }} /
            {{ (item.max_participants || courseFormGroup.controls['max_participants'].value) * countSubgroups(courseDates, item.id) || 0 }}px
</span>
          <div style="margin: auto;"></div>
          <ng-container>
            <img src="assets/icons/icon/calendar.png" class="icon16">
            <span>
					{{courseDates.length
            || 0}} {{'days' | translate}}
				</span>
            <span *ngIf="courseFormGroup.controls['course_dates'].value?.[0]?.duration">
					&nbsp;{{courseFormGroup.controls['course_dates'].value[0].duration}}
				</span>
          </ng-container>
          <div style="margin: auto;"></div>
          <img src="assets/icons/icon/ticket.png" class="icon16">
          <span>
				 {{'age'| translate}}	{{item.age_min}} / {{item.age_max}}
			</span>
          <div style="margin: auto;"></div>
        </div>
      </div>

      <!-- IMPROVED SUBGROUP DESIGN WITH DATE-BASED STRUCTURE -->
      <ng-container *ngIf="item.modal">
        <!-- Usar getAllUniqueSubgroupsForDegree para mostrar TODOS los subgrupos únicos -->
        <div *ngFor="let ix of asArray(getSubgroupsForDegreeCached(item.id)); index as i"
             style="margin-bottom: 16px; border: 1px solid var(--color-grey2); border-radius: 8px; background-color: white; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">

          <!-- Subgroup Header -->
          <div (click)="toggleSubgroup(item.id, i)" style="padding: 16px; background-color: var(--color-grey5); border-bottom: 1px solid var(--color-grey2); cursor: pointer;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
              <div style="display: flex; align-items: center; gap: 12px;">
                <h4 style="margin: 0; font-weight: 600; color: var(--color-dark1); font-size: 16px;">
                  {{item.annotation}} {{item.level}} {{i+1}}
                </h4>
                <span style="display: inline-flex; align-items: center; gap: 6px; font-size: 14px; color: var(--color-dark2); background: white; padding: 4px 8px; border-radius: 12px; border: 1px solid var(--color-grey2);">
                  <img src="assets/icons/icon/people.png" class="icon16">
                  {{ getUniqueClientsCountForSubgroupIndex(courseFormGroup.controls.booking_users.value, courseDates, item.id, i) }} /
                  {{ getSubgroupCapacity(courseDates, item.id, i, (ix.max_participants || courseFormGroup.controls['max_participants'].value || 0)) }}
                </span>
              </div>
              <div style="display: flex; gap: 8px; align-items: center;">
                <button mat-icon-button color="primary"
                        *ngIf="!hideTimingButton"
                        (click)="onTimingClick(ix, item); $event.stopPropagation()"
                        [matTooltip]="'timing.view_times' | translate"
                        [attr.aria-label]="'timing.view_times' | translate"
                        style="background: white; border: 1px solid var(--color-grey2);">
                  <mat-icon style="font-size: 18px;">schedule</mat-icon>
                </button>
                <button
                  (click)="changeMonitor.emit({date: getCourseDates(), subgroup: ix}); $event.stopPropagation()"
                  *ngIf="checkbox && selectedSubgroup.id != ix.id"
                  style="height: 36px; padding: 0 16px; border-radius: 18px;"
                  color="primary" mat-raised-button type="button">
                  {{'add' | translate }}
                </button>
                <mat-icon class="icon24" style="color: var(--color-dark2);">
                  {{ isSubgroupCollapsed(item.id, i) ? 'keyboard_arrow_down' : 'keyboard_arrow_up' }}
                </mat-icon>
              </div>
            </div>
          </div>

          <!-- Date-based Content - Solo mostrar las fechas que tienen este subgrupo -->
          <div *ngIf="!isSubgroupCollapsed(item.id, i)" style="padding: 16px;">
            <ng-container *ngIf="getCourseDatesForSubgroupIndex(courseDates, item.id, i)?.length; else noMonitors">
              <!-- Iterar solo sobre las fechas que tienen este subgrupo específico -->
              <ng-container *ngFor="let course_date of getCourseDatesForSubgroupIndex(courseDates, item.id, i); let dateIndex = index">
                <ng-container *ngIf="getSubgroupForCourseDateIndex(course_date, item.id, i) as subG">

                  <!-- Date Section -->
                  <div style="margin-bottom: 16px; border: 1px solid var(--color-grey2); border-radius: 6px; background: white;">
                    <div style="padding: 12px 16px; background-color: var(--color-grey4); border-bottom: 1px solid var(--color-grey2); border-radius: 6px 6px 0 0; display: flex; justify-content: space-between; align-items: center;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <img src="assets/icons/icon/calendar.png" class="icon16">
                        <span style="font-weight: 600; font-size: 14px; color: var(--color-dark1);">
                          {{course_date.date | date:'EEEE, MMMM d, y'}}
                        </span>
                        <span *ngIf="getIntervalLabelForCourseDate(course_date) as intervalLabel"
                              style="display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 600; color: #006fcb; background: #D2EFFF; padding: 2px 8px; border-radius: 12px;">
                          <mat-icon style="font-size: 14px;">timelapse</mat-icon>
                          {{ intervalLabel }}
                        </span>
                        <span style="display: inline-flex; align-items: center; gap: 4px; font-size: 12px; font-weight: 600; color: white; background: #31C044; padding: 2px 8px; border-radius: 12px;">
                          {{ getCapacityIndicatorForDate(courseFormGroup.controls.booking_users.value, item.id, i, course_date.id, getSubgroupCapacity(courseDates, item.id, i, (ix.max_participants || courseFormGroup.controls['max_participants'].value || 0))) }}
                        </span>
                      </div>
                      <span *ngIf="course_date.duration" style="font-size: 12px; background: var(--color-grey3); padding: 2px 8px; border-radius: 4px; color: var(--color-dark2);">
                        {{course_date.duration}}
                      </span>
                    </div>

                    <!-- Monitor Section -->
                    <div *ngIf="!checkbox" style="padding: 12px 16px; border-bottom: 1px solid var(--color-grey2); background: white;">
                      <div style="display: flex; align-items: center; gap: 8px;">
                        <img src="assets/icons/icon/monitor.png" class="icon16" style="opacity: 0.7;">
                        <span style="font-weight: 500; color: var(--color-dark2); font-size: 13px;">{{'monitor' | translate}}:</span>
                        <span *ngIf="subG?.monitor as mon; else noMonitor" style="color: var(--color-dark1); font-weight: 500;">
                          {{ mon?.first_name }} {{ mon?.last_name }}
                        </span>
                        <ng-template #noMonitor>
                          <span style="color: var(--color-grey1); font-style: italic; font-size: 12px;">{{"text_nomonitorset" | translate}}</span>
                        </ng-template>
                      </div>
                    </div>

                    <!-- Students Section -->
                    <div style="padding: 12px 16px;">
                      <div style="margin-bottom: 8px; display: flex; align-items: center; gap: 6px;">
                        <img src="assets/icons/icon/people.png" class="icon16" style="opacity: 0.7;">
                        <span style="font-weight: 500; color: var(--color-dark2); font-size: 13px;">{{'students' | translate}}:</span>
                      </div>
                      <!-- Show all students for this subgroup -->
                      <ng-container *ngFor="let user of getUsersForCourseDateSubgroupIndex(courseFormGroup.controls.booking_users.value, item.id, course_date, i)">
                        <div style="padding: 8px 12px; margin-bottom: 4px; border: 1px solid var(--color-grey2); display: flex; align-items: center; background: var(--color-grey5); border-radius: 4px;">
                          <!-- Attendance Checkbox/Indicator -->
                          <mat-checkbox *ngIf="isDatePast(course_date.date)"
                                        [checked]="isAttended(user)"
                                        (change)="onAttendanceToggle(user, $event.checked)"
                                        style="margin-right: 8px;"
                                        [color]="'primary'">
                          </mat-checkbox>
                          <mat-icon *ngIf="!isDatePast(course_date.date)"
                                    style="font-size: 14px; width: 14px; height: 14px; margin-right: 8px;"
                                    [style.color]="isAttended(user) ? '#31C044' : '#C7D0D3'">
                            circle
                          </mat-icon>
                          <span style="font-size: 14px; color: var(--color-dark1);">
                            {{ (user.client?.first_name || user.first_name || user.name || '') }} {{ (user.client?.last_name || user.last_name || '') }}
                          </span>
                        </div>
                      </ng-container>

                      <!-- Empty slots -->
                      <ng-container *ngIf="checkbox">
                        <ng-container *ngFor="let emptySlot of numUsersArray(getSubgroupCapacity(courseDates, item.id, i, (ix.max_participants || courseFormGroup.controls['max_participants'].value || 0)))">
                          <div *ngIf="emptySlot >= getUniqueClientsCountForSpecificDateSubgroup(courseFormGroup.controls.booking_users.value, item.id, course_date.id, subG?.id)"
                               style="padding: 8px 12px; margin-bottom: 4px; border: 1px dashed var(--color-grey3); display: flex; align-items: center; background: var(--color-grey4); border-radius: 4px; color: var(--color-grey1);">
                            <mat-icon style="font-size: 14px; width: 14px; height: 14px; margin-right: 8px; color: #C7D0D3;">
                              circle
                            </mat-icon>
                            <span style="font-size: 13px; font-style: italic;">{{"not_assigned" | translate}}</span>
                          </div>
                        </ng-container>
                      </ng-container>
                    </div>
                  </div>
                </ng-container>
              </ng-container>
            </ng-container>

            <ng-template #noMonitors>
              <div style="text-align: center; padding: 24px; color: var(--color-grey1);">
                <img src="assets/icons/icon/calendar.png" class="icon24" style="opacity: 0.5; margin-bottom: 8px;">
                <p style="margin: 0; font-size: 14px; font-style: italic;">{{"text_nomonitorset" | translate}}</p>
              </div>
            </ng-template>
          </div>
        </div>
      </ng-container>
    </div>
  </ng-container>
</div>
