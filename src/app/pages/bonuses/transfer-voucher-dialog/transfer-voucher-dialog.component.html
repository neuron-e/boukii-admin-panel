<div class="flex flex-col">
  <div mat-dialog-title class="flex items-center justify-between">
    <h2 class="m-0">{{'voucher.transfer_title' | translate}}</h2>
    <button (click)="cancel()"
            mat-icon-button
            type="button">
      <mat-icon svgIcon="mat:close"></mat-icon>
    </button>
  </div>

  <mat-divider class="mb-4"></mat-divider>

  <mat-dialog-content>
    <div *ngIf="!loading" class="flex flex-col">
      <!-- Voucher Information -->
      <div class="p-4 rounded mb-4" style="background-color: #F5F5F5;">
        <h3 class="text-md font-medium mb-2">{{'voucher.info_title' | translate}}</h3>
        <div class="grid grid-cols-2 gap-2 text-sm">
          <div>
            <span class="font-medium">{{'code' | translate}}:</span>
            <span class="ml-2">{{data.voucher.code}}</span>
          </div>
          <div *ngIf="data.voucher.name">
            <span class="font-medium">{{'name' | translate}}:</span>
            <span class="ml-2">{{data.voucher.name}}</span>
          </div>
          <div>
            <span class="font-medium">{{'voucher.balance' | translate}}:</span>
            <span class="ml-2">{{data.voucher.remaining_balance}}</span>
          </div>
          <div *ngIf="data.voucher.course_type_id">
            <span class="font-medium">{{'voucher.course_type' | translate}}:</span>
            <span class="ml-2">{{data.voucher.course_type_id === 1 ? ('collective' | translate) : ('private' | translate)}}</span>
          </div>
        </div>
      </div>

      <!-- Client Selector -->
      <form [formGroup]="form">
        <mat-form-field appearance="outline" class="w-full">
          <mat-label>{{'voucher.select_client' | translate}}</mat-label>
          <input [formControl]="clientsForm"
                 [matAutocomplete]="auto"
                 type="text"
                 placeholder="{{'choose_client' | translate}}"
                 matInput>
          <mat-autocomplete #auto="matAutocomplete"
                            [displayWith]="displayFn"
                            (optionSelected)="onClientSelected($event.option.value)">
            <mat-option *ngFor="let client of filteredOptions | async"
                        [value]="client">
              {{client.first_name}} {{client.last_name}}
            </mat-option>
          </mat-autocomplete>
          <mat-icon matPrefix svgIcon="mat:person"></mat-icon>
        </mat-form-field>
      </form>

      <!-- Availability Check Result -->
      <div *ngIf="checking" class="flex items-center justify-center py-4">
        <mat-spinner diameter="40"></mat-spinner>
        <span class="ml-3">{{'voucher.checking_availability' | translate}}</span>
      </div>

      <div *ngIf="!checking && selectedClient && availabilityMessage"
           class="p-4 rounded mb-4"
           [ngClass]="{
             'bg-green-50 border-l-4 border-green-500': canBeUsed,
             'bg-red-50 border-l-4 border-red-500': !canBeUsed
           }">
        <div class="flex items-start">
          <mat-icon [class]="canBeUsed ? 'text-green-600' : 'text-red-600'" class="mr-2">
            {{canBeUsed ? 'check_circle' : 'error'}}
          </mat-icon>
          <div class="flex-1">
            <p class="text-sm m-0">{{availabilityMessage}}</p>
          </div>
        </div>
      </div>

      <!-- Warning if not transferable -->
      <div *ngIf="!data.voucher.is_transferable"
           class="p-4 rounded mb-4"
           style="background-color: #FFF3E0; border-left: 4px solid #FF9800;">
        <div class="flex items-center">
          <mat-icon class="text-orange-600 mr-2">warning</mat-icon>
          <span class="text-sm font-medium">{{'voucher.not_marked_transferable' | translate}}</span>
        </div>
      </div>

      <!-- Transfer Instructions -->
      <div class="text-sm text-gray-600 mb-4">
        <p class="m-0">
          {{'voucher.transfer_notice' | translate}}
        </p>
      </div>
    </div>

    <div *ngIf="loading" class="flex items-center justify-center py-8">
      <mat-spinner diameter="50"></mat-spinner>
    </div>
  </mat-dialog-content>

  <mat-divider class="mt-4"></mat-divider>

  <mat-dialog-actions align="end" class="mt-4">
    <button (click)="cancel()"
            mat-button
            type="button">
      {{'cancel' | translate}}
    </button>
    <button (click)="transfer()"
            [disabled]="!selectedClient || !canBeUsed || transferring || !data.voucher.is_transferable"
            color="primary"
            mat-raised-button
            type="button">
      <mat-spinner *ngIf="transferring" diameter="20" class="inline-block mr-2"></mat-spinner>
      {{'voucher.transfer_action' | translate}}
    </button>
  </mat-dialog-actions>
</div>
