<vex-secondary-toolbar current>
  <vex-breadcrumbs [crumbs]="[
    { icon: 'cursos' },
    { text: 'courses.title', title: true, link: '/courses' },
    {
      text: mode !== 'update'
        ? translateService.instant('courses.new')
        : translateService.instant('courses.update') + ' #' + id,
      subtitle: true
    }
  ]" class="flex">
  </vex-breadcrumbs>
</vex-secondary-toolbar>
<vex-flux-toolbad [Modal]="ModalProgress" [Flux]="ModalFlux" [create]="mode!=='create'"
                  (Check)="ModalFlux=$event;Confirm(0)"></vex-flux-toolbad>
<vex-flux-layout>
  <mat-spinner *ngIf="loading" loading style="margin:0 auto"></mat-spinner>
  <div *ngIf="!loading" body>
    <div *ngIf="ModalFlux===0" [formGroup]="courses.courseFormGroup" class="flex flex-col"
         style="padding: 20px 20px 0;">
      <mat-radio-group class="flex" style="flex-wrap: wrap;gap: 16px;justify-content: space-between;"
                       formControlName="sport_id">
        <mat-radio-button *ngFor="let item of sportData" [value]="item.sport_id" class="sport_checkbox"
                          style="cursor: pointer;">
          <div style="display: flex;align-items: center;">
            <img *ngIf="courses.courseFormGroup.controls['sport_id'].value===item.sport_id"
                 [src]="item.sport.icon_selected" class="sport_icon selected">
            <img *ngIf="courses.courseFormGroup.controls['sport_id'].value!==item.sport_id"
                 [src]="item.sport.icon_unselected" class="sport_icon noselected">
            {{item.sport.name | translate}}
          </div>
        </mat-radio-button>
      </mat-radio-group>
    </div>
    <div *ngIf="ModalFlux===1" [formGroup]="courses.courseFormGroup" class="flex flex-col">
      <mat-tab-group [selectedIndex]="courses.courseFormGroup.controls['course_type'].value-1||0"
                     (selectedIndexChange)="courses.courseFormGroup.patchValue({course_type:$event+1});setModalProgress()">
        <mat-tab [disabled]="mode==='update'">
          <ng-template mat-tab-label>
            <mat-icon style="color: #E5962A;" class="icon16">
              circle
            </mat-icon>
            {{"course_colective" | translate}}
          </ng-template>
        </mat-tab>
        <mat-tab [disabled]="mode==='update'">
          <ng-template mat-tab-label>
            <mat-icon style="color: #2FAA41;" class="icon16">
              circle
            </mat-icon>
            {{"course_private" | translate}}
          </ng-template>
        </mat-tab>
        <!-- <mat-tab [disabled]="mode==='update'">
           <ng-template mat-tab-label>
             <mat-icon style="color: #0AB0BC;" class="icon16">
               circle
             </mat-icon>
             {{"activity" | translate}}
           </ng-template>
         </mat-tab>-->
      </mat-tab-group>
      <div style="padding: 20px 20px 0;">
        <mat-checkbox [disabled]="mode==='update'" formControlName="is_flexible" (change)="setModalProgress()">
          {{'flexidates' | translate }}
        </mat-checkbox>

        <vex-flux-upload-img [imagePreviewUrl]="courses.courseFormGroup.controls['image'].value"
                             (upload)="courses.courseFormGroup.patchValue({image:$event})" [edit]="true" [width]="320"
                             [height]="150" style="margin-top: 10px;"></vex-flux-upload-img>
        <app-form-input [required]="true" [form]="courses.courseFormGroup" control="name"
                        name="courses.coursename">
        </app-form-input>
        <app-form-select [required]="true" [table]="stations" [form]="courses.courseFormGroup" label="station"
                         control="station_id" id="id" name="name">
        </app-form-select>
        <div style="display:flex; flex-direction:column; gap:12px; margin-top:8px;">
          <mat-form-field appearance="outline" style="width: 100%;" *ngIf="meetingPoints.length">
            <mat-label>{{ 'meeting_point_select' | translate }}</mat-label>
            <mat-select [(value)]="selectedMeetingPointId" (selectionChange)="onMeetingPointSelected($event.value)">
              <mat-option *ngFor="let point of meetingPoints" [value]="point.id">
                {{ point.name }}<span *ngIf="point.address"> – {{ point.address }}</span>
              </mat-option>
            </mat-select>
          </mat-form-field>
          <div *ngIf="!meetingPoints.length" style="color:#6c757d; font-size:13px;">
            {{ 'settings.meeting_points.empty' | translate }}
          </div>
          <app-form-input [form]="courses.courseFormGroup" control="meeting_point" name="meeting_point"></app-form-input>
          <app-form-input [form]="courses.courseFormGroup" control="meeting_point_address" name="meeting_point_address"></app-form-input>
          <mat-form-field appearance="outline" style="width: 100%;">
            <mat-label>{{ 'meeting_point_instructions' | translate }}</mat-label>
            <textarea matInput formControlName="meeting_point_instructions" rows="2"></textarea>
          </mat-form-field>
        </div>
        <app-form-editor [required]="true" [form]="courses.courseFormGroup" control="short_description"
                         name="courses.summary">
        </app-form-editor>
        <app-form-editor [required]="true" [form]="courses.courseFormGroup" control="description"
                         name="courses.desc">
        </app-form-editor>
        <div style="display: flex; flex-wrap: wrap; column-gap: 20px;">
          <app-form-input
            [hidden]="courses.courseFormGroup.controls['is_flexible'].value
    && courses.courseFormGroup.controls['course_type'].value != 1"
            [required]="true"
            [form]="courses.courseFormGroup"
            [Suffix]="courses.courseFormGroup.controls['currency'].value"
            style="width: calc(50% - 10px);"
            control="price"
            value="0"
            name="{{ courses.courseFormGroup.controls['is_flexible'].value
    ? (courses.courseFormGroup.controls['course_type'].value == 1 ? 'price_per_date' : 'min_price')
    : 'price_per_course' }}"
            type="number">
          </app-form-input>

          <app-form-input [required]="true" [form]="courses.courseFormGroup" style="width: calc(50% - 10px);"
                          control="max_participants" name="max_pax" Suffix="paxes" type="number">
          </app-form-input>
          <ng-container *ngIf="courses.courseFormGroup.controls['course_type'].value>1">
            <app-form-input [required]="true" [form]="courses.courseFormGroup"
                            style="width: calc(50% - 10px);" control="age_min" name="min_age" Suffix="years"
                            type="number">
            </app-form-input>
            <app-form-input [required]="true" [form]="courses.courseFormGroup"
                            [min]="courses.courseFormGroup.controls['age_min'].value" style="width: calc(50% - 10px);"
                            control="age_max" name="max_age" Suffix="years" type="number">
            </app-form-input>
          </ng-container>
        </div>
      </div>
    </div>
    <div *ngIf="ModalFlux===2" class="flex flex-col">
			<span style="margin: 20px;">
				{{'dates' | translate}}
			</span>


      <div [formGroup]="courses.courseFormGroup"
           style="padding: 0 20px; display: flex; flex-wrap: nowrap; column-gap: 20px;">
        <app-form-datepicker [required]="true" [form]="courses.courseFormGroup"
                             [min]="mode==='create'?nowDate:detailData.date_start_res"
                             (do)="courses.courseFormGroup.patchValue({date_start:$event.value,date_start_res:$event.value});
					courses.courseFormGroup.controls['date_end'].value<$event.value?courses.courseFormGroup.patchValue({date_end:$event.value,date_end_res:$event.value}):null"
                             control="date_start_res" style="min-width: 0;width: 100%;" name="courses.date_reservable">
        </app-form-datepicker>
        <app-form-datepicker [required]="true" [form]="courses.courseFormGroup"
                             [min]="mode==='create'?nowDate:detailData.date_start_end"
                             (do)="courses.courseFormGroup.patchValue({date_end:$event.value,date_end_res:$event.value})"
                             control="date_end_res" style="min-width: 0;width: 100%;" name="courses.date_reservable_to">
        </app-form-datepicker>
        <app-form-select *ngIf="courses.courseFormGroup.controls['course_type'].value>1" [required]="true"
                         [table]="courses.duration" [form]="courses.courseFormGroup" label="{{courses.courseFormGroup.controls['is_flexible'].value ? 'courses.dur_min' : 'duration'}}"
                         style="min-width: 0;width: 100%;" control="duration">
        </app-form-select>

      </div>
      <!-- Secci├│n para activar m├║ltiples intervalos (solo para cursos colectivos flexibles) -->
      <div class="form-check form-switch mb-3" *ngIf="courses.courseFormGroup.controls['is_flexible'].value && courses.courseFormGroup.controls['course_type'].value === 1">
        <mat-checkbox [(ngModel)]="useMultipleIntervals" (change)="onMultipleIntervalsChange()">
          {{'multiple_intervals' | translate }}
        </mat-checkbox>
        <div style="margin-left: 24px; margin-top: 8px; font-size: 12px; color: #6c757d;">
          {{'multiple_intervals_help' | translate}}
        </div>

        <!-- Intervals Configuration Mode Toggle (solo visible si hay m├║ltiples intervalos activos) -->
        <div *ngIf="useMultipleIntervals" style="margin-top: 16px; margin-left: 24px; padding: 16px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 6px;">
          <mat-slide-toggle
            [ngModel]="courses.courseFormGroup.controls['intervals_config_mode'].value === 'independent'"
            [ngModelOptions]="{standalone: true}"
            (change)="onIntervalsConfigModeChange($event.checked)"
            color="primary">
            <span style="font-weight: 500; color: #495057;">
              {{ (courses.courseFormGroup.controls['intervals_config_mode'].value === 'independent'
                 ? 'independent_mode_label'
                 : 'unified_mode_label') | translate }}
            </span>
          </mat-slide-toggle>
          <p style="font-size: 12px; color: #6c757d; margin-top: 8px; margin-bottom: 0; margin-left: 0;">
            <mat-icon style="font-size: 14px; vertical-align: middle; margin-right: 4px;">info</mat-icon>
            {{ (courses.courseFormGroup.controls['intervals_config_mode'].value === 'independent'
               ? 'independent_mode_description'
               : 'unified_mode_description') | translate }}
          </p>
        </div>
      </div>

      <ng-container *ngIf="courses.courseFormGroup.controls['course_type'].value===1">
        <!-- INTERVALOS DE FECHAS -->
        <!-- Configuraci├│n global de intervalos (solo visible en modo unificado) -->
        <div *ngIf="!useMultipleIntervals || courses.courseFormGroup.controls['intervals_config_mode'].value !== 'independent'"
             class="global-interval-settings mb-4 p-3 border rounded bg-light" style="margin: 20px; padding: 20px; background-color: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px;">
          <h4 class="mb-3" style="color: #495057; font-size: 16px; font-weight: 600; margin-bottom: 16px;">
            <mat-icon style="vertical-align: middle; margin-right: 8px; color: #6c757d;">settings</mat-icon>
            {{'global_interval_settings' | translate}}
          </h4>

          <div class="row mb-3" style="display: flex; flex-direction: column; gap: 16px;">
            <div class="form-check-container" style="padding: 16px; background-color: white; border: 1px solid #dee2e6; border-radius: 6px;">
              <mat-checkbox [(ngModel)]="mustBeConsecutive" (change)="syncIntervalsToCourseFormGroup()"
                           style="margin-bottom: 8px;">
                <span style="font-weight: 500; color: #495057;">
                  {{'dates_must_be_consecutive' | translate }}
                </span>
              </mat-checkbox>
              <div style="margin-left: 32px; color: #6c757d; font-size: 14px; line-height: 1.4;">
                <mat-icon style="font-size: 16px; vertical-align: middle; margin-right: 4px;">info</mat-icon>
                {{'consecutive_dates_explanation' | translate}}
              </div>
            </div>

            <div class="form-check-container" style="padding: 16px; background-color: white; border: 1px solid #dee2e6; border-radius: 6px;">
              <mat-checkbox [(ngModel)]="mustStartFromFirst" (change)="syncIntervalsToCourseFormGroup()"
                           style="margin-bottom: 8px;">
                <span style="font-weight: 500; color: #495057;">
                  {{'must_start_from_first_day' | translate }}
                </span>
              </mat-checkbox>
              <div style="margin-left: 32px; color: #6c757d; font-size: 14px; line-height: 1.4;">
                <mat-icon style="font-size: 16px; vertical-align: middle; margin-right: 4px;">info</mat-icon>
                {{'start_from_first_explanation' | translate}}
              </div>
            </div>
          </div>

          <!-- Info sobre fechas reservables globales -->
          <div style="padding: 16px; background-color: white; border: 1px solid #dee2e6; border-radius: 6px; margin-top: 16px;">
            <h6 style="margin: 0 0 8px 0; color: #495057; font-size: 13px; font-weight: 600;">
              <mat-icon style="font-size: 16px; vertical-align: middle; margin-right: 4px; color: #17a2b8;">event_available</mat-icon>
              {{ 'global_bookable_dates' | translate }}
            </h6>
            <p style="font-size: 12px; color: #6c757d; margin: 0;">
              {{ 'global_bookable_dates_info' | translate }}
              <strong>{{ courses.courseFormGroup.get('date_start_res').value | date:'dd/MM/yyyy' }}</strong>
              {{ 'to' | translate }}
              <strong>{{ courses.courseFormGroup.get('date_end_res').value | date:'dd/MM/yyyy' }}</strong>
            </p>
            <p style="font-size: 11px; color: #6c757d; margin: 8px 0 0 0; font-style: italic;">
              {{ 'change_dates_above' | translate }}
            </p>
          </div>

          <div class="alert alert-info" style="background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 12px; border-radius: 6px; font-size: 13px; margin-top: 16px;">
            <mat-icon style="font-size: 16px; vertical-align: middle; margin-right: 6px;">lightbulb</mat-icon>
            {{'interval_global_settings_info' | translate}}
          </div>

          <!-- Configuraci├│n de descuentos globales por m├║ltiples fechas (solo para cursos flexibles) -->
          <div *ngIf="courses.courseFormGroup.controls['is_flexible'].value" style="margin-top: 16px; padding: 16px; background-color: white; border: 1px solid #dee2e6; border-radius: 6px;">
            <h5 style="color: #495057; font-size: 15px; font-weight: 600; margin-bottom: 12px;">
              <mat-icon style="vertical-align: middle; margin-right: 8px; color: #6c757d; font-size: 18px;">local_offer</mat-icon>
              {{ 'multidate_discount' | translate }}
            </h5>

            <mat-checkbox [(ngModel)]="enableMultiDateDiscounts" (change)="onMultiDateDiscountChange()" style="margin-bottom: 12px;">
              <span style="font-weight: 500; color: #495057;">
                {{ 'enable_multidate_discounts' | translate }}
              </span>
            </mat-checkbox>

            <div *ngIf="enableMultiDateDiscounts" style="margin-top: 16px;">
              <div class="alert alert-info" style="background-color: #d1ecf1; border: 1px solid #bee5eb; color: #0c5460; padding: 10px; border-radius: 6px; font-size: 12px; margin-bottom: 12px;">
                <mat-icon style="font-size: 14px; vertical-align: middle; margin-right: 4px;">info</mat-icon>
                {{ 'multidate_discount_explanation' | translate }}
              </div>

              <!-- Lista de descuentos por n├║mero de fechas -->
              <div *ngFor="let discount of discountsByDates; let i = index" class="discount-item" style="display: flex; align-items: center; gap: 12px; margin-bottom: 10px; padding: 10px; background-color: #f8f9fa; border: 1px solid #dee2e6; border-radius: 4px;">
                <div style="min-width: 100px;">
                  <label style="font-size: 12px; color: #495057; margin-bottom: 4px; display: block;">
                    {{ 'dates_quantity' | translate }}
                  </label>
                  <input type="number"
                         [(ngModel)]="discount.dates"
                         min="2"
                         max="20"
                         style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;"
                         (change)="validateDiscountDates()">
                </div>

                <div style="min-width: 90px;">
                  <label style="font-size: 12px; color: #495057; margin-bottom: 4px; display: block;">
                    {{ 'discount_type' | translate }}
                  </label>
                  <select [(ngModel)]="discount.type"
                          style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                    <option value="percentage">{{ 'percentage' | translate }}</option>
                    <option value="fixed">{{ 'fixed_amount' | translate }}</option>
                  </select>
                </div>

                <div style="min-width: 100px;">
                  <label style="font-size: 12px; color: #495057; margin-bottom: 4px; display: block;">
                    {{ discount.type === 'percentage' ? ('percentage' | translate) : ('amount' | translate) }}
                  </label>
                  <input type="number"
                         [(ngModel)]="discount.value"
                         [min]="discount.type === 'percentage' ? 1 : 0.01"
                         [max]="discount.type === 'percentage' ? 100 : 9999"
                         step="0.01"
                         style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                </div>

                <button type="button"
                        *ngIf="discountsByDates.length > 1"
                        (click)="removeDiscount(i)"
                        style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 6px; cursor: pointer; min-width: 32px; height: 32px; margin-top: 18px;">
                  <mat-icon style="font-size: 16px;">delete</mat-icon>
                </button>
              </div>

              <!-- Bot├│n para agregar m├ís descuentos -->
              <button type="button"
                      (click)="addNewDiscount()"
                      style="border: 1px solid #007bff; color: #007bff; background: white; border-radius: 4px; height: 34px; padding: 0 14px; margin-top: 8px; font-size: 13px;">
                <mat-icon style="vertical-align: middle; margin-right: 4px; font-size: 16px;">add</mat-icon>
                {{ 'add_discount_by_date' | translate }}
              </button>
            </div>
          </div>

          <!-- Bot├│n para aplicar configuraci├│n global a todos los intervalos -->
          <div *ngIf="useMultipleIntervals && intervals && intervals.length > 1" style="margin-top: 12px;">
            <button mat-raised-button color="primary" (click)="applyGlobalConfigToAllIntervals()"
                    style="width: 100%;">
              <mat-icon style="margin-right: 8px;">sync</mat-icon>
              {{ 'apply_to_all_intervals' | translate }}
            </button>
          </div>
        </div>
        <!-- Contenedor de intervalos -->
        <div>
          <!-- Lista de intervalos -->
          <div *ngFor="let interval of displayIntervals; let i = index; trackBy: trackInterval">
            <div *ngIf="useMultipleIntervals"
              style="width: 100%; background-color: var(--color-grey4); height: 60px; border-top: 1px solid #C7D0D3; padding: 0 24px; align-content: space-evenly; display: flex; justify-content: space-between; align-items: center;">
              <span>
                {{('interval' | translate) + ' ' + (i + 1) }}
              </span>
              <div style="display: flex; align-items: center; gap: 10px;">
                <mat-icon *ngIf="useMultipleIntervals && intervals.length > 1"
                          (click)="removeIntervalUI(i)"
                          style="cursor: pointer; color: var(--color-dark1);">
                  delete
                </mat-icon>
              </div>

            </div>

            <!-- Rango de fechas del intervalo -->
            <div style="padding: 16px; background: #f8f9fa; border-top: 1px solid #DEE6EA;">
              <h6 style="margin: 0 0 12px 0; color: #495057; font-size: 14px; font-weight: 600;">
                {{ 'interval_date_range' | translate }}
              </h6>
              <div style="display: flex; gap: 16px; align-items: center;">
                <div style="flex: 1;">
                  <label style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 4px;">{{ 'start_date' | translate }}</label>
                  <input type="date"
                         [(ngModel)]="interval.startDate"
                         (ngModelChange)="onIntervalStartDateChange(i, $event)"
                         style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                </div>
                <div style="flex: 1;">
                  <label style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 4px;">{{ 'end_date' | translate }}</label>
                  <input type="date"
                         [(ngModel)]="interval.endDate"
                         [min]="interval.startDate"
                         (ngModelChange)="onIntervalEndDateChange(i, $event)"
                         style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 13px;">
                </div>
              </div>
            </div>

            <!-- Configuraci├│n espec├¡fica del intervalo (solo en modo independiente) -->
            <div *ngIf="useMultipleIntervals && courses.courseFormGroup.controls['intervals_config_mode'].value === 'independent'" style="padding: 16px; background: #fff3cd; border-top: 1px solid #DEE6EA; border-left: 4px solid #ffc107;">
              <h6 style="margin: 0 0 12px 0; color: #495057; font-size: 14px; font-weight: 600;">
                <mat-icon style="vertical-align: middle; margin-right: 4px; color: #ffc107;">tune</mat-icon>
                {{ 'interval_specific_config' | translate }}
              </h6>

              <!-- Fechas reservables espec├¡ficas para este intervalo -->
              <div style="margin-bottom: 16px;">
                <label style="display: block; font-size: 12px; color: #6c757d; margin-bottom: 8px; font-weight: 500;">
                  {{ 'interval_bookable_dates' | translate }}
                </label>
                <div style="display: flex; gap: 12px;">
                  <div style="flex: 1;">
                    <label style="display: block; font-size: 11px; color: #6c757d; margin-bottom: 4px;">{{ 'bookable_from' | translate }}</label>
                    <input type="date"
                           [(ngModel)]="interval.reservableStartDate"
                           [ngModelOptions]="{standalone: true}"
                           style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;">
                  </div>
                  <div style="flex: 1;">
                    <label style="display: block; font-size: 11px; color: #6c757d; margin-bottom: 4px;">{{ 'bookable_until' | translate }}</label>
                    <input type="date"
                           [(ngModel)]="interval.reservableEndDate"
                           [ngModelOptions]="{standalone: true}"
                           [min]="interval.reservableStartDate"
                           style="width: 100%; padding: 6px; border: 1px solid #ced4da; border-radius: 4px; font-size: 12px;">
                  </div>
                </div>
              </div>

              <!-- Opciones espec├¡ficas del intervalo -->
              <div style="display: flex; flex-direction: column; gap: 8px;">
                <mat-checkbox [(ngModel)]="interval.mustBeConsecutive" [ngModelOptions]="{standalone: true}"
                              (change)="handleIntervalDateRangeChange(i)">
                  <span style="font-size: 13px; font-weight: 500;">{{ 'dates_must_be_consecutive' | translate }}</span>
                </mat-checkbox>

                <mat-checkbox [(ngModel)]="interval.mustStartFromFirst" [ngModelOptions]="{standalone: true}">
                  <span style="font-size: 13px; font-weight: 500;">{{ 'must_start_from_first_day' | translate }}</span>
                </mat-checkbox>
              </div>

              <div style="margin-top: 8px; padding: 8px; background: #fff; border-radius: 4px; font-size: 11px; color: #6c757d;">
                <mat-icon style="font-size: 14px; vertical-align: middle; margin-right: 4px;">info</mat-icon>
                {{ 'interval_config_overrides_global' | translate }}
              </div>
            </div>

            <!-- Configuraci├│n de generaci├│n de fechas por intervalo -->
            <div style="padding: 16px; border-top: 1px solid #DEE6EA;">
              <h6 style="margin: 0 0 12px 0; color: #495057; font-size: 14px; font-weight: 600;">
                {{ 'date_generation_method' | translate }}
              </h6>

              <!-- Tarjetas de selecci├│n de m├®todo -->
              <div style="display: flex; gap: 12px; margin-bottom: 16px; flex-wrap: wrap;">
                <!-- D├¡as consecutivos -->
                <div class="date-method-card"
                     [class.selected]="interval.dateGenerationMethod === 'consecutive'"
                     (click)="setIntervalDateGenerationMethod(i, 'consecutive')"
                     style="flex: 1; min-width: 140px; padding: 12px; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer; background: white; text-align: center;">
                  <mat-icon style="color: #007bff; margin-bottom: 4px;">date_range</mat-icon>
                  <div style="font-size: 12px; font-weight: 500; color: #495057;">{{ 'consecutive_days' | translate }}</div>
                </div>

                <!-- D├¡as de la semana -->
                <div class="date-method-card"
                     [class.selected]="interval.dateGenerationMethod === 'weekly'"
                     (click)="setIntervalDateGenerationMethod(i, 'weekly')"
                     style="flex: 1; min-width: 140px; padding: 12px; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer; background: white; text-align: center;">
                  <mat-icon style="color: #28a745; margin-bottom: 4px;">event_repeat</mat-icon>
                  <div style="font-size: 12px; font-weight: 500; color: #495057;">{{ 'weekly_pattern' | translate }}</div>
                </div>

                <!-- Manual -->
                <div class="date-method-card"
                     [class.selected]="interval.dateGenerationMethod === 'manual'"
                     (click)="setIntervalDateGenerationMethod(i, 'manual')"
                     style="flex: 1; min-width: 140px; padding: 12px; border: 1px solid #dee2e6; border-radius: 6px; cursor: pointer; background: white; text-align: center;">
                  <mat-icon style="color: #ffc107; margin-bottom: 4px;">edit_calendar</mat-icon>
                  <div style="font-size: 12px; font-weight: 500; color: #495057;">{{ 'manual_selection' | translate }}</div>
                </div>
              </div>

              <!-- Configuraci├│n espec├¡fica para d├¡as consecutivos -->
              <div *ngIf="interval.dateGenerationMethod === 'consecutive'" style="display: flex; align-items: center; gap: 12px; padding: 12px; background: #f8f9fa; border-radius: 4px;">
                <label style="color: #495057; font-size: 13px;">{{ 'consecutive_count' | translate }}:</label>
                <input type="number"
                       [(ngModel)]="interval.consecutiveDaysCount"
                       min="2"
                       max="20"
                       style="width: 60px; padding: 6px; border: 1px solid #ced4da; border-radius: 3px; font-size: 12px;">
                <button type="button"
                        (click)="generateIntervalConsecutiveDates(i)"
                        style="background: #007bff; color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                  {{ 'generate_dates' | translate }}
                </button>
              </div>

              <!-- Configuraci├│n espec├¡fica para d├¡as de la semana -->
              <div *ngIf="interval.dateGenerationMethod === 'weekly'" style="padding: 12px; background: #f8f9fa; border-radius: 4px;">
                <div style="display: flex; gap: 6px; margin-bottom: 12px; flex-wrap: wrap;">
                  <button type="button"
                          *ngFor="let day of ['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday']"
                          [class.active]="interval.weeklyPattern?.[day]"
                          (click)="toggleIntervalWeekday(i, day)"
                          style="padding: 6px 10px; border: 1px solid #ced4da; border-radius: 15px; cursor: pointer; font-size: 11px; background: white; color: #495057;">
                    {{ day.substring(0, 3) | translate | titlecase }}
                  </button>
                </div>
                <button type="button"
                        (click)="generateIntervalWeeklyDates(i)"
                        [disabled]="!hasSelectedWeekdaysForInterval(i)"
                        style="background: #28a745; color: white; border: none; padding: 6px 12px; border-radius: 3px; cursor: pointer; font-size: 12px;">
                  {{ 'generate_dates' | translate }}
                </button>
              </div>
            </div>

            <!-- Fechas del intervalo -->
            <div *ngFor="let date of interval?.dates; let j = index">
              <div
                style="width: 100%; background-color: var(--color-grey4); height: 40px; border-top: 1px solid #DEE6EA;
                padding: 0 24px; display: flex; align-items: center;">
                  <span style="font-size: 13px; color: var(--color-dark1);">
                    {{('date' | translate) + ' ' + (j + 1)}}
                  </span>
                <mat-icon *ngIf="interval?.dates.length > 1"
                          (click)="removeCourseDateFromInterval(i, j)"
                          style="cursor: pointer; margin-left: auto; font-size: 20px; color: var(--color-dark1);">
                  delete
                </mat-icon>
              </div>
              <div style="padding: 20px 20px 0px; display: flex; flex-wrap: nowrap; column-gap: 20px;">
                <app-form-datepicker [required]="true"
                                     [min]="interval.startDate"
                                     [max]="interval.endDate"
                                     [value]="date.date"
                                     (do)="validateAndUpdateIntervalDate(i, j, $event.value)"
                                     style="min-width: 0;width: 100%;" name="date">
                </app-form-datepicker>
                <app-form-select [value]="date.hour_start"
                                 [required]="true" [table]="courses.hours"
                                 (do)="validateAndUpdateIntervalHour(i, j, $event.option.value)"
                                 style="min-width: 0;width: 100%;" label="start_hour">
                </app-form-select>
                <app-form-select [value]="date.duration"
                                 [required]="true" [table]="courses.duration"
                                 (do)="validateAndUpdateIntervalDuration(i, j, $event.option.value)"
                                 style="min-width: 0;width: 100%;" label="duration">
                </app-form-select>
              </div>

            </div>
            <!-- Bot├│n para a├▒adir fecha -->
            <div style="margin: 20px; display: flex; justify-content: flex-end;">
              <button (click)="addCourseDateToInterval(i)"
                      style="border: 1px solid var(--is-light-theme, #222222) var(--is-dark-theme, #ffffff); border-radius: 3px; height: 38px; padding: 0 16px;"
                      type="button">
                {{'add_date' | translate}}
              </button>
            </div>

            <!-- Aplicar horario al intervalo (solo si hay al menos 2 fechas) -->
            <div *ngIf="interval?.dates && interval?.dates?.length >= 2"
                 style="margin: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">

              <div style="display: flex; align-items: center; margin-bottom: 16px;">
                <mat-icon style="color: #007bff; margin-right: 8px; font-size: 20px;">schedule</mat-icon>
                <h4 style="margin: 0; color: #495057; font-size: 16px; font-weight: 600;">
                  {{'apply_schedule_interval' | translate}}
                </h4>
              </div>

              <div style="display: flex; gap: 12px; align-items: end; flex-wrap: wrap;">
                <div style="flex: 1; min-width: 120px;">
                  <app-form-select
                    [value]="getIntervalScheduleStartTime(i)"
                    [table]="courses.hours"
                    (do)="setIntervalScheduleStartTime(i, $event.option.value)"
                    style="width: 100%;"
                    label="{{'start_hour' | translate}}"
                    [required]="false">
                  </app-form-select>
                </div>

                <div style="flex: 1; min-width: 120px;">
                  <app-form-select
                    [value]="getIntervalScheduleDuration(i)"
                    [table]="courses.duration"
                    (do)="setIntervalScheduleDuration(i, $event.option.value)"
                    style="width: 100%;"
                    label="{{'duration' | translate}}"
                    [required]="false">
                  </app-form-select>
                </div>

                <div style="flex: 0 0 auto;">
                  <button (click)="applyBulkScheduleToIntervalInline(i)"
                          style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; border-radius: 6px; height: 40px; padding: 0 20px; font-weight: 500; box-shadow: 0 2px 4px rgba(0,123,255,0.3); transition: all 0.2s ease;"
                          type="button"
                          [disabled]="!getIntervalScheduleStartTime(i) || !getIntervalScheduleDuration(i)"
                          onmouseover="this.style.transform='translateY(-1px)'; this.style.boxShadow='0 4px 8px rgba(0,123,255,0.4)'"
                          onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(0,123,255,0.3)'">
                    <mat-icon style="vertical-align: middle; margin-right: 6px; font-size: 16px;">schedule</mat-icon>
                    {{'apply' | translate}}
                  </button>
                </div>
              </div>

              <div style="margin-top: 12px; font-size: 13px; color: #6c757d; display: flex; align-items: center;">
                <mat-icon style="font-size: 14px; margin-right: 4px; color: #6c757d;">info</mat-icon>
                {{'schedule_will_apply_to_dates' | translate}}: {{interval?.dates?.length}} {{'dates' | translate}}
              </div>
            </div>

            <!-- Configuración de descuentos por intervalo (solo si hay múltiples intervalos) -->
            <div *ngIf="useMultipleIntervals && courses.courseFormGroup.controls['is_flexible'].value"
                 style="margin: 20px; padding: 20px; background-color: #fff8e1; border: 1px solid #ffe082; border-radius: 8px;">

              <!-- Toggle para habilitar descuentos -->
              <div style="margin-bottom: 16px;">
                <mat-checkbox [(ngModel)]="enableIntervalDiscounts"
                              (change)="onIntervalDiscountChange()"
                              style="margin-bottom: 8px;">
                  <span style="font-weight: 600; color: #f57c00; font-size: 15px;">
                    {{ 'enable_interval_discounts' | translate }}
                  </span>
                </mat-checkbox>
                <div style="margin-left: 28px; font-size: 12px; color: #6c757d;">
                  <mat-icon style="font-size: 14px; vertical-align: middle; margin-right: 4px;">info</mat-icon>
                  {{ 'interval_discount_explanation' | translate }}
                </div>
              </div>

              <!-- Sección de descuentos (solo si está habilitado) -->
              <div *ngIf="enableIntervalDiscounts">
                <h4 class="mb-3" style="color: #f57c00; font-size: 14px; font-weight: 600; margin-bottom: 12px; margin-top: 16px;">
                  <mat-icon style="vertical-align: middle; margin-right: 8px; color: #f57c00; font-size: 18px;">sell</mat-icon>
                  {{ 'interval_discounts_config' | translate }}
                </h4>

              <!-- Lista de descuentos para este intervalo -->
              <div *ngFor="let discount of interval.discounts || []; let discIdx = index"
                   class="discount-item"
                   style="display: flex; align-items: center; gap: 16px; margin-bottom: 12px; padding: 12px; background-color: white; border: 1px solid #dee2e6; border-radius: 6px;">
                <div style="min-width: 120px;">
                  <label style="font-size: 14px; color: #495057; margin-bottom: 4px; display: block;">
                    {{ 'dates_quantity' | translate }}
                  </label>
                  <input type="number"
                         [(ngModel)]="discount.dates"
                         min="2"
                         max="20"
                         style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;"
                         (change)="validateIntervalDiscounts(i)">
                </div>

                <div style="min-width: 100px;">
                  <label style="font-size: 14px; color: #495057; margin-bottom: 4px; display: block;">
                    {{ 'discount_type' | translate }}
                  </label>
                  <select [(ngModel)]="discount.type"
                          (ngModelChange)="validateIntervalDiscounts(i)"
                          style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                    <option value="percentage">{{ 'percentage' | translate }}</option>
                    <option value="fixed">{{ 'fixed_amount' | translate }}</option>
                  </select>
                </div>

                <div style="min-width: 120px;">
                  <label style="font-size: 14px; color: #495057; margin-bottom: 4px; display: block;">
                    {{ discount.type === 'percentage' ? ('percentage' | translate) : ('amount' | translate) }}
                  </label>
                  <input type="number"
                         [(ngModel)]="discount.value"
                         (ngModelChange)="validateIntervalDiscounts(i)"
                         [min]="discount.type === 'percentage' ? 1 : 0.01"
                         [max]="discount.type === 'percentage' ? 100 : 9999"
                         step="0.01"
                         style="width: 100%; padding: 8px; border: 1px solid #ced4da; border-radius: 4px; font-size: 14px;">
                </div>

                <button type="button"
                        *ngIf="(interval.discounts || []).length > 1"
                        (click)="removeIntervalDiscount(i, discIdx)"
                        style="background: #dc3545; color: white; border: none; border-radius: 4px; padding: 8px; cursor: pointer; min-width: 36px; height: 36px;">
                  <mat-icon style="font-size: 18px;">delete</mat-icon>
                </button>
              </div>

                <!-- Bot├│n para agregar descuento al intervalo -->
                <button type="button"
                        (click)="addIntervalDiscount(i)"
                        style="border: 1px solid #f57c00; color: #f57c00; background: transparent; border-radius: 4px; height: 38px; padding: 0 16px; margin-top: 8px;">
                  <mat-icon style="vertical-align: middle; margin-right: 5px; font-size: 18px;">add</mat-icon>
                  {{ 'add_interval_discount' | translate }}
                </button>
              </div>
              <!-- Fin sección descuentos habilitados -->
            </div>
            <!-- Fin configuración descuentos intervalo -->
          </div>

          <!-- Bot├│n para a├▒adir nuevo intervalo (solo en modo m├║ltiple) -->
          <div *ngIf="useMultipleIntervals" style="padding: 20px; border-top: 1px solid #DEE6EA;">
            <button (click)="addIntervalUI(intervals.length)"
                    style="border: 1px solid #E91E63; color: #E91E63; background: transparent; border-radius: 3px; height: 38px; padding: 0 20px; margin-right: 10px;"
                    type="button">
              <mat-icon style="vertical-align: middle; margin-right: 5px;">add</mat-icon>
              {{'add_new_interval' | translate}}
            </button>

          </div>
        </div>

        <!-- Secci├│n unificada de niveles y subgrupos (OCULTA - No debe aparecer en la pestaña Fechas) -->
        <div *ngIf="false" style="background: white; border: 1px solid #DEE6EA; border-radius: 8px; margin-bottom: 20px;">
          <div style="padding: 20px; background: #f8f9fa; border-bottom: 1px solid #DEE6EA;">
            <h6 style="margin: 0; color: #495057; font-size: 14px; font-weight: 600;">
              <mat-icon style="vertical-align: middle; margin-right: 4px; color: #9C27B0;">groups</mat-icon>
              {{ 'levels_and_subgroups' | translate }}
            </h6>
          </div>

          <div style="padding: 20px;">
            <ng-container *ngFor="let level of (courses.courseFormGroup.controls['levelGrop'].value || []); index as levelIdx; trackBy: trackLevel">
              <ng-container *ngIf="level.active">
                <!-- Header del nivel -->
                <div style="display: flex; gap: 16px; align-items: center; margin-bottom: 16px;">
                  <div [style.backgroundColor]="level.color"
                       [style.border]="'1px solid '+level.color"
                       style="height: 46px; border-radius: 3px; min-width: 225px;font-size: 12px;align-content: space-evenly; display: flex; align-items: center; justify-content: center; color: white; font-weight: 500;">
                    {{level.annotation}} {{level.level}}
                  </div>
                </div>

                <!-- Subgrupos del nivel -->
                <ng-container *ngIf="getAllUniqueSubgroupsForLevel(level).length > 0">
                  <ng-container *ngFor="let uniqueSubgroup of getAllUniqueSubgroupsForLevel(level); index as j; trackBy: trackSubgroup">
                    <!-- Header del subgrupo -->
                    <div style="background-color: var(--color-grey4); display: flex;width: 100%; height: 46px;justify-content: space-between;align-items: center; border-radius: 4px;padding: 10px; margin-bottom: 10px;gap: 10px;">
                      <span style="flex: 0 0 auto;">{{level.annotation}} {{level.level}} {{("00"+(uniqueSubgroup._index+1)).slice(-2)}}</span>
                      <app-form-input
                        [required]="true"
                        [value]="uniqueSubgroup.max_participants || level.max_participants"
                        (do)="updateSubgroupMaxParticipants(level, uniqueSubgroup._index, $event.target.value);"
                        name="max_pax"
                        style="width: 120px; flex: 0 0 auto;"
                        type="number"
                        Suffix="paxes">
                      </app-form-input>
                    </div>

                    <!-- Tabs de intervalos (solo si hay múltiples intervalos para este subgrupo) -->
                    <!-- OPTIMIZATION: Only render content of active tab to avoid rendering all 12 flux-disponibilidad components -->
                    <mat-tab-group *ngIf="getSubgroupIntervals(level, uniqueSubgroup._index).length > 1"
                                   [selectedIndex]="getSelectedIntervalIndexForSubgroup(level, uniqueSubgroup._index)"
                                   (selectedIndexChange)="setSelectedIntervalIndexForSubgroup(level, uniqueSubgroup._index, $event)"
                                   style="margin-bottom: 20px;">
                      <mat-tab *ngFor="let interval of getSubgroupIntervals(level, uniqueSubgroup._index); let intervalIdx = index; trackBy: trackInterval"
                               [label]="interval.name || ('Intervalo ' + (intervalIdx + 1))">
                        <!-- Lazy load tab content: only render flux-disponibilidad when this tab is active -->
                        <ng-container *ngIf="getSelectedIntervalIndexForSubgroup(level, uniqueSubgroup._index) === intervalIdx">
                          <vex-flux-disponibilidad
                            [courseFormGroup]="courses.courseFormGroup"
                            [level]="level"
                            [group]="getGroupForLevel(level)"
                            [subgroup_index]="uniqueSubgroup._index"
                            [interval_id]="interval.id"
                            (monitorSelect)="monitorSelect($event,level,uniqueSubgroup._index)"
                            (viewTimes)="openTimingModal($event.subGroup, $event.groupLevel, $event.selectedDate)">
                          </vex-flux-disponibilidad>
                        </ng-container>
                      </mat-tab>
                    </mat-tab-group>

                    <!-- Si solo hay un intervalo o ninguno para este subgrupo, mostrar directo -->
                    <vex-flux-disponibilidad
                      *ngIf="getSubgroupIntervals(level, uniqueSubgroup._index).length <= 1"
                      [courseFormGroup]="courses.courseFormGroup"
                      [level]="level"
                      [group]="getGroupForLevel(level)"
                      [subgroup_index]="uniqueSubgroup._index"
                      [interval_id]="getSubgroupIntervals(level, uniqueSubgroup._index)[0]?.id"
                      (monitorSelect)="monitorSelect($event,level,uniqueSubgroup._index)"
                      (viewTimes)="openTimingModal($event.subGroup, $event.groupLevel, $event.selectedDate)">
                    </vex-flux-disponibilidad>
                  </ng-container>
                </ng-container>

                <!-- Botón para añadir subgrupo (solo para cursos flex con intervalos configurables) -->
                <div *ngIf="canConfigureIntervalGroups" style="margin-bottom: 20px; margin-top: 10px;">
                  <button (click)="editModal=true;setEditFunction('addIntervalLevelSubgroup',selectedIntervalIndexForGroups,level)"
                          style="border: 1px solid #E91E63; color: #E91E63; background: transparent; border-radius: 3px; height: 38px; padding: 0 16px; cursor: pointer; display: flex; align-items: center; gap: 8px;"
                          type="button">
                    <mat-icon style="font-size: 18px; width: 18px; height: 18px;">add</mat-icon>
                    <span>{{'add_subgroup' | translate}}</span>
                  </button>
                </div>
              </ng-container>
            </ng-container>
          </div>
        </div>

        <ng-container *ngIf="!useMultipleIntervals && !isSingleIntervalMode && courses.courseFormGroup.controls['course_type'].value !== 1">
          <!-- Mantener el c├│digo existente para fechas individuales -->
          <div *ngFor="let item of courses.courseFormGroup.controls['course_dates'].value; index as i">
            <div
              style="width: 100%;background-color: var(--color-grey4);height: 60px;border-top: 1px solid #C7D0D3;padding: 0 24px;align-content: space-evenly;">
        <span>
          {{('date'| translate)+' '+(i+1)}}
        </span>
              <mat-icon *ngIf="courses.courseFormGroup.controls['course_dates'].value.length !== 1"
                        (click)="mode==='create'?deleteCourseDate(i):editModal=true;setEditFunction('deleteCourseDate',i)"
                        style="cursor: pointer;float: inline-end;">
                delete
              </mat-icon>
            </div>
            <div style="padding: 20px 20px 0px; display: flex; flex-wrap: nowrap; column-gap: 20px;">
              <app-form-datepicker [required]="true"
                                   [min]="courses.courseFormGroup.controls['date_start'].value"
                                   [value]="courses.courseFormGroup.controls['course_dates'].value[i].date"
                                   (do)="validateAndUpdateMainDate(i, $event.value)"
                                   style="min-width: 0;width: 100%;" name="date">
              </app-form-datepicker>
              <app-form-select [value]="courses.courseFormGroup.controls['course_dates'].value[i]?.hour_start"
                               [required]="true" [table]="courses.hours"
                               (do)="validateAndUpdateMainHour(i, $event.option.value, 'hour_start')"
                               style="min-width: 0;width: 100%;" label="start_hour">
              </app-form-select>
              <!-- Para cursos privados (course_type > 1), mostrar hour_end en lugar de duration -->
              <app-form-select *ngIf="courses.courseFormGroup.controls['course_type'].value > 1"
                               [value]="courses.courseFormGroup.controls['course_dates'].value[i]?.hour_end"
                               [required]="true"
                               [table]="courses.filterAvailableHours(courses.courseFormGroup.controls['course_dates'].value[i]?.hour_start, courses.courseFormGroup.controls['duration']?.value)"
                               (do)="validateAndUpdateMainHour(i, $event.option.value, 'hour_end')"
                               style="min-width: 0;width: 100%;"
                               label="end_hour">
              </app-form-select>
              <!-- Para cursos colectivos (course_type === 1), mostrar duration -->
              <app-form-select *ngIf="courses.courseFormGroup.controls['course_type'].value === 1"
                               [value]="courses.courseFormGroup.controls['course_dates'].value[i]?.duration"
                               [required]="true" [table]="courses.duration"
                               (do)="validateAndUpdateMainDuration(i, $event.option.value)"
                               style="min-width: 0;width: 100%;" label="duration">
              </app-form-select>
            </div>
          </div>
          <!-- Aplicar horario masivo a todas las fechas individuales (solo si hay al menos 2 fechas) -->
          <div *ngIf="courses.courseFormGroup.controls['course_dates'].value && courses.courseFormGroup.controls['course_dates'].value.length >= 2"
               style="margin: 20px; padding: 20px; background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%); border: 1px solid #dee2e6; border-radius: 8px; box-shadow: 0 2px 4px rgba(0,0,0,0.05);">

            <div style="display: flex; align-items: center; margin-bottom: 16px;">
              <mat-icon style="color: #007bff; margin-right: 8px; font-size: 20px;">schedule</mat-icon>
              <h4 style="margin: 0; color: #495057; font-size: 16px; font-weight: 600;">
                {{'apply_schedule_interval' | translate}}
              </h4>
            </div>

            <div style="display: flex; gap: 12px; align-items: end; flex-wrap: wrap;">
              <div style="flex: 1; min-width: 120px;">
                <app-form-select
                  [value]="getIndividualScheduleStartTime()"
                  [table]="courses.hours"
                  (do)="setIndividualScheduleStartTime($event.option.value)"
                  style="width: 100%;"
                  label="{{'start_hour' | translate}}"
                  [required]="false">
                </app-form-select>
              </div>

              <div style="flex: 1; min-width: 120px;">
                <app-form-select
                  [value]="getIndividualScheduleDuration()"
                  [table]="courses.duration"
                  (do)="setIndividualScheduleDuration($event.option.value)"
                  style="width: 100%;"
                  label="{{'duration' | translate}}"
                  [required]="false">
                </app-form-select>
              </div>

              <div style="flex: 0 0 auto;">
                <button (click)="applyBulkScheduleToIndividualDates()"
                        style="background: linear-gradient(135deg, #007bff 0%, #0056b3 100%); color: white; border: none; border-radius: 6px; height: 40px; padding: 0 20px; font-weight: 500; box-shadow: 0 2px 4px rgba(0,123,255,0.3); transition: all 0.2s ease;"
                        type="button"
                        [disabled]="!getIndividualScheduleStartTime() || !getIndividualScheduleDuration()">
                  <mat-icon style="vertical-align: middle; margin-right: 6px; font-size: 16px;">schedule</mat-icon>
                  {{'apply' | translate}}
                </button>
              </div>
            </div>

            <div style="margin-top: 12px; font-size: 13px; color: #6c757d; display: flex; align-items: center;">
              <mat-icon style="font-size: 14px; margin-right: 4px; color: #6c757d;">info</mat-icon>
              {{'schedule_will_apply_to_dates' | translate}}: {{courses.courseFormGroup.controls['course_dates'].value.length}} {{'dates' | translate}}
            </div>
          </div>
        </ng-container>
      </ng-container>

      <ng-container *ngIf="courses.courseFormGroup.controls['course_type'].value>1">
        <mat-tab-group [selectedIndex]="PeriodoFecha || (courses.courseFormGroup.controls['settings'].value.periods.length>1?1:0)"
                       (selectedIndexChange)="onPeriodChange($event)"
                       style="margin: 20px 20px 0;">
          <mat-tab>
            <ng-template mat-tab-label>
              {{"courses.uniperiod" | translate}}
            </ng-template>
          </mat-tab>
          <mat-tab>
            <ng-template mat-tab-label>
              {{"courses.multiperiod" | translate}}
            </ng-template>
          </mat-tab>
        </mat-tab-group>

        <div style=" display: flex; flex-direction: column;padding: 10px;">
          <ng-container
            *ngFor="let item of courses.courseFormGroup.controls['course_dates'].value;index as i">
            <div *ngIf="PeriodoFecha>0"
                 style="width: 100%;background-color: var(--color-grey4);height: 60px;border-top: 1px solid #C7D0D3;padding: 0 24px;align-content: space-evenly;">
							<span>
								{{('date'| translate)+' '+(i+1)}}
							</span>
              <mat-icon *ngIf="courses.courseFormGroup.controls['course_dates'].value.length !== 1"
                        (click)="deleteCourseDate(i);setEditFunction('deleteCourseDate',i)"
                        style="cursor: pointer;float: inline-end;">
                delete
              </mat-icon>
            </div>
            <div *ngIf="courses.courseFormGroup.controls['course_type'].value > 1 || PeriodoFecha>0 || i===0 || courses.courseFormGroup.controls['course_dates'].value.length>1" style="display: flex;column-gap: 20px;">
              <app-form-datepicker [required]="true" [min]="mode==='create'?nowDate:detailData.date_start"
                                   [value]="courses.courseFormGroup.controls['course_dates'].value[i].date"
                                   (do)="validateAndUpdateMainDate(i, $event.value);
								courses.courseFormGroup.controls['course_dates'].value[i].date_end<$event.value?courses.courseFormGroup.controls['course_dates'].value[i].date_end=$event.value:null"
                                   style="min-width: 0;width: 100%;" name="courses.date_start">
              </app-form-datepicker>
              <app-form-datepicker [required]="true"
                                   [value]="courses.courseFormGroup.controls['course_dates'].value[i].date_end"
                                   [min]="courses.courseFormGroup.controls['course_dates'].value[i].date"
                                   (do)="courses.courseFormGroup.controls['course_dates'].value[i].date_end=$event.value;"
                                   style="min-width: 0;width: 100%;" name="courses.date_end">
              </app-form-datepicker>
            </div>
            <div style="display: flex;column-gap: 20px;">
              <app-form-select
                [value]="courses.courseFormGroup.controls['course_dates'].value[i]?.hour_start"
                [required]="true" [table]="courses.hours"
                (do)="courses.courseFormGroup.controls['course_dates'].value[i].hour_start=$event.option.value"
                style="min-width: 0;width: 100%;" label="start_hour">
              </app-form-select>
              <!--              <app-form-select
                              [value]="courses.courseFormGroup.controls['course_dates'].value[i].duration"
                              [required]="true" [table]="courses.duration"
                              (do)="courses.courseFormGroup.controls['course_dates'].value[i].duration=$event.option.value;
                            courses.courseFormGroup.controls['course_dates'].value[i].hour_end=courses.addMinutesToTime(item.hour_start, $event.option.value)"
                              style="min-width: 0;width: 100%;" label="duration">
                            </app-form-select>-->
              <app-form-select [value]="courses.courseFormGroup.controls['course_dates'].value[i].hour_end"
                               [required]="true"
                               [table]="courses.filterAvailableHours(courses.courseFormGroup.controls['course_dates'].value[i].hour_start, courses.courseFormGroup.controls['duration'].value)"
                               (do)="courses.courseFormGroup.controls['course_dates'].value[i].hour_end=$event.option.value"
                               style="min-width: 0;width: 100%;"
                               label="end_hour">
              </app-form-select>
            </div>
            <div *ngIf="courses.courseFormGroup.controls['course_type'].value>1"
                 style="display: flex; flex-wrap: wrap;gap: 16px;margin: 20px 0;">
              <mat-checkbox
                (change)="setCourseDateAllWeekdays(i, $event.checked)"
                [checked]="areAllWeekdaysSelected(i)"
                style="width: calc(25% - 16px);">
                {{"full_day" | translate}}
              </mat-checkbox>
              <mat-checkbox
                *ngFor="let item of courses.weekSelect"
                [checked]="getCourseDateWeekDays(i)[item]"
                (change)="toggleCourseDateWeekday(i, item, $event.checked)"
                style="width: calc(25% - 16px); text-transform: capitalize;">
                {{item | translate}}
              </mat-checkbox>
            </div>
          </ng-container>
          <div *ngIf="PeriodoFecha>0">
            <button
              (click)="addCourseDate();setEditFunction('addCourseDate')"
              style="margin-top: 0px !important;height: 38px; width: 200px;" mat-button type="button">
              <mat-icon>add</mat-icon>
              {{'add_date' | translate }}
            </button>
          </div>
        </div>
      </ng-container>
    </div>
    <div *ngIf="ModalFlux===3" class="flex flex-col">
      <ng-container *ngIf="courses.courseFormGroup.controls['course_type'].value===1">
        <div class="level"
             style="width: 100%; height: 100%; padding: 10px; background: #D2EFFF; border-radius: 8px; justify-content: flex-start; align-items: center; gap: 8px; display: inline-flex">
          <mat-icon style="color: #006fcb;" class="icon24">
            info
          </mat-icon>
          <div *ngIf="courses.courseFormGroup.controls['levelGrop'].value">
						<span *ngIf="mode==='update'"
                  style="flex: 1 1 0; font-size: 14px; font-weight: 400; line-height: 18px; word-wrap: break-word;color: black;">
							{{"edit_level_here" | translate}}
						</span>
            <span *ngIf="mode==='create'"
                  style="flex: 1 1 0; font-size: 14px; font-weight: 400; line-height: 18px; word-wrap: break-word;color: black;">
							{{"choose_level_pop" | translate}}
						</span>
            <span *ngIf="!find(courses.courseFormGroup.controls['levelGrop'].value,'active',true)"
                  style="flex: 1 1 0; font-size: 14px; font-weight: 700; line-height: 18px; word-wrap: break-word;color: red;">
							{{"choose_atlest_level" | translate}}!
						</span>
          </div>
        </div>

        <!-- Toggle para configurar niveles por intervalo (solo si hay múltiples intervalos) -->
        <div *ngIf="useMultipleIntervals && intervals && intervals.length > 1 && mode==='create'"
             style="padding: 16px 20px; background: white; border-radius: 8px; margin-top: 16px;">
          <mat-checkbox [(ngModel)]="configureLevelsByInterval"
                        (change)="onConfigureLevelsByIntervalChange()"
                        color="primary">
            <span style="font-size: 14px; font-weight: 500;">
              {{'configure_levels_by_interval' | translate}}
            </span>
          </mat-checkbox>
          <p style="font-size: 12px; color: #666; margin: 8px 0 0 32px;">
            {{'configure_levels_by_interval_description' | translate}}
          </p>
        </div>

        <!-- Vista por intervalos (cuando está activado el flag) -->
        <!-- Ocultar en modo UPDATE: usar vista unificada en su lugar -->
        <div *ngIf="configureLevelsByInterval && useMultipleIntervals && intervals && intervals.length > 1 && mode==='create'"
             style="margin-top: 16px;">

          <!-- Botón para agregar grupo en modo por intervalos -->
          <div style="margin-bottom: 16px;">
            <button mat-raised-button color="primary" (click)="openAddGroupDialog()">
              <mat-icon>add</mat-icon>
              Agregar Grupo
            </button>
          </div>

          <mat-accordion>
            <mat-expansion-panel *ngFor="let interval of intervals; let intervalIdx = index"
                                 [expanded]="intervalIdx === 0">
              <mat-expansion-panel-header>
                <mat-panel-title style="font-weight: 600;">
                  {{getIntervalLabel(interval, intervalIdx)}}
                </mat-panel-title>
                <mat-panel-description>
                  {{interval.dates?.length || 0}} {{'dates' | translate}}
                </mat-panel-description>
              </mat-expansion-panel-header>

              <!-- Botón para copiar configuración de este intervalo a todos -->
              <div style="margin-bottom: 16px; text-align: right;">
                <button mat-flat-button color="primary"
                        (click)="copyIntervalConfigToAll(intervalIdx)">
                  <mat-icon>content_copy</mat-icon>
                  {{'copy_to_all_intervals' | translate}}
                </button>
              </div>

              <!-- Lista de niveles para este intervalo - EXACTAMENTE IGUAL A LA VISTA SIN INTERVALOS -->
              <div class="level" style="display: flex;flex-direction: column;padding: 10px; border-radius: 8px; gap: 10px;">
                <ng-container *ngFor="let level of (courses.courseFormGroup.controls['levelGrop'].value || []);index as i; trackBy: trackLevel">
                  <div style="display: flex;gap: 16px;align-items: center;">
                    <mat-checkbox [style.backgroundColor]="isLevelActiveForInterval(intervalIdx, level)?level.color:level.color+'33'"
                                  [style.color]="level.color"
                                  [style.border]="'1px solid '+level.color"
                                  [checked]="isLevelActiveForInterval(intervalIdx, level)"
                                  (change)="onIntervalLevelToggle(intervalIdx, level, $event.checked)"
                                  style="height: 46px; border-radius: 3px; min-width: 225px;font-size: 12px;align-content: space-evenly;">
                      {{level.annotation}} {{level.level}}
                    </mat-checkbox>
                  </div>

                  <div *ngIf="isLevelActiveForInterval(intervalIdx, level)" style="display: flex;gap: 16px;">
                    <app-form-input [required]="true" [value]="level.age_min" [max]="level.age_max"
                                    (do)="level.age_min=$event.target.value;" style="width: calc(33.33% - 10px - 16px);"
                                    name="min_age" type="number" Suffix="years">
                    </app-form-input>
                    <app-form-input [required]="true" [value]="level.age_max" [min]="level.age_min"
                                    (do)="level.age_max=$event.target.value;" name="max_age"
                                    style="width: calc(33.33% - 10px - 16px);" type="number" Suffix="years">
                    </app-form-input>
                    <mat-icon (click)="addIntervalLevelSubgroup(intervalIdx, level)" color="primary" style="color: white;
                              height: 30px;
                              min-width: 30px;
                              border-radius: 15px;
                              cursor: pointer;
                              font-size: 30px;
                              margin: auto 0;
                              align-content: space-evenly;
                              background-color: #E91E63;">
                      add
                    </mat-icon>
                  </div>

                  <!-- Subgrupos del nivel en este intervalo -->
                  <ng-container *ngIf="isLevelActiveForInterval(intervalIdx, level) && getIntervalLevelSubgroups(intervalIdx, level).length > 0">
                    <div *ngFor="let subgroup of getIntervalLevelSubgroups(intervalIdx, level); index as j; trackBy: trackIntervalSubgroup"
                         style="background-color: var(--color-grey4); display: flex;width: 100%; height: 46px;justify-content: space-between;align-items: center; border-radius: 4px;padding: 10px;">
                      {{level.annotation}} {{level.level}} {{("00"+(j+1)).slice(-2)}}
                      <img *ngIf="j > 0" (click)="removeIntervalLevelSubgroup(intervalIdx, level, j)"
                           src="assets/icons/icon/delete.png" alt class="icon20"
                           style="cursor: pointer; font-size: 20px;align-content: space-evenly;">
                    </div>
                  </ng-container>
                </ng-container>
              </div>
            </mat-expansion-panel>
          </mat-accordion>
        </div>

        <!-- Vista unificada para modo UPDATE con configureLevelsByInterval activo -->
        <div *ngIf="configureLevelsByInterval && useMultipleIntervals && mode==='update'"
             class="level"
             style="display: flex;flex-direction: column;padding: 20px; border-radius: 8px; gap: 10px;">

          <!-- Mostrar niveles ACTIVOS con sus detalles -->
          <ng-container *ngFor="let level of (courses.courseFormGroup.controls['levelGrop'].value || []);index as i; trackBy: trackLevel">
            <ng-container *ngIf="level.active">
              <!-- COLLAPSIBLE Level Header with Toggle Button -->
              <div style="display: flex; gap: 12px; align-items: center; margin-bottom: 10px;">
                <!-- Collapsible icon -->
                <mat-icon style="transition: transform 0.3s ease; transform: rotate({{ isLevelExpanded(level) ? '90' : '0' }})deg); cursor: pointer;"
                          (click)="toggleLevel(level)">
                  expand_more
                </mat-icon>

                <!-- Group name badge -->
                <div [style.backgroundColor]="level.color"
                     [style.border]="'1px solid '+level.color"
                     style="height: 46px; border-radius: 3px; min-width: 160px; font-size: 12px; display: flex; align-items: center; justify-content: center; color: white; font-weight: 500; cursor: pointer; padding: 0 10px;"
                     (click)="toggleLevel(level)">
                  {{level.annotation}} {{level.level}}
                </div>

                <!-- Editable fields for age and max participants -->
                <app-form-input
                  [required]="true"
                  [value]="level.age_min"
                  [max]="level.age_max"
                  (do)="level.age_min=$event.target.value;"
                  name="min_age"
                  style="width: 95px;"
                  type="number"
                  Suffix="años"
                  (click)="$event.stopPropagation()">
                </app-form-input>

                <app-form-input
                  [required]="true"
                  [value]="level.age_max"
                  [min]="level.age_min"
                  (do)="level.age_max=$event.target.value;"
                  name="max_age"
                  style="width: 95px;"
                  type="number"
                  Suffix="años"
                  (click)="$event.stopPropagation()">
                </app-form-input>

                <!-- Botones de agregar subgrupo y eliminar grupo -->
                <button mat-raised-button color="primary"
                        (click)="openIntervalSelectorForAddSubgroup(level);$event.stopPropagation()"
                        style="margin-left: auto; margin-right: 8px;">
                  <mat-icon>add</mat-icon>
                  Agregar Subgrupo
                </button>
                <button mat-raised-button color="warn"
                        (click)="deleteGroupWithIntervalSelector(level);$event.stopPropagation()">
                  <mat-icon>delete</mat-icon>
                  Eliminar Grupo
                </button>
              </div>

              <!-- Subgrupos del nivel (rendered only when level is expanded) -->
              <ng-container *ngIf="isLevelExpanded(level) && getAllUniqueSubgroupsForLevel(level).length > 0">
                <ng-container *ngFor="let uniqueSubgroup of getAllUniqueSubgroupsForLevel(level); index as j">
                  <!-- COLLAPSIBLE Subgroup Header with Toggle Button -->
                  <div style="background-color: var(--color-grey4); display: flex;width: 100%; height: 46px;justify-content: space-between;align-items: center; border-radius: 4px;padding: 10px; margin-bottom: 10px; cursor: pointer;"
                       (click)="toggleSubgroup(level, uniqueSubgroup._index)">
                    <div style="display: flex; align-items: center; gap: 8px; flex: 0 0 auto;">
                      <mat-icon style="transition: transform 0.3s ease; transform: rotate({{ isSubgroupExpanded(level, uniqueSubgroup._index) ? '90' : '0' }})deg); font-size: 20px; width: 20px; height: 20px;">
                        expand_more
                      </mat-icon>
                      <span>{{level.annotation}} {{level.level}} {{("00"+(uniqueSubgroup._index+1)).slice(-2)}}</span>
                    </div>
                    <app-form-input
                      [required]="true"
                      [value]="uniqueSubgroup.max_participants || level.max_participants"
                      (do)="updateSubgroupMaxParticipants(level, uniqueSubgroup._index, $event.target.value); $event.stopPropagation();"
                      name="max_pax"
                      style="width: 120px; flex: 0 0 auto;"
                      type="number"
                      Suffix="paxes"
                      (click)="$event.stopPropagation()">
                    </app-form-input>
                    <!-- Botón para eliminar subgrupo (solo si hay más de uno) -->
                    <img *ngIf="getAllUniqueSubgroupsForLevel(level).length > 1 && (!uniqueSubgroup.booking_users || uniqueSubgroup.booking_users.length === 0)"
                         (click)="openIntervalSelectorForRemoveSubgroup(level, uniqueSubgroup._index);$event.stopPropagation()"
                         src="assets/icons/icon/delete.png" alt class="icon20"
                         style="cursor: pointer; font-size: 20px; align-content: space-evenly; flex: 0 0 auto;">
                  </div>

                  <!-- Subgroup content rendered ONLY when expanded (Lazy Rendering) -->
                  <ng-container *ngIf="isSubgroupExpanded(level, uniqueSubgroup._index)">
                    <!-- Tabs de intervalos (solo si hay múltiples intervalos para este subgrupo) -->
                    <!-- OPTIMIZATION: Only render content of active tab to avoid rendering all 12 flux-disponibilidad components -->
                    <mat-tab-group *ngIf="getSubgroupIntervals(level, uniqueSubgroup._index).length > 1"
                                   [selectedIndex]="getSelectedIntervalIndexForSubgroup(level, uniqueSubgroup._index)"
                                   (selectedIndexChange)="setSelectedIntervalIndexForSubgroup(level, uniqueSubgroup._index, $event)"
                                   style="margin-bottom: 20px;">
                      <mat-tab *ngFor="let interval of getSubgroupIntervals(level, uniqueSubgroup._index); let intervalIdx = index; trackBy: trackInterval"
                               [label]="interval.name || ('Intervalo ' + (intervalIdx + 1))">
                        <!-- Lazy load tab content: only render flux-disponibilidad when this tab is active -->
                        <ng-container *ngIf="getSelectedIntervalIndexForSubgroup(level, uniqueSubgroup._index) === intervalIdx">
                          <div style="width: 100%;padding: 10px; background-color: var(--color-grey4);">
                            <vex-flux-disponibilidad
                              [courseFormGroup]="courses.courseFormGroup"
                              [level]="level"
                              [group]="getGroupForLevel(level)"
                              [subgroup_index]="uniqueSubgroup._index"
                              [interval_id]="interval.id"
                              (monitorSelect)="monitorSelect($event,level,uniqueSubgroup._index)"
                              (viewTimes)="openTimingModal($event.subGroup, $event.groupLevel, $event.selectedDate)">
                            </vex-flux-disponibilidad>
                          </div>
                        </ng-container>
                      </mat-tab>
                    </mat-tab-group>

                    <!-- Si solo hay un intervalo o ninguno para este subgrupo, mostrar directo -->
                    <div *ngIf="getSubgroupIntervals(level, uniqueSubgroup._index).length <= 1" style="width: 100%;margin-top: -10px;padding: 10px; background-color: var(--color-grey4); margin-bottom: 20px;">
                      <vex-flux-disponibilidad
                        [courseFormGroup]="courses.courseFormGroup"
                        [level]="level"
                        [group]="getGroupForLevel(level)"
                        [subgroup_index]="uniqueSubgroup._index"
                        [interval_id]="getSubgroupIntervals(level, uniqueSubgroup._index)[0]?.id"
                        (monitorSelect)="monitorSelect($event,level,uniqueSubgroup._index)"
                        (viewTimes)="openTimingModal($event.subGroup, $event.groupLevel, $event.selectedDate)">
                      </vex-flux-disponibilidad>
                    </div>
                  </ng-container>
                </ng-container>
              </ng-container>
            </ng-container>
          </ng-container>

          <!-- Mostrar niveles INACTIVOS disponibles para agregar (al final) -->
          <div style="display: flex; flex-direction: column; gap: 8px; margin-top: 16px; padding-top: 16px; border-top: 1px solid #dee2e6;">
            <ng-container *ngFor="let level of (courses.courseFormGroup.controls['levelGrop'].value || []); index as i; trackBy: trackLevel">
              <div *ngIf="!level.active"
                   style="display: flex; gap: 16px; align-items: center;">
                <mat-checkbox [disabled]="false"
                              [style.backgroundColor]="level.color+'33'"
                              [style.color]="level.color"
                              [style.border]="'1px solid '+level.color"
                              (change)="selectLevel({target:{checked:true}},i)"
                              style="height: 46px; border-radius: 3px; min-width: 225px;font-size: 12px;align-content: space-evenly;">
                  {{level.annotation}} {{level.level}}
                </mat-checkbox>
              </div>
            </ng-container>
          </div>
        </div>

        <!-- Vista simplificada de grupos y niveles (cuando NO está activado el flag por intervalos) -->
        <div *ngIf="!configureLevelsByInterval"
             class="level"
             style="display: flex;flex-direction: column;padding: 20px; border-radius: 8px; gap: 10px;">

          <!-- Botón para agregar grupo (solo en modo create) -->
        <div *ngIf="mode==='create'" style="margin-bottom: 16px;">
          <button mat-raised-button color="primary" (click)="openAddGroupDialog()">
            <mat-icon>add</mat-icon>
            Agregar Grupo
          </button>
        </div>
          <ng-container *ngFor="let level of (courses.courseFormGroup.controls['levelGrop'].value || []);index as i; trackBy: trackLevel">
            <div style="display: flex;gap: 16px;align-items: center;">
              <mat-checkbox [disabled]="mode==='update'&&level.active"
                            [style.backgroundColor]="level.active?level.color:level.color+'33'"
                            [style.color]="level.color" [style.border]="'1px solid '+level.color"
                            [(ngModel)]="level.active"
                            (click)="mode==='create'?selectLevel($event,i):editModal=true;setEditFunction('selectLevel',$event,i)"
                            style="height: 46px; border-radius: 3px; min-width: 225px;font-size: 12px;align-content: space-evenly;">
                {{level.annotation}} {{level.level}}
              </mat-checkbox>
              <mat-icon
                *ngIf="mode==='update'&&level.active&&!find(courses.courseFormGroup.controls['booking_users'].value,'degree_id',level.id)"
                (click)="editModal=true;setEditFunction('selectLevel',{target:{checked:false}},i)"
                style="cursor: pointer;float: inline-end;">
                delete
              </mat-icon>
            </div>
            <div *ngIf="level.active && (!useMultipleIntervals || (intervalGroups[selectedIntervalIndexForGroups] && intervalGroups[selectedIntervalIndexForGroups][level.id]))" style="display: flex;gap: 16px;">
              <app-form-input [required]="true" [value]="level.age_min" [max]="level.age_max"
                              (do)="level.age_min=$event.target.value;" style="width: calc(33.33% - 10px - 16px);"
                              name="min_age" type="number" Suffix="years">
              </app-form-input>
              <app-form-input [required]="true" [value]="level.age_max" [min]="level.age_min"
                              (do)="level.age_max=$event.target.value;" name="max_age"
                              style="width: calc(33.33% - 10px - 16px);" type="number" Suffix="years">
              </app-form-input>
              <mat-icon (click)="onInlineAddSubgroup(level, $event)" color="primary" style="color: white;
										height: 30px;
										min-width: 30px;
										border-radius: 15px;
										cursor: pointer;
										font-size: 30px;
										margin: auto 0;
										align-content: space-evenly;
										background-color: #E91E63;">
                add
              </mat-icon>
            </div>
            <!-- Mostrar TODOS los subgrupos únicos del nivel (tanto para múltiples intervalos como para sin intervalos) -->
            <ng-container *ngIf="level.active && getAllUniqueSubgroupsForLevel(level).length > 0">
              <ng-container *ngFor="let uniqueSubgroup of getAllUniqueSubgroupsForLevel(level); index as j">
                <div style="background-color: var(--color-grey4); display: flex;width: 100%; height: 46px;justify-content: space-between;align-items: center; border-radius: 4px;padding: 10px;">
                  {{level.annotation}} {{level.level}} {{("00"+(uniqueSubgroup._index+1)).slice(-2)}}
                  <img *ngIf="getAllUniqueSubgroupsForLevel(level).length>1 && (!uniqueSubgroup.booking_users || uniqueSubgroup.booking_users.length===0)"
                       (click)="mode==='create'?(useMultipleIntervals?removeIntervalLevelSubgroup(selectedIntervalIndexForGroups, level, uniqueSubgroup._index):addLevelSubgroup(level,uniqueSubgroup._index,false)):editModal=true;setEditFunction(useMultipleIntervals?'removeIntervalLevelSubgroup':'addLevelSubgroup',level,uniqueSubgroup._index,false)"
                       src="assets/icons/icon/delete.png" alt class="icon20"
                       style="cursor: pointer; font-size: 20px;align-content: space-evenly;">
                </div>

                <!-- UN SOLO componente de disponibilidad por subgrupo que muestra TODAS las fechas en columnas -->
                <div *ngIf="mode==='update'" style="width: 100%;margin-top: -10px;padding: 10px; background-color: var(--color-grey4);">
                  <vex-flux-disponibilidad
                    [courseFormGroup]="courses.courseFormGroup"
                    [level]="level"
                    [group]="getGroupForLevel(level)"
                    [subgroup_index]="uniqueSubgroup._index"
                    (monitorSelect)="monitorSelect($event,level,uniqueSubgroup._index)"
                    (viewTimes)="openTimingModal($event.subGroup, $event.groupLevel, $event.selectedDate)">
                  </vex-flux-disponibilidad>
                </div>
              </ng-container>
            </ng-container>
          </ng-container>
        </div>
      </ng-container>
      <ng-container *ngIf="courses.courseFormGroup.controls['course_type'].value===2">
        <div class="table-container" style="overflow: auto;max-height: 100vh;">
          <table #scrollContainer [dataSource]="getFilteredDurationsForTable()" mat-table class="mat-elevation-z8">
            <ng-container matColumnDef="intervalo">
              <th *matHeaderCellDef mat-header-cell>
                {{'interval'|translate}}
              </th>
              <td *matCellDef="let row" mat-cell>
                {{row}}
              </td>
            </ng-container>
            <ng-container
              *ngFor="let col of getNumberArray(courses.courseFormGroup.controls['max_participants'].value).slice(1)"
              [matColumnDef]="col">
              <th *matHeaderCellDef mat-header-cell>
                {{col}}
              </th>
              <td *matCellDef="let row; index as rowi" mat-cell style="max-width: 120px;padding: 0 5px;">
                <app-form-input
                  [value]="courses.courseFormGroup.controls['price_range'].value[+rowi][+col]"
                  [Suffix]="courses.courseFormGroup.controls['currency'].value" [margin]="4"
                  (do)="courses.courseFormGroup.controls['price_range'].value[+rowi][+col]=$event.target.value;"
                  type="number">
                </app-form-input>
              </td>
            </ng-container>
            <tbody>
            <tr *matHeaderRowDef="getNumberArray(courses.courseFormGroup.controls['max_participants'].value)"
                mat-header-row></tr>
            <tr *matRowDef="let row; columns: getNumberArray(courses.courseFormGroup.controls['max_participants'].value);"
                mat-row></tr>
            </tbody>
          </table>
        </div>
      </ng-container>
      <ng-container *ngIf="courses.courseFormGroup.controls['course_type'].value===3">
        <div *ngFor="let item of (courses.courseFormGroup.controls['settings'].value?.groups || []), index as i">
          <div
            style="width: 100%;background-color: var(--color-grey4);height: 60px;border-top: 1px solid #C7D0D3;padding: 0 24px;align-content: space-evenly;">
						<span>
							{{('Category_participant'| translate) + ' '+ (i+1)}}
						</span>
            <mat-icon *ngIf="i!==0"
                      (click)="courses.courseFormGroup.controls['settings'].value.groups.splice(i,1)"
                      style="cursor: pointer;float: inline-end;">
              delete
            </mat-icon>
          </div>
          <div style="margin: 20px 20px 0px; display: flex; flex-wrap: wrap; column-gap: 20px;">
            <app-form-input [value]="courses.courseFormGroup.controls['settings'].value.groups[i].groupName"
                            [required]="true"
                            [errors]="!courses.courseFormGroup.controls['settings'].value.groups[i].groupName?'errors.required':''"
                            (do)="courses.courseFormGroup.controls['settings'].value.groups[i].groupName=$event.target.value;"
                            name="category_name" style="width: 100%;" type="text">
            </app-form-input>
            <app-form-input [value]="courses.courseFormGroup.controls['settings'].value.groups[i].ageMin"
                            [max]="courses.courseFormGroup.controls['settings'].value.groups[i].ageMax"
                            [required]="true"
                            [errors]="!courses.courseFormGroup.controls['settings'].value.groups[i].ageMin===null?'errors.required':''"
                            (do)="courses.courseFormGroup.controls['settings'].value.groups[i].ageMin=$event.target.value;"
                            name="min_age" style="width: calc(50% - 10px);" Suffix="years" type="number">
            </app-form-input>
            <app-form-input [value]="courses.courseFormGroup.controls['settings'].value.groups[i].ageMax"
                            [min]="courses.courseFormGroup.controls['settings'].value.groups[i].ageMin"
                            [required]="true"
                            [errors]="!courses.courseFormGroup.controls['settings'].value.groups[i].ageMax===null?'errors.required':''"
                            (do)="courses.courseFormGroup.controls['settings'].value.groups[i].ageMax=$event.target.value;"
                            name="max_age" style="width: calc(50% - 10px);" Suffix="years" type="number">
            </app-form-input>
            <app-form-input [value]="courses.courseFormGroup.controls['settings'].value.groups[i].price"
                            [Suffix]="courses.courseFormGroup.controls['currency'].value" [required]="true"
                            [errors]="courses.courseFormGroup.controls['settings'].value.groups[i].price===null?'errors.required':''"
                            (do)="courses.courseFormGroup.controls['settings'].value.groups[i].price=$event.target.value;"
                            name="price" style="width: calc(50% - 10px);" type="number">
            </app-form-input>
            <app-form-input
              [value]="courses.courseFormGroup.controls['settings'].value.groups[i].optionName"
              (do)="courses.courseFormGroup.controls['settings'].value.groups[i].optionName=$event.target.value;"
              name="options" style="width: calc(50% - 10px);" type="text">
            </app-form-input>
          </div>
        </div>
        <div style="padding: 20px;border-top: 1px solid #DEE6EA;">
          <button (click)="addCategory()" style="margin-top: 0px !important;height: 38px;" mat-button
                  type="button">
            <mat-icon>add</mat-icon>
            {{'add_category' | translate }}
          </button>
        </div>
      </ng-container>
    </div>
    <div *ngIf="ModalFlux===4" [formGroup]="courses.courseFormGroup" class="flex flex-col" style="padding: 24px;">
      <section class="flex" style="flex-wrap: wrap;gap: 16px;justify-content: space-around;">
        <div style="font-size: 12px; font-weight: 400; line-height: 16px; margin-bottom: 20px;width: 100%;">
          {{"select_extra" | translate}}:
        </div>
        <ng-container
          *ngFor="let group of courses.courseFormGroup.controls['course_type'].value===3?(courses.courseFormGroup.controls['settings'].value?.groups || []):[1];index as i">
          <div *ngIf="courses.courseFormGroup.controls['course_type'].value===3"
               style="width: 100%;background-color: var(--color-grey4);height: 60px;border-top: 1px solid #C7D0D3;padding: 0 24px;align-content: space-evenly;">
						<span>
							{{("extras" | translate)+' '+(i+1)+": "+group.groupName}}
						</span>
          </div>
          <div *ngFor="let item of extras; index as j"
               style="width: calc(50% - 8px); height: 64px; padding: 12px; border-radius: 3px; border: 1px var(--color-dark1) solid; justify-content: flex-start; align-items: center; gap: 10px; display: inline-flex">
            <mat-checkbox [value]="item.id"
                          [checked]="find(this.courses.courseFormGroup.controls['course_type'].value===3?courses.courseFormGroup.controls['settings'].value.groups[i].extras:courses.courseFormGroup.controls['extras'].value,'id',item.id)"
                          (change)="selectExtra($event,item,i)">
            </mat-checkbox>
            <div
              style="flex-direction: column; justify-content: flex-start; align-items: flex-start; display: inline-flex">
              <div
                style="align-self: stretch; font-size: 14px; font-weight: 600; line-height: 18px; word-wrap: break-word">
                {{item.product | translate}}
              </div>
              <div
                style="align-self: stretch; color: var(--color-dark1); font-size: 12px; font-weight: 400; line-height: 16px; word-wrap: break-word">
                {{item.name | translate}}
              </div>
            </div>
            <div
              style="flex: 1 1 0; text-align: right; font-size: 14px; font-weight: 400; line-height: 18px; word-wrap: break-word">
              {{item.price|
              number:'0.2-2'}}&nbsp;{{courses.courseFormGroup.controls['currency'].value}}/{{'day' |
              translate}}
            </div>
            <mat-icon *ngIf="isTemporaryExtra(item.id)" (click)="extras.splice(j,1)"
                      style="cursor: pointer;float: inline-end;">
              delete
            </mat-icon>

          </div>
          <div (click)="extrasModal=!extrasModal"
               style="width: calc(50% - 8px); height: 64px; padding-left: 12px; padding-right: 12px; padding-top: 10px; padding-bottom: 10px; border-radius: 3px; border: 1px #E91E63 dotted; flex-direction: column; justify-content: space-between; align-items: center; display: inline-flex;cursor: pointer;">
            <div style="width: 24px; height: 24px; position: relative">
              <mat-icon color="primary"
                        style="height: 30px;min-width: 30px;border-radius: 15px; cursor: pointer; font-size: 30px;align-content: space-evenly;">
                add
              </mat-icon>
            </div>
            <div
              style="width: 259px; text-align: center; color: #E91E63; font-size: 14px; font-weight: 400; line-height: 18px; word-wrap: break-word">
              {{'create_extras' | translate}}
            </div>
          </div>
        </ng-container>
      </section>
    </div>
    <div *ngIf="ModalFlux===5" class="flex flex-col">
      <mat-accordion>
        <mat-expansion-panel *ngFor="let item of Translate">
          <mat-expansion-panel-header style="background-color: var(--color-grey4); border-top: 1px #C7D0D3 solid;
          font-size: 14px;
          font-family: Montserrat;
          font-weight: 400;
          text-transform: uppercase;
          line-height: 20px;
          word-wrap: break-word">
            <mat-panel-title>
              {{item.Name | translate}}
              <mat-icon style="float: right"
                        *ngIf="
                        courses.courseFormGroup.controls['translations'].value[item.Code]?.name &&
                        courses.courseFormGroup.controls['translations'].value[item.Code]?.short_description &&
                        courses.courseFormGroup.controls['translations'].value[item.Code]?.description
                          "
                        class="check">check</mat-icon>
              <button (click)="translateCourse(item.Code);$event.stopPropagation()"
                      style="margin-top: 0px !important;height: 38px;margin-left: auto;" color="primary"
                      mat-raised-button type="button">{{'translate_ia' | translate}}</button>
            </mat-panel-title>
          </mat-expansion-panel-header>
          <ng-template matExpansionPanelContent>
            <app-form-input [required]="true"
                            [value]="courses.courseFormGroup.controls['translations'].value[item.Code].name"
                            (do)="courses.courseFormGroup.controls['translations'].value[item.Code].name = $event.target.value"
                            style="width: 100%;margin-top: 20px;" name="courses.coursename">
            </app-form-input>
            <app-form-editor [required]="true"
                             [value]="courses.courseFormGroup.controls['translations'].value[item.Code].short_description || ''"
                             (do)="courses.courseFormGroup.controls['translations'].value[item.Code].short_description = $event.html || courses.courseFormGroup.controls['translations'].value[item.Code].short_description"
                             style="margin: 10px 0;"
                             name="courses.summary">
            </app-form-editor>

            <app-form-editor [required]="true"
                             [value]="courses.courseFormGroup.controls['translations'].value[item.Code].description || ''"
                             (do)="courses.courseFormGroup.controls['translations'].value[item.Code].description = $event.html || courses.courseFormGroup.controls['translations'].value[item.Code].description"
                             style="margin: 10px 0;"
                             name="courses.desc">
            </app-form-editor>

          </ng-template>
        </mat-expansion-panel>
      </mat-accordion>
    </div>
    <div style="margin: 20px;display: flex;justify-content: space-between;">
      <button *ngIf="ModalFlux>0"
              (click)="mode==='create' ?
				ModalFlux = this.courses.courseFormGroup.controls['course_type'].value === 2 &&
      !this.courses.courseFormGroup.controls['is_flexible'].value && ModalFlux == 4 ? ModalFlux-2 : ModalFlux -1 :router.navigate(['/courses/detail/' + id])"
              style="margin-top: 0px !important;height: 38px; width: 128px;" mat-button type="button">
        <mat-icon *ngIf="mode==='create'">arrow_back</mat-icon>
        {{ (mode === 'create' ? 'back' : 'cancel') | translate }}
      </button>
      <button (click)="mode==='create'?Confirm(1):editModal=true;setEditFunction('endCourse')"
              style="margin-top: 0px !important;height: 38px; width: 128px;margin-left: auto;" color="primary"
              mat-raised-button type="button">
        {{ (mode==='create'?'confirm':'save') | translate }}
      </button>
    </div>
  </div>
  <vex-course-detail-card *ngIf="!loading" [step]="ModalFlux" [mode]="mode" [detailMode]="false"
                          [subgroupCache]="previewSubgroupCache" [courseFormGroup]="courses.courseFormGroup" card>
  </vex-course-detail-card>
  <vex-course-detail-card *ngIf="!loading" [step]="ModalFlux" [mode]="mode" [detailMode]="false"
                          [subgroupCache]="previewSubgroupCache" [courseFormGroup]="courses.courseFormGroup" card2>
  </vex-course-detail-card>
</vex-flux-layout>

<vex-flux-modal *ngIf="extrasModal" [width]="670" (Close)="extrasModal=false" title="{{'create_extras' | translate}}">
  <div body>
    <form [formGroup]="extrasFormGroup" style="display: flex; column-gap: 20px; flex-wrap: wrap; padding: 20px;">
      <app-form-input [required]="true" [form]="extrasFormGroup" style="width: calc(50% - 10px);margin-top: 10px;"
                      control="product" name="product" type="text">
      </app-form-input>
      <app-form-input [required]="true" [form]="extrasFormGroup" style="width: calc(50% - 10px);margin-top: 10px;"
                      control="name" name="name" type="text">
      </app-form-input>
      <app-form-input [required]="true" [form]="extrasFormGroup"
                      [Suffix]="courses.courseFormGroup.controls['currency'].value"
                      style="width: calc(50% - 10px);margin-top: 10px;" control="price" name="price_per_day" type="number">
      </app-form-input>
      <app-form-input [required]="true" [form]="extrasFormGroup" style="width: calc(50% - 10px);margin-top: 10px;"
                      control="tva" name="tva" Suffix="%" type="number">
      </app-form-input>
      <div style="width: 100%">
        <mat-slide-toggle formControlName="status">
          {{'active' | translate}}
        </mat-slide-toggle>
      </div>
      <div style="width: 100%; display: flex; justify-content: flex-end; gap: 12px; margin-top: 20px;">
        <button (click)="extrasModal=false"
                style="height: 38px; width: 128px;" mat-button type="button">
          {{'cancel' | translate }}
        </button>
        <button (click)="createExtras()" style="height: 38px; width: 150px;" color="primary"
                mat-raised-button type="button">
          {{ (editingIndex !== null ? 'save' : 'create_extras') | translate }}
        </button>
      </div>
    </form>
  </div>
</vex-flux-modal>

<vex-flux-modal *ngIf="confirmModal" [width]="670" (Close)="confirmModal=false" title="{{'almost_done' | translate}}">
  <div [formGroup]="courses.courseFormGroup" body style="display: flex; gap: 20px; flex-wrap: wrap;">
    <vex-course-detail-opcion [isCreate]="true" [Form]="courses.courseFormGroup"></vex-course-detail-opcion>
    <!--		<div style="width: 100;
        font-size: 14px;
        font-weight: 400;
        line-height: 18px;
        word-wrap: break-word">
          {{(mode==='create'?"course_created":"") | translate}}
          {{'confirm_option' | translate}}:
        </div>
        <div style="width: 100%">
          <mat-slide-toggle formControlName="online">
            <span style="
            font-size: 14px;
            font-weight: 600;
            line-height: 18px;
            word-wrap: break-word">
              {{"visible_reserve_page" | translate}}
            </span>
            <br>
            <span style="
            color: var(&#45;&#45;color-dark1);
            font-size: 12px;
            font-weight: 400;
            line-height: 16px;
            word-wrap: break-word">
              {{"course_visible_online_now" | translate}}
            </span>
          </mat-slide-toggle>
        </div>
        <div style="width: 100%">
          <mat-slide-toggle formControlName="active">
            <span style="
            font-size: 14px;
            font-weight: 600;
            line-height: 18px;
            word-wrap: break-word">
              {{'active' | translate}}
            </span>
            <br>
            <span style="
            color: var(&#45;&#45;color-dark1);
            font-size: 12px;
            font-weight: 400;
            line-height: 16px;
            word-wrap: break-word">
              {{"course_active_reservable" | translate}}
            </span>
          </mat-slide-toggle>
        </div>-->
    <div style="display: flex;width: 100%;justify-content: flex-end;gap: 20px;">
      <app-form-button form="stroked" name="cancel" (click)="confirmModal=false">
      </app-form-button>
      <app-form-button form="flat" [name]="mode==='create'?'end_create_course':'end_update_course'"
                       (click)="confirmModal=false;endCourse()">
      </app-form-button>
    </div>
  </div>
</vex-flux-modal>
<vex-flux-modal *ngIf="editModal" [width]="670" (Close)="editModal=false" title="{{'are_you_sure' | translate}}">
  <div style="display: flex;width: 100%;justify-content: flex-end;gap: 20px;" body>
    <div>
      {{'are_you_sure_action' | translate}}
    </div>
    <div style="display: flex;width: 100%;justify-content: flex-end;gap: 20px;">
      <app-form-button form="stroked" name="cancel" (click)="editModal=false">
      </app-form-button>
      <app-form-button form="flat" name="confirm" (click)="executeEditFunction()">
      </app-form-button>
    </div>
  </div>
</vex-flux-modal>

