<div [className]="center ? 'card cardcenter' : 'card'" [style.boxShadow]="border ? '' : 'none'">
    <div class="card-header">
        <div class="card-thumb">
            <app-level-user
                [allLevels]="user.getAllLevelsBySport()"
                [selectLevel]="level?.id"
                [size]="72"
                [userImage]="user.getGoalImage(goals)">
            </app-level-user>
        </div>
        <div class="card-summary">
            <div class="level-badge" [style.background]="level?.color">
                {{level?.annotation}} / {{level?.name}}
            </div>
            <div class="progress-row">
                <span class="progress-label">{{ 'progress' | translate }}</span>
                <span class="progress-value">{{calculateGoalsScore()}}%</span>
            </div>
            <mat-progress-bar mode="determinate" [value]="calculateGoalsScore()" [ngClass]="getProgressClass()"></mat-progress-bar>
            <div class="summary-pills">
                <span class="pill" *ngIf="getGoalsNoEvaluation() > 0">
                    {{ getGoalsNoEvaluation() }} {{ 'no_evaluation' | translate }}
                </span>
                <span class="pill" *ngIf="getGoalsNoEvaluation() === 0">
                    {{ getGoalsToImprove() }} {{ 'to_improve' | translate }}
                </span>
                <span class="pill">{{ getGoalsCompleted() }} {{ 'achieved' | translate }}</span>
                <span class="pill" *ngIf="getMediaCounts().images > 0 || getMediaCounts().videos > 0">
                    {{ getMediaCounts().images }} {{ 'photos' | translate }}
                    <ng-container *ngIf="getMediaCounts().videos > 0"> Â· {{ getMediaCounts().videos }} {{ 'videos' | translate }}</ng-container>
                </span>
            </div>
        </div>
        <button mat-icon-button class="expand-button" (click)="toggleExpanded()">
            <mat-icon svgIcon="mat:expand_more" *ngIf="!expanded"></mat-icon>
            <mat-icon svgIcon="mat:expand_less" *ngIf="expanded"></mat-icon>
        </button>
    </div>

    <div class="card-body" *ngIf="expanded">
        <div class="section">
            <div class="section-title">{{ 'level_goals' | translate }}</div>
            <div class="goal-block" *ngFor="let goal of goals">
                <div class="goal-item">
                    <div class="goal-indicator" [ngClass]="getGoalStatusClass(goal.id)"></div>
                    <div class="goal-name">{{ goal.name }}</div>
                    <span class="goal-current">{{ getGoalStatusLabel(goal.id) }}</span>
                    <button mat-stroked-button color="accent" class="goal-edit" (click)="startEditGoal(goal.id)">
                        {{ 'edit' | translate }}
                    </button>
                </div>
                <div class="goal-edit-panel" *ngIf="editingGoalId === goal.id">
                    <div class="goal-edit-options">
                        <button mat-stroked-button class="option-btn" [class.active]="editingScore === 0" (click)="setEditingScore(0)">
                            {{ 'to_improve' | translate }}
                        </button>
                        <button mat-stroked-button class="option-btn" [class.active]="editingScore === 10" (click)="setEditingScore(10)">
                            {{ 'achieved' | translate }}
                        </button>
                    </div>
                    <div class="goal-edit-actions">
                        <button mat-flat-button color="primary" (click)="saveGoalEdit(goal.id)">{{ 'save' | translate }}</button>
                        <button mat-stroked-button (click)="cancelEditGoal()">{{ 'cancel' | translate }}</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="section">
            <div class="section-title">{{ 'monitor_comments' | translate }}</div>
            <div class="comments-summary" *ngIf="getEvaluation()?.observations">
                <div class="observation-label">{{ 'observations' | translate }}</div>
                <div class="observation-text">{{ getEvaluation()?.observations }}</div>
            </div>
            <div class="comment-actions">
                <mat-form-field class="comment-input" appearance="outline">
                    <mat-label>{{ 'add_comment' | translate }}</mat-label>
                    <input matInput [(ngModel)]="newComment">
                </mat-form-field>
                <button mat-flat-button color="primary" (click)="addComment()" [disabled]="savingComment">
                    {{ 'add' | translate }}
                </button>
            </div>
            <div class="comment-list">
                <div *ngIf="getEvaluation() && user.getEvaluationComments(getEvaluation().id).length === 0" class="comment-empty">
                    {{ 'no_comments' | translate }}
                </div>
                <div class="comment-item" *ngFor="let comment of user.getEvaluationComments(getEvaluation()?.id)">
                    <div class="comment-main">
                        <div class="comment-text">{{ comment.comment }}</div>
                        <div class="comment-meta">
                            <span class="comment-author">{{ getCommentAuthor(comment) }}</span>
                            <span class="comment-date">{{ comment.created_at | date:'short' }}</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="upload-actions">
                <label class="upload-button">
                    <input type="file" multiple accept="image/*,video/*" (change)="uploadFiles($event)">
                    <span>{{ 'upload_files' | translate }}</span>
                </label>
                <span *ngIf="uploadingFiles" class="uploading-text">{{ 'uploading' | translate }}</span>
            </div>
        </div>

        <div class="section">
            <div class="section-title">{{ 'history' | translate }}</div>
            <div class="history-summary" *ngIf="getHistoryCount() > 0">
                <span>{{ getHistoryCount() }} {{ 'history_changes' | translate }}</span>
                <span *ngIf="getHistoryLastDate()">{{ getHistoryLastDate() | date:'short' }}</span>
            </div>
            <button mat-flat-button color="primary" (click)="user.openEvaluationHistory(level, goals, selectedSport)">
                {{ 'view_history' | translate }}
            </button>
        </div>
    </div>
</div>
