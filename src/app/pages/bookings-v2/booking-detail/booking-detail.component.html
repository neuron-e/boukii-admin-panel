<div class="barWrapper">
  <vex-breadcrumbs [crumbs]="[
      { icon: 'reservas' },
      { text: 'bookings', title: true, link: '/bookings' },
      { text: 'booking_info', subtitle: true },
      { text: '#'+id, subtitle: true }

    ]"
                   class="booking-breadcrumb"></vex-breadcrumbs>
</div>
<div class="booking-loading-overlay" *ngIf="isLoading">
  <mat-progress-spinner diameter="48" mode="indeterminate"></mat-progress-spinner>
  <div class="loading-text">{{ 'loading' | translate }}</div>
</div>
<div class="bookingDetailContainer">
  <button (click)="openDetailBookingDialog()"
          style="margin-bottom: 0;"
          mat-button
          type="button"
          class="modalButton">
    {{ "bookings_page_descriptionModal_button" | translate }}
  </button>
  <div class="left-column">
    <div class="activities" *ngIf="allLevels">
      <div *ngIf="groupedActivities && groupedActivities.length === 0" class="no-data-message">
        <mat-card class="p-6 text-center">
          <mat-card-content>
            <mat-icon class="text-gray-400 mb-4" style="font-size: 48px; width: 48px; height: 48px;">error_outline</mat-icon>
            <h3>{{ 'no_booking_data_title' | translate }}</h3>
            <p class="text-gray-600">{{ 'no_booking_data_message' | translate }}</p>
            <p class="text-sm text-gray-500">{{ 'booking_id' | translate }}: #{{ id }}</p>
          </mat-card-content>
        </mat-card>
      </div>
      <booking-detail-description-card *ngFor="let activity of groupedActivities; let i = index"
                                       [index]="i"
                                       [utilizers]="activity.utilizers"
                                       [sport]="activity.sport"
                                       [sportLevel]="activity.sportLevel"
                                       [allLevels]="allLevels"
                                       [course]="activity.course"
                                       [subgroupLabel]="activity.subgroupLabel"
                                       [dates]="activity.dates"
                                       [monitors]="activity.monitors"
                                       [clientObs]="activity.clientObs"
                                       [schoolObs]="activity.schoolObs"
                                       [total]="activity.total"
                                       [isDetail]="true"
                                       [status]="activity.status"
                                       [groupedActivities]="groupedActivities"
                                       (deleteActivity)="processDelete(i)"
                                       (editActivity)="editActivity($event, i)">
      </booking-detail-description-card>
    </div>
  </div>
  <div class="right-column">
    <booking-detail-reservation-detail *ngIf="mainClient"
                                       [client]="mainClient"
                                       [allLevels]="allLevels"
                                       [isModal]="incData?.isModal"
                                       [bookingData]="bookingData$ | async"
                                       [activities]="groupedActivities"
                                       [activitiesChanged]="activitiesChanged$"
                                       (deleteActivity)="processFullDelete()"
                                       (endClick)="endModal=true"
                                       (closeClick)="closeModal()"
                                        (payClick)="handlePayClick()">
    </booking-detail-reservation-detail>
  </div>
</div>
<div class="mobileFixe" *ngIf="bookingData && groupedActivities?.length > 0">
  {{ "bookings_page.description.total" | translate }}
  <ng-container>
      <span class="totalPrice">
        {{ bookingData?.price_total  | number:'0.2-2'}}
        {{ groupedActivities[0]?.course?.currency }}
      </span>
  </ng-container>
  <ng-container>
    <span *ngIf="!bookingData?.paid && getPendingAmount() > 0">{{ "to_pay" | translate }}</span>
  </ng-container>
  <ng-container *ngIf="!bookingData?.paid && getPendingAmount() > 0">
      <span class="totalPrice" *ngIf="getPendingAmount() != 0">
        {{ getPendingAmount()  | number:'0.2-2' }}
        {{ groupedActivities[0]?.course?.currency}}
      </span>
  </ng-container>

  <div style="width: 100%; display: flex; gap: 10px;">
    <button
      style="height: 38px; width: calc(100% - 5px); border-radius: 3px; margin-top: 16px;
           color: white; font-size: 14px; font-family: DM Sans; font-weight: 600;
           line-height: 18px; word-wrap: break-word"
      color="primary"
      mat-raised-button
      type="button"
      class="client-button"
      [disabled]="bookingData?.paid"
      (click)="handlePayClick()">
      {{  (bookingData?.paid ? "ispaid" : "to_pay") | translate }}
    </button>
  </div>
</div>
<vex-flux-modal *ngIf="deleteModal"
                [width]="570"
                (Close)="deleteModal=false"
                title="delete_activity">
  <div body>
    <div style="margin: 10px;">
      {{"cancel_activity" | translate}} #{{("00"+deleteIndex+1).slice(-2)}}?
    </div>
  </div>
  <div footer class="modal-buttons-container">
    <button (click)="deleteModal=false"
            class="modal-action-button secondary-button"
            mat-raised-button
            type="button"
            >
      {{"cancel" | translate }}
    </button>
    <button (click)="cancelActivity(deleteIndex)"
            class="modal-action-button primary-button"
            color="primary"
            mat-raised-button
            type="button">
      {{ "yes_delete" | translate }}
    </button>
  </div>
</vex-flux-modal>
<vex-flux-modal *ngIf="deleteFullModal"
                [width]="570"
                (Close)="deleteFullModal=false"
                title="bookings_page.detail.full_cancel">
  <div body>
    <div style="margin: 10px;">
      {{"bookings_page.cancelations.cancel_booking" | translate}} ?
    </div>
  </div>
  <div footer class="modal-buttons-container">
    <button (click)="deleteFullModal=false"
            class="modal-action-button secondary-button"
            mat-raised-button
            type="button"
            >
      {{"cancel" | translate }}
    </button>
    <button (click)="cancelFull"
            class="modal-action-button primary-button"
            color="primary"
            mat-raised-button
            type="button">
      {{ "yes_delete" | translate }}
    </button>
  </div>
</vex-flux-modal>
<vex-flux-modal *ngIf="payModal" [width]="570" (Close)="payModal=false;step=1;isPaid=false"
                title="{{'end_booking' | translate}}">
  <div body>
    <div style="margin: 10px;" class="sectionTitle" *ngIf="step === 1">
      <ng-container *ngIf="bookingService.calculatePendingPrice() > 0; else confirmReservation">
        {{"pending_payment" | translate}}: <span class="totalPrice">{{ bookingService.calculatePendingPrice() }} {{ groupedActivities[0]?.course?.currency }}</span>
      </ng-container>
      <ng-template #confirmReservation>
        <p>{{ "confirm_booking_message" | translate }}</p>
      </ng-template>
    </div>

    <div style="margin: 10px;" class="sectionTitle" *ngIf="step === 2">
      <ng-container>
        {{"is_paid" | translate}}:
      </ng-container>
    </div>

    <!-- Paso 2: Confirmación de pago offline -->
    <div *ngIf="step === 2" style="margin: 10px 0;">
      <p style="margin-bottom: 15px;">
        {{ "payment_method" | translate }}:
        <strong>{{ selectedPaymentOptionLabel || resolvePaymentLabel(determinePaymentMethodId()) }}</strong>
      </p>

      <mat-checkbox name="paymentConfirmation" [(ngModel)]="isPaid" color="primary">
        {{ "confirm_payment_received" | translate }}
      </mat-checkbox>

      <p style="font-size: 12px; color: #666; margin-top: 10px;">
        {{ "payment_confirmation_notice" | translate }}
      </p>
    </div>

    <!-- Paso 1: Selección de método de pago -->
    <div *ngIf="step === 1" style="margin: 10px 0;">
      <mat-radio-group name="paymentMethod" [(ngModel)]="paymentMethod" (change)="onPaymentMethodChange($event)">
        <mat-radio-button [value]="1" style="display: block;">
          {{"direct_payment" | translate}}  <!-- Efectivo / Tarjeta -->
        </mat-radio-button>

        <div *ngIf="paymentMethod === 1" style="margin: 10px 0;">
          <mat-form-field appearance="fill">
            <mat-label>{{"select_payment_method" | translate}}</mat-label>
            <mat-select name="paymentOption" [(ngModel)]="selectedPaymentOptionId"
                        (selectionChange)="onPaymentOptionSelectionChange($event.value)">
              <mat-option *ngFor="let option of paymentOptions" [value]="option.id" >
                {{option.label}}
              </mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <mat-radio-button [value]="3" style="display: block;">
          {{'send_payment_link' | translate}}  <!-- Enviar enlace de pago -->
        </mat-radio-button>
      </mat-radio-group>
    </div>

  </div>
  <div footer class="modal-buttons-container">
    <!-- Botones para Step 1 -->
    <ng-container *ngIf="step === 1">
      <button (click)="cancelPaymentStep()"
              class="modal-action-button secondary-button"
              mat-raised-button
              type="button">
        {{"cancel" | translate }}
      </button>
      <button (click)="finalizeBooking()"
              class="modal-action-button primary-button"
              color="primary"
              mat-raised-button
              type="button">
        {{ (paymentMethod === 3 ? 'send_payment_link' : 'continue') | translate }}
      </button>
    </ng-container>

    <!-- Botones para Step 2 -->
    <ng-container *ngIf="step === 2">
      <button (click)="step = 1"
              class="modal-action-button secondary-button"
              mat-raised-button
              type="button">
        {{"back" | translate }}
      </button>
      <button (click)="finalizeBooking()"
              class="modal-action-button primary-button"
              color="primary"
              mat-raised-button
              type="button"
              [disabled]="!isPaid">
        {{ "confirm_payment" | translate }}
      </button>
    </ng-container>
  </div>
</vex-flux-modal>
