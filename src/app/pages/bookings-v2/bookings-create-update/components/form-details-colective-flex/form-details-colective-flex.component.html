<form class="wrapper" [formGroup]="stepForm">
  <!-- Información de las reglas de reserva -->
  <div *ngIf="course.settings?.mustBeConsecutive || course.settings?.mustStartFromFirst"
       class="reservation-rules-info mb-3"
       style="background-color: #e3f2fd; border: 1px solid #2196f3; border-radius: 8px; padding: 12px; margin-bottom: 16px;">
    <div style="display: flex; align-items: center; margin-bottom: 8px;">
      <mat-icon style="color: #2196f3; margin-right: 8px; font-size: 20px;">info</mat-icon>
      <strong style="color: #1976d2;">{{ 'booking_rules_active' | translate }}</strong>
    </div>
    <ul style="margin: 0; padding-left: 20px; color: #1565c0; font-size: 14px;">
      <li *ngIf="course.settings?.mustStartFromFirst">{{ 'booking_must_start_from_first_day' | translate }}</li>
      <li *ngIf="course.settings?.mustBeConsecutive">{{ 'booking_dates_must_be_consecutive' | translate }}</li>
    </ul>
  </div>

  <!-- Mensajes de error de validación -->
  <div *ngIf="stepForm.get('course_dates')?.errors" class="validation-errors mb-3">
    <div *ngIf="stepForm.get('course_dates')?.errors?.['noDatesSelected']"
         class="error-message"
         style="background-color: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 8px; color: #c62828; font-size: 14px; margin-bottom: 8px;">
      <mat-icon style="vertical-align: middle; margin-right: 4px; font-size: 16px;">error</mat-icon>
      {{ 'no_dates_selected' | translate }}
    </div>
    <div *ngIf="stepForm.get('course_dates')?.errors?.['mustStartFromFirstDay']"
         class="error-message"
         style="background-color: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 8px; color: #c62828; font-size: 14px; margin-bottom: 8px;">
      <mat-icon style="vertical-align: middle; margin-right: 4px; font-size: 16px;">error</mat-icon>
      {{ 'booking_must_start_from_first_day' | translate }}
    </div>
    <div *ngIf="stepForm.get('course_dates')?.errors?.['datesNotConsecutive']"
         class="error-message"
         style="background-color: #ffebee; border: 1px solid #f44336; border-radius: 4px; padding: 8px; color: #c62828; font-size: 14px; margin-bottom: 8px;">
      <mat-icon style="vertical-align: middle; margin-right: 4px; font-size: 16px;">error</mat-icon>
      {{ 'booking_dates_must_be_consecutive' | translate }}
    </div>
  </div>

  <div formArrayName="course_dates">
    <div *ngFor="let courseDate of courseDatesArray.controls; let i = index" [formGroupName]="i">
      <div class="content-wrapper" [class.first-date]="i === 0 && course.settings?.mustStartFromFirst">
        <mat-checkbox formControlName="selected" (change)="onDateSelect($event, i)"></mat-checkbox>
        <div [class]="{ rowsWrapper: true, last: i === courseDatesArray.controls.length - 1 }">
          <div class="row-1">
            <!-- Aquí usamos courseDatesArray en lugar de course.course_dates -->
            <span class="date">{{ formatDate(courseDatesArray.at(i).get('date').value) }}</span>
            <span class="hour">{{ courseDatesArray.at(i).get('startHour').value }}h - {{
              courseDatesArray.at(i).get('endHour').value }}h</span>
            <span class="price">{{ course.price }} {{ course.currency }} </span>
          </div>
          <div class="row-2">
            <div>
              <mat-form-field appearance="outline">
                <mat-label>{{ "participant" | translate }} </mat-label>
                <input matInput disabled [value]="utilizer.first_name + ' ' + utilizer.last_name" />
                <mat-icon class="disabled-icon" matPrefix fontSet="material-icons-outlined">people</mat-icon>
              </mat-form-field>
            </div>
            <div>
              <div class="extra-field-wrapper" *ngIf=" this.posibleExtras && this.posibleExtras.length">
                <mat-form-field appearance="outline" class="extras-field">
                  <mat-label>{{ "extras" | translate }} </mat-label>
                  <mat-select multiple formControlName="extras" (selectionChange)="onExtraChange(i)"
                    [disabled]="!(courseDatesArray.at(i)).get('selected').value || !this.posibleExtras || !this.posibleExtras.length">
                    <mat-option *ngFor="let extra of posibleExtras" [value]="extra">
                      <span>{{ extra.name }} - {{ extra.description }}</span>
                      <span>{{ extra.price }}</span>
                    </mat-option>
                  </mat-select>
                </mat-form-field>
                <span class="extras-price">{{ isSelected(i) ? totalExtraPrice[i] : '00.00' + course.currency }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</form>