<mat-tab-group
  (selectedTabChange)="onTabChange($event)"
  [selectedIndex]="selectedIndex" >
  <mat-tab *ngFor="let tab of tabs" [disabled]="isLoading">
    <ng-template mat-tab-label>
      <mat-icon class="custom-icon" [ngClass]="tab.class">circle</mat-icon>
      {{ tab.label | translate }}
    </ng-template>
    <ng-container *ngTemplateOutlet="myForm"></ng-container>
  </mat-tab>
</mat-tab-group>
<mat-card-content class="wrapper">
  <div class="stepButtonsWrapper">
    <app-form-button (click)="handlePrevStep()" form="back" name="back" icon="mat:arrow_back">
    </app-form-button>

    <app-form-button (click)="completeStep()" [disabled]="!isFormValid()" form="flat" icon="mat:add" name="confirm">
    </app-form-button>

  </div>
</mat-card-content>

<ng-template #myForm>
  <mat-spinner *ngIf="isLoading"
               style="margin: 0 auto"></mat-spinner>
  <form [formGroup]="stepForm">
    <div *ngIf="!isLoading">
      <div class="calendarWrapper">
        <div *ngIf="!showTwoMonths" class="one-month">
          <mat-calendar [startAt]="selectedDate" [minDate]="minDate" [(selected)]="selectedDate"
                        [dateClass]="dateClass()" (monthSelected)="getCourses(sportLevel)"
                        (selectedChange)="handleDateChange($event)"></mat-calendar>
        </div>

        <div *ngIf="showTwoMonths" class="two-months">
          <div class="no-arrows no-next">
            <mat-calendar [startAt]="selectedDate" [minDate]="minDate" [(selected)]="selectedDate"
                          [dateClass]="dateClass()" (monthSelected)="getCourses(sportLevel)"
                          (selectedChange)="handleDateChange($event)" [headerComponent]="CustomHeader"></mat-calendar>
          </div>
          <div class="no-arrows no-previous">
            <mat-calendar #secondCalendar [startAt]="nextMonthDate" [minDate]="minDate" [(selected)]="selectedDate"
                          [dateClass]="dateClass()" (monthSelected)="getCourses(sportLevel)"
                          (selectedChange)="handleDateChange($event)" [headerComponent]="CustomHeader"></mat-calendar>
          </div>
        </div>
      </div>

      <mat-radio-group aria-label="Select an option" formControlName="course" class="courses-wrapper">
        <label class="courseCard" [ngClass]="{ active: stepForm.get('course').value === item }"
               (click)="handleCourseSelection(item)" *ngFor="let item of cursesInSelectedDate">
          <mat-radio-button [value]="item"> </mat-radio-button>
          <img class="courseImg" [src]="item.icon" />
          <div style="width: 100%">
            <h4 class="courseTitle">
              {{ item.name }}
              <div [style.background]="sportLevel?.color" style="
      display: inline-block;
      padding: 0.2rem 0.5rem;
      color: #fff;
      border-radius: 5px;
      text-align: center;
      font-size: 10px;
      margin-left: 0.5rem;
      overflow: inherit;
    ">
                {{ sportLevel?.league }} {{ sportLevel?.name }}
              </div>
              <span class="coursePrice">
                {{ getCorrectPriceForPrivateFlex(item) }} {{ item.currency }}
              </span>
            </h4>

            <span class="courseSubtitle">
              {{item.typeString | translate}} {{item.is_flexible ? 'Flex' : 'Fix' | translate}} {{item.sport.name}}
            </span>
            <ng-container *ngIf="item.course_type !== 1">
              <span class="courseDate">
                {{utilsService.getAvailableWeekDays(item.settings)}}
              </span>
              <div class="courseDate">
                <img src="assets/img/icons/calendar-1.svg" />
                <span class="courseDate_day">
                  {{ item.date_start | date:'dd-MM-yyyy' }} - {{ item.date_end | date:'dd-MM-yyyy' }}
                </span>
                <span> {{ item.hour_min }}h - {{ item.hour_max }}h</span>
              </div>
            </ng-container>
            <ng-container *ngIf="item.course_type === 1">
              <ng-container *ngFor="let courseDate of item.course_dates">
                <div class="courseDate" *ngIf="utilsService.isFutureDate(courseDate)">
                  <img src="assets/img/icons/calendar-1.svg" />
                  <span class="courseDate_day">
        {{ courseDate.date | date:'dd-MM-yyyy' }}
      </span>
                  <span>{{ courseDate.hour_start }}h - {{ courseDate.hour_end }}h</span>
                </div>
              </ng-container>
            </ng-container>


          </div>

          <!-- MEJORA CRÍTICA: Selector de subgrupos con información de capacidad en tiempo real -->
          <ng-container *ngIf="item.course_type === 1 && selectedCourse === item">
            <div class="capacity-loading enhanced" *ngIf="isCapacityLoading">
              <mat-spinner diameter="20" class="loading-spinner"></mat-spinner>
              <div class="loading-content">
                <span class="loading-text">{{ 'checking_capacity' | translate }}</span>
                <div class="loading-progress">
                  <mat-progress-bar mode="indeterminate" class="slim-progress"></mat-progress-bar>
                </div>
              </div>
            </div>

            <div class="subGroups-container" *ngIf="!isCapacityLoading && selectedSubGroups.length > 0">
              <h4>{{ 'available_groups' | translate }}</h4>
              <mat-radio-group formControlName="selectedSubGroup">
                <mat-radio-button
                  *ngFor="let group of selectedSubGroups"
                  [value]="group"
                  [disabled]="!group.capacity_info?.has_capacity"
                  (change)="selectSubGroup(group)"
                  class="subGroup enhanced"
                  [ngClass]="{
                    'has-capacity': group.capacity_info?.has_capacity,
                    'no-capacity': !group.capacity_info?.has_capacity,
                    'almost-full': group.capacity_info?.capacity_percentage > 80,
                    'unlimited': group.capacity_info?.is_unlimited
                  }"
                >
                    <div class="group-header">
                      <div
                        [style.background]="sportLevel?.color"
                        class="group-badge">
                        {{sportLevel?.annotation}} {{sportLevel?.name}}
                      </div>
                      <div class="capacity-indicator">
                        <mat-icon
                          [ngClass]="{
                            'capacity-ok': group.capacity_info?.has_capacity,
                            'capacity-full': !group.capacity_info?.has_capacity
                          }">
                          {{group.capacity_info?.has_capacity ? 'check_circle' : 'cancel'}}
                        </mat-icon>
                      </div>
                    </div>

                    <div class="capacity-details">
                      <ng-container *ngIf="!group.capacity_info?.is_unlimited">
                        <div class="capacity-bar enhanced">
                          <div class="capacity-background"></div>
                          <div class="capacity-fill animated"
                               [style.width.%]="group.capacity_info?.capacity_percentage"
                               [ngClass]="{
                                 'fill-ok': group.capacity_info?.capacity_percentage <= 50,
                                 'fill-warning': group.capacity_info?.capacity_percentage > 50 && group.capacity_info?.capacity_percentage <= 80,
                                 'fill-danger': group.capacity_info?.capacity_percentage > 80,
                                 'fill-full': group.capacity_info?.capacity_percentage >= 100
                               }">
                          </div>
                          <div class="capacity-glow"
                               *ngIf="group.capacity_info?.capacity_percentage > 80"
                               [ngClass]="{'pulsing': group.capacity_info?.capacity_percentage > 90}">
                          </div>
                        </div>
                        <div class="capacity-text">
                          <span class="current">{{group.capacity_info?.current_bookings}}</span>
                          <span class="separator">/</span>
                          <span class="max">{{group.capacity_info?.max_participants}}</span>
                          <span class="label">{{ 'participants' | translate }}</span>
                        </div>
                        <div class="availability-info" *ngIf="group.capacity_info?.available_slots > 0">
                          <span class="available">
                            {{group.capacity_info?.available_slots}} {{ 'slots_available' | translate }}
                          </span>
                          <span class="needed" *ngIf="group.capacity_info?.needed_slots > 1">
                            ({{ 'need' | translate }} {{group.capacity_info?.needed_slots}})
                          </span>
                        </div>
                      </ng-container>
                      <div class="unlimited-indicator" *ngIf="group.capacity_info?.is_unlimited">
                        <mat-icon>all_inclusive</mat-icon>
                        <span>{{ 'unlimited_capacity' | translate }}</span>
                      </div>
                    </div>

                    <!-- Estado de no disponibilidad -->
                    <div class="no-capacity-warning" *ngIf="!group.capacity_info?.has_capacity && !group.capacity_info?.is_unlimited">
                      <mat-icon>warning</mat-icon>
                      <span>{{ 'course_full' | translate }}</span>
                    </div>
                </mat-radio-button>
              </mat-radio-group>
            </div>

            <!-- Mensaje cuando no hay subgrupos disponibles -->
            <div class="no-subgroups-warning" *ngIf="!isCapacityLoading && selectedSubGroups.length === 0">
              <mat-icon>error_outline</mat-icon>
              <h4>{{ 'no_available_groups' | translate }}</h4>
              <p>{{ 'no_groups_for_level_date' | translate }}</p>
            </div>
          </ng-container>
        </label>
      </mat-radio-group>
    </div>
  </form>
</ng-template>
