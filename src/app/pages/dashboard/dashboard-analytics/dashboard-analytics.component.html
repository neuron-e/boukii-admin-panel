<vex-page-layout>
  <vex-secondary-toolbar current>
    <vex-breadcrumbs [crumbs]="[
      {icon:'home'},
      {text:'menu.home', title: true},
      {text:'dashboard', subtitle: true}
    ]" class="flex"></vex-breadcrumbs>

    <!-- Refresh button -->
    <button mat-icon-button (click)="refreshData()" [disabled]="loading" class="ml-auto">
      <mat-icon [class.animate-spin]="loading">refresh</mat-icon>
    </button>

    <!-- Last updated -->
    <span class="text-sm text-secondary ml-2" *ngIf="!loading && dashboardMetrics">
      {{ 'last_updated' | translate }}: {{ getLastUpdated() }}
    </span>
  </vex-secondary-toolbar>

  <vex-page-layout-content class="fullwidth">
    <!-- Loading skeleton -->
    <div *ngIf="loading" class="p-6">
      <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-4 gap-4">
        <div *ngFor="let i of [1,2,3,4]" class="card animate-pulse">
          <div class="h-32 bg-gray-200 rounded"></div>
        </div>
      </div>
    </div>
    <!-- Dashboard content -->
    <div *ngIf="!loading && dashboardMetrics" class="p-6">

      <!-- ROW 1: Bienvenida + Meteo + Quick Stats -->
      <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">

        <!-- Widget de Meteo y Bienvenida (MANTENER 100% INTACTO) -->
        <div class="lg:col-span-2">
          <vex-widget-assistant
            [date]="date"
            (dateEvent)="emitDate($event)">
          </vex-widget-assistant>
        </div>

        <!-- Quick Stats del dia -->
        <div class="card">
          <div class="p-6">
            <div class="flex items-center justify-between mb-4">
              <div>
                <h3 class="headline">{{ 'selected_date_summary' | translate }}</h3>
                <div class="text-xs text-secondary">{{ formatDateLabel(date) }}</div>
              </div>
              <mat-icon class="text-primary">event</mat-icon>
            </div>

            <div class="space-y-4">
              <div class="flex justify-between items-center">
                <span class="body-2 text-secondary">{{ 'bookings_for_date' | translate }}</span>
                <span class="subheading-2 font-medium text-primary">
                  {{ dashboardMetrics.quickStats.reservasDia }}
                </span>
              </div>

              <div class="flex justify-between items-center">
                <span class="body-2 text-secondary">{{ 'bookings_created_date' | translate }}</span>
                <span class="subheading-2 font-medium text-blue-600">
                  {{ dashboardMetrics.quickStats.reservasCreadasDia }}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- ROW 2: Resumen de Temporada -->
      <div class="card mb-6" *ngIf="seasonSummary?.executiveKpis">
        <div class="p-6">
          <div class="flex items-center justify-between mb-2">
            <h3 class="headline">{{ 'season_summary' | translate }}</h3>
            <span class="text-xs text-secondary">{{ getSeasonDateRange() }}</span>
          </div>
          <div class="text-xs text-secondary mb-4" *ngIf="seasonSummary?.season?.name">
            {{ seasonSummary.season.name }}
          </div>

          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
            <div class="flex justify-between items-center">
              <span class="body-2 text-secondary">{{ 'total_bookings' | translate }}</span>
              <span class="subheading-2 font-medium">{{ seasonSummary.executiveKpis.totalBookings || 0 }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="body-2 text-secondary">{{ 'total_clients' | translate }}</span>
              <span class="subheading-2 font-medium">{{ seasonSummary.executiveKpis.totalClients || 0 }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="body-2 text-secondary">{{ 'total_participants' | translate }}</span>
              <span class="subheading-2 font-medium">{{ seasonSummary.executiveKpis.totalParticipants || 0 }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="body-2 text-secondary">{{ 'revenue_expected' | translate }}</span>
              <span class="subheading-2 font-medium text-green-600">{{ formatCurrency(seasonSummary.executiveKpis.revenueExpected || 0) }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="body-2 text-secondary">{{ 'revenue_received' | translate }}</span>
              <span class="subheading-2 font-medium text-green-600">{{ formatCurrency(seasonSummary.executiveKpis.revenueReceived || 0) }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="body-2 text-secondary">{{ 'revenue_pending' | translate }}</span>
              <span class="subheading-2 font-medium text-orange-600">{{ formatCurrency(seasonSummary.executiveKpis.revenuePending || 0) }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="body-2 text-secondary">{{ 'collection_efficiency' | translate }}</span>
              <span class="subheading-2 font-medium">{{ formatPercentage(seasonSummary.executiveKpis.collectionEfficiency || 0) }}</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="body-2 text-secondary">{{ 'average_booking_value' | translate }}</span>
              <span class="subheading-2 font-medium">{{ formatCurrency(seasonSummary.executiveKpis.averageBookingValue || 0) }}</span>
            </div>
          </div>
        </div>
      </div>

      <!-- ROW 3: Actividades Proximas -->
      <div class="grid grid-cols-1 gap-6 mb-6">

        <!-- Lista de Proximas Actividades -->
        <div class="card">
          <div class="p-6">
            <div class="flex items-center justify-between mb-4">
              <h3 class="headline">{{ 'upcoming_activities' | translate }}</h3>
              <button mat-icon-button (click)="navigateToPlanner()">
                <mat-icon>schedule</mat-icon>
              </button>
            </div>

            <div class="space-y-3" *ngIf="upcomingActivities.length > 0; else noActivities">
              <div *ngFor="let activity of upcomingActivities"
                   class="flex items-center p-3 rounded-lg border border-divider hover:bg-hover cursor-pointer transition-colors"
                   (click)="navigateToBookings()">

                <div class="flex-shrink-0 w-12 h-12 rounded-full flex items-center justify-center mr-3"
                     [class.bg-green-100]="activity.status === 'confirmed'"
                     [class.bg-orange-100]="activity.status === 'warning'"
                     [class.bg-blue-100]="activity.status === 'pending'">
                  <mat-icon class="text-sm"
                           [class.text-green-600]="activity.status === 'confirmed'"
                           [class.text-orange-600]="activity.status === 'warning'"
                           [class.text-blue-600]="activity.status === 'pending'">
                    {{ activity.type === 'private' ? 'person' : 'group' }}
                  </mat-icon>
                </div>

                <div class="flex-grow min-w-0">
                  <div class="flex items-center justify-between">
                    <span class="font-medium truncate">{{ activity.clientName }}</span>
                    <span class="text-sm text-secondary">{{ activity.time }}</span>
                  </div>
                  <div class="text-sm text-secondary truncate">{{ activity.courseName }}</div>
                  <div class="text-xs text-secondary" *ngIf="activity.participantsCount">{{ 'participants' | translate }}: {{ activity.participantsCount }}</div>
                  <div class="text-xs" [ngClass]="getStatusColor(activity.status)" *ngIf="activity.monitor">
                    {{ activity.monitor }}
                  </div>
                  <div class="text-xs text-orange-600" *ngIf="activity.status === 'warning'">
                    {{ 'dashboard.alert_no_monitor' | translate }}
                  </div>
                </div>

                <mat-icon class="text-secondary flex-shrink-0" *ngIf="activity.status === 'warning'">
                  warning
                </mat-icon>
              </div>
            </div>

            <ng-template #noActivities>
              <div class="text-center py-8 text-secondary">
                <mat-icon class="text-6xl mb-4">event_available</mat-icon>
                <p>{{ 'no_activities_scheduled' | translate }}</p>
              </div>
            </ng-template>
          </div>
        </div>
      </div>

    </div>
  </vex-page-layout-content>
</vex-page-layout>