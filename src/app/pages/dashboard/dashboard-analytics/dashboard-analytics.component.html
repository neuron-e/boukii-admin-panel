<vex-page-layout>
  <vex-secondary-toolbar current>
    <vex-breadcrumbs
      [crumbs]="[
        { icon: 'home' },
        { text: 'dashboard.home' | translate, title: true }
      ]"
      class="flex-auto"
    ></vex-breadcrumbs>

    <div class="toolbar-actions">
      <button
        mat-icon-button
        (click)="refreshAll()"
        [disabled]="loading()"
        [matTooltip]="'common.refresh' | translate"
      >
        <mat-icon [class.animate-spin]="loading()">refresh</mat-icon>
      </button>
    </div>
  </vex-secondary-toolbar>

  <vex-page-layout-content class="p-6">
    <!-- Loading State -->
    <div *ngIf="loading()" class="loading-state">
      <mat-progress-bar mode="indeterminate" color="primary"></mat-progress-bar>
      <p class="loading-label">{{ 'common.loading' | translate }}</p>
    </div>

    <!-- Dashboard Shell -->
    <div class="dashboard-shell" *ngIf="!loading()">
      <!-- ========== HERO SECTION ========== -->
      <section class="hero-section">
        <div class="hero-grid">

          <!-- Welcome Card -->
          <div class="hero-card welcome-card">
            <div class="welcome-header">
              <div>
                <h1 class="welcome-title">{{ 'dashboard.welcome_back' | translate }}, {{ userName }}!</h1>
                <mat-form-field appearance="outline" class="date-picker" color="primary">
                  <mat-icon matPrefix>event</mat-icon>
                  <input
                    matInput
                    [matDatepicker]="dashboardDatepicker"
                    [value]="selectedDate()"
                    (dateChange)="onDateChange($event)"
                  />
                  <mat-datepicker-toggle matSuffix [for]="dashboardDatepicker"></mat-datepicker-toggle>
                  <mat-datepicker #dashboardDatepicker></mat-datepicker>
                </mat-form-field>
                <p class="welcome-weekday">{{ weekdayName }}</p>
              </div>
            </div>

            <!-- Weather Section -->
            <div class="weather-section">
              <h3 class="section-title">{{ 'dashboard.weather' | translate }}</h3>
              <div class="weather-timeline" *ngIf="weatherDays().length > 0; else weatherFallback">
                <div class="weather-slot" *ngFor="let slot of weatherDays().slice(0, 6)">
                  <span class="weather-time">{{ slot.timeLabel || formatWeatherDate(slot) }}</span>
                  <img *ngIf="slot.icon" class="weather-icon" [src]="getWeatherIconPath(slot.icon)" [alt]="slot.phrase || ''" />
                  <span class="weather-temp" *ngIf="slot.maxTemp !== undefined || slot.minTemp !== undefined">
                    {{ slot.maxTemp ?? slot.minTemp ?? '-' }}&deg;
                  </span>
                </div>
              </div>
              <ng-template #weatherFallback>
                <div class="weather-timeline placeholder">
                  <div class="weather-slot" *ngFor="let slot of weatherPlaceholderSlots">
                    <span class="weather-time">--:--</span>
                    <span class="weather-icon-placeholder"></span>
                    <span class="weather-temp">--</span>
                  </div>
                </div>
              </ng-template>
            </div>
          </div>

          <!-- System Admin Card -->
          <div class="hero-card system-admin-card">
            <!-- Header con icono -->
            <div class="system-header">
              <div class="system-icon-pill">
                <mat-icon class="header-icon">settings</mat-icon>
              </div>
              <div>
                <h3>{{ 'dashboard.system_administration' | translate }}</h3>
                <p class="subtitle">{{ 'dashboard.background_tasks_status' | translate }}</p>
              </div>
            </div>

            <!-- 4 tarjetas horizontales -->
            <div class="system-cards-row">
              <!-- Pending Payments -->
              <div class="system-metric-card clickable" (click)="openSystemDetails('pending_payments')">
                <span class="status-dot" [ngClass]="getStatusDotClass(systemStats()?.pending_payments || 0)"></span>
                <mat-icon class="card-icon">credit_card</mat-icon>
                <span class="card-label">{{ 'dashboard.pending_payments' | translate | uppercase }}</span>
                <strong class="card-value">{{ systemStats()?.pending_payments || 0 }}</strong>
              </div>

              <!-- Course Overbooking -->
              <div class="system-metric-card clickable" (click)="openSystemDetails('overbooked_groups')">
                <span class="status-dot" [ngClass]="getStatusDotClass(systemStats()?.overbookings || 0)"></span>
                <mat-icon class="card-icon">warning</mat-icon>
                <span class="card-label">{{ 'dashboard.course_overbooking' | translate | uppercase }}</span>
                <strong class="card-value">{{ systemStats()?.overbookings || 0 }}</strong>
              </div>

              <!-- Unassigned Courses -->
              <div class="system-metric-card clickable" (click)="openSystemDetails('unassigned_all')">
                <span class="status-dot" [ngClass]="getStatusDotClass(systemStats()?.unassigned_courses || 0)"></span>
                <mat-icon class="card-icon">assignment</mat-icon>
                <span class="card-label">{{ 'dashboard.unassigned_courses' | translate | uppercase }}</span>
                <strong class="card-value">{{ systemStats()?.unassigned_courses || 0 }}</strong>
              </div>

              <!-- Free Monitors -->
              <div class="system-metric-card">
                <span class="status-dot" [ngClass]="getStatusDotClass(operations()?.free_monitors || 0)"></span>
                <mat-icon class="card-icon">people</mat-icon>
                <span class="card-label">{{ 'dashboard.free_monitors' | translate | uppercase }}</span>
                <strong class="card-value">{{ operations()?.free_monitors || 0 }}</strong>
              </div>
            </div>
          </div>
        </div>
      </section>

      <ng-template #systemDetailDialog>
        <div class="system-detail-modal">
          <div class="modal-header">
            <div>
              <h3>{{ systemDetailTitle }} <span class="count">({{ systemDetailItems().length }})</span></h3>
              <p>{{ formatShortDate(selectedDate()) }}</p>
            </div>
            <button mat-icon-button [mat-dialog-close]="true">
              <mat-icon>close</mat-icon>
            </button>
          </div>

          <div *ngIf="systemDetailLoading()" class="modal-loading">
            <mat-progress-bar mode="indeterminate"></mat-progress-bar>
          </div>

          <div *ngIf="!systemDetailLoading()" class="system-detail-body">
            <div class="modal-empty" *ngIf="systemDetailItems().length === 0">
              {{ systemDetailEmptyLabel }}
            </div>

            <div class="system-detail-tables" *ngIf="systemDetailItems().length > 0">
              <div class="system-detail-section" *ngFor="let section of systemDetailSections">
                <h4 class="section-title">{{ section.title }} <span class="count">({{ section.items.length }})</span></h4>

                <div class="dashboard-table-card" *ngIf="section.items.length">
                  <div class="dashboard-table-container">
                  <table *ngIf="section.type === 'pending_payments'">
                    <thead>
                      <tr>
                        <th>{{ 'booking' | translate }}</th>
                        <th>{{ 'dashboard.client' | translate }}</th>
                        <th>{{ 'dashboard.participants' | translate }}</th>
                        <th>{{ 'dashboard.time' | translate }}</th>
                        <th>{{ 'amount' | translate }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of section.items">
                        <td>#{{ item.booking_id }}</td>
                        <td>{{ item.client_name || '-' }}</td>
                        <td>{{ item.participants ?? '-' }}</td>
                        <td>{{ item.time_label || '-' }}</td>
                        <td>{{ formatCurrency(item.total_due ?? 0) }}</td>
                      </tr>
                    </tbody>
                  </table>

                  <table *ngIf="section.type === 'overbooked_groups'">
                    <thead>
                      <tr>
                        <th>{{ 'dashboard.group_courses' | translate }}</th>
                        <th>{{ 'dashboard.level' | translate }}</th>
                        <th>{{ 'dashboard.participants' | translate }}</th>
                        <th>{{ 'dashboard.capacity_limit' | translate }}</th>
                        <th>{{ 'dashboard.time' | translate }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of section.items">
                        <td>{{ item.course_name }}</td>
                        <td>{{ getGroupSubgroupLabel(item) }}</td>
                        <td>{{ item.participants ?? '-' }}</td>
                        <td>{{ item.max_participants ?? '-' }}</td>
                        <td>{{ item.time_label || '-' }}</td>
                      </tr>
                    </tbody>
                  </table>

                  <table *ngIf="section.type === 'unassigned_groups'">
                    <thead>
                      <tr>
                        <th>{{ 'dashboard.group_courses' | translate }}</th>
                        <th>{{ 'dashboard.level' | translate }}</th>
                        <th>{{ 'dashboard.participants' | translate }}</th>
                        <th>{{ 'dashboard.time' | translate }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of section.items">
                        <td>{{ item.course_name }}</td>
                        <td>{{ getGroupSubgroupLabel(item) }}</td>
                        <td>{{ item.participants ?? '-' }}</td>
                        <td>{{ item.time_label || '-' }}</td>
                      </tr>
                    </tbody>
                  </table>

                  <table *ngIf="section.type === 'unassigned_private'">
                    <thead>
                      <tr>
                        <th>{{ 'dashboard.private_courses' | translate }}</th>
                        <th>{{ 'dashboard.client' | translate }}</th>
                        <th>{{ 'dashboard.participants' | translate }}</th>
                        <th>{{ 'dashboard.time' | translate }}</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr *ngFor="let item of section.items">
                        <td>{{ item.course_name || '-' }}</td>
                        <td>{{ item.client_name || '-' }}</td>
                        <td>{{ item.participants ?? '-' }}</td>
                        <td>{{ item.time_label || '-' }}</td>
                      </tr>
                    </tbody>
                  </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </ng-template>


      <!-- ========== TODAY'S OPERATIONS SECTION ========== -->
      <section class="operations-section">
        <div class="operations-wrapper">
          <div class="section-header compact">
            <div>
              <h3>{{ 'dashboard.operations_for_date' | translate:{ date: formatShortDate(selectedDate()) } }}</h3>
              <p>{{ 'dashboard.todays_operations_subtitle' | translate }}</p>
            </div>
          </div>

          <div class="operations-grid-large">
            <div class="operations-card-large" [class.occupancy-card-large]="card.isOccupancy" *ngFor="let card of todaysOperationsCards">
              <mat-icon class="card-icon">{{ card.icon }}</mat-icon>
              <div class="card-content">
                <span class="value">{{ card.value }}</span>
                <span class="label">{{ card.label }}</span>
                <span class="caption" *ngIf="card.caption">{{ card.caption }}</span>
              </div>

              <div class="badge-row" *ngIf="card.badges?.length" [matTooltip]="card.tooltip || ''" [matTooltipDisabled]="!card.tooltip">
                <span class="badge" [ngClass]="badge.tone" *ngFor="let badge of card.badges">
                  <img *ngIf="badge.iconUrl; else badgeIcon" [src]="badge.iconUrl" [alt]="badge.label || ''" />
                  <ng-template #badgeIcon>
                    <mat-icon>{{ badge.icon }}</mat-icon>
                  </ng-template>
                  <span>{{ badge.value }}</span>
                </span>
              </div>

            </div>
          </div>
        </div>
      </section>

      <!-- ========== COURSES & CAPACITY SECTION ========== -->
      <section class="courses-section">
        <div class="courses-wrapper">
          <div class="section-header">
            <div class="header-with-icon">
              <mat-icon class="section-icon">trending_up</mat-icon>
              <h3>{{ 'dashboard.courses_capacity_for_date' | translate:{ date: formatShortDate(selectedDate()) } }}</h3>
            </div>
          </div>

          <div class="capacity-overall dark-bar">
            <div class="capacity-header">
              <span class="capacity-label">{{ 'dashboard.overall_capacity_usage' | translate }}</span>
              <span class="capacity-value">{{ overallCapacityPercent }}%</span>
            </div>
            <mat-progress-bar
              mode="determinate"
              [value]="overallCapacityPercent"
              color="primary"
              class="capacity-bar"
            ></mat-progress-bar>
          </div>

          <div class="course-columns">
            <div class="course-column panel-group">
              <div class="column-header">
                <div class="column-title">
                  <mat-icon class="column-icon">groups</mat-icon>
                  <h4>{{ 'dashboard.group_courses' | translate }}</h4>
                </div>
              </div>

              <div class="column-stats">
                <div class="stat">
                  <span class="stat-label">{{ 'dashboard.participants' | translate }}</span>
                  <span class="stat-value">{{ totalGroupParticipants }}</span>
                </div>
                <div class="stat">
                  <span class="stat-label">{{ 'dashboard.groups' | translate }}</span>
                  <span class="stat-value">{{ groupSummary()?.groups ?? groupCourses().meta.total }}</span>
                </div>
              </div>

              <div class="panel-spot-summary">
                <span class="panel-spot-label">{{ 'dashboard.spots_sold_available' | translate }}</span>
                <div class="panel-spot-value">
                  <span>{{ (groupSummary()?.spots_sold ?? 0) | number:'1.0-1' }}</span>
                  <span class="panel-spot-sep">/</span>
                  <span>{{ (groupSummary()?.spots_available ?? 0) | number:'1.0-1' }}</span>
                  <span class="panel-spot-unit">{{ 'dashboard.spots' | translate }}</span>
                </div>
              </div>

              <div class="panel-bar">
                <div class="panel-bar-header">
                  <span class="panel-bar-label">{{ 'dashboard.capacity_usage' | translate }}</span>
                  <span class="panel-bar-percent">{{ groupCapacityUsage }}%</span>
                </div>
                <mat-progress-bar mode="determinate" [value]="groupCapacityUsage" class="panel-progress"></mat-progress-bar>
              </div>

              <div class="panel-remaining">
                {{ (groupSummary()?.spots_remaining ?? 0) | number:'1.0-1' }} {{ 'dashboard.spots_remaining' | translate }}
              </div>

              <div class="panel-subtitle">{{ 'dashboard.todays_group_courses' | translate }}</div>

              <div class="course-list" (scroll)="onGroupScroll($event)">
                <div *ngIf="groupCourses().data.length === 0" class="empty-state">
                  {{ 'dashboard.no_group_courses_today' | translate }}
                </div>

                <div class="course-row" *ngFor="let course of groupCourses().data">
                <div class="course-row-header">
                  <span class="course-row-title">
                    <span class="course-type-icon group">
                      <img *ngIf="course.course_icon; else groupCourseFallback" [src]="course.course_icon" alt="" />
                      <ng-template #groupCourseFallback>G</ng-template>
                    </span>
                    {{ course.course_name }}
                  </span>
                </div>
                <div class="course-row-meta">
                  <span>{{ 'dashboard.groups' | translate }}: <strong>{{ course.groups_count }}</strong></span>
                  <span>{{ 'dashboard.participants' | translate }}: <strong>{{ course.participants }}</strong></span>
                </div>
                <div class="course-row-meta">
                  <span>{{ 'dashboard.monitor' | translate }}: <strong>{{ course.assigned_monitors }}</strong></span>
                  <span *ngIf="course.pending_payments > 0">{{ 'dashboard.pending' | translate }}: {{ course.pending_payments }}</span>
                </div>
                <div class="course-row-meta">
                  <span>{{ 'dashboard.date' | translate }}: <strong>{{ formatShortDate(selectedDate()) }}</strong></span>
                  <span *ngIf="course.time_label">{{ 'dashboard.time' | translate }}: <strong>{{ course.time_label }}</strong></span>
                </div>
              </div>
              </div>
            </div>

            <div class="course-column panel-private">
              <div class="column-header">
                <div class="column-title">
                  <mat-icon class="column-icon">person</mat-icon>
                  <h4>{{ 'dashboard.private_lessons' | translate }}</h4>
                </div>
              </div>

              <div class="column-stats">
                <div class="stat">
                  <span class="stat-label">{{ 'dashboard.participants' | translate }}</span>
                  <span class="stat-value">{{ totalPrivateLessons }}</span>
                </div>
                <div class="stat">
                  <span class="stat-label">{{ 'dashboard.courses_today' | translate }}</span>
                  <span class="stat-value">{{ privateSummary()?.courses_today ?? privateCourses().meta.total }}</span>
                </div>
              </div>

              <div class="panel-spot-summary">
                <span class="panel-spot-label">{{ 'dashboard.hours_sold_available' | translate }}</span>
                <div class="panel-spot-value">
                  <span>{{ (privateSummary()?.hours_sold ?? 0) | number:'1.0-1' }}</span>
                  <span class="panel-spot-sep">/</span>
                  <span>{{ (privateSummary()?.hours_available ?? 0) | number:'1.0-1' }}</span>
                  <span class="panel-spot-unit">{{ 'dashboard.hours' | translate }}</span>
                </div>
                <div class="panel-caption">{{ 'dashboard.based_on_monitors_hours' | translate }}</div>
              </div>

              <div class="panel-bar">
                <div class="panel-bar-header">
                  <span class="panel-bar-label">{{ 'dashboard.capacity_usage' | translate }}</span>
                  <span class="panel-bar-percent">{{ privateCapacityUsage }}%</span>
                </div>
                <mat-progress-bar mode="determinate" [value]="privateCapacityUsage" class="panel-progress"></mat-progress-bar>
              </div>

              <div class="panel-remaining">
                {{ (privateSummary()?.hours_remaining ?? 0) | number:'1.0-1' }} {{ 'dashboard.hours_remaining' | translate }}
              </div>

              <div class="panel-subtitle">{{ 'dashboard.todays_private_lessons' | translate }}</div>

              <div class="course-list" (scroll)="onPrivateScroll($event)">
                <div *ngIf="privateCourses().data.length === 0" class="empty-state">
                  {{ 'dashboard.no_private_courses_today' | translate }}
                </div>

                <div class="course-row private-row" *ngFor="let course of privateCourses().data">
                  <div class="course-row-header">
                    <span class="course-row-title">
                      <span class="course-type-icon private">
                        <img *ngIf="course.course_icon; else privateCourseFallback" [src]="course.course_icon" alt="" />
                        <ng-template #privateCourseFallback>P</ng-template>
                      </span>
                      {{ course.course_name }}
                    </span>
                    <span class="course-tag" [class.unpaid]="!course.is_paid">
                      {{ course.is_paid ? ('common.paid' | translate) : ('common.unpaid' | translate) }}
                    </span>
                  </div>
                <div class="course-row-meta">
                  <span *ngIf="course.client_name">{{ course.client_name }}</span>
                  <span *ngIf="course.time_label">{{ course.time_label }}</span>
                </div>
                <div class="course-row-meta">
                  <span>{{ 'dashboard.monitor' | translate }}: <strong>{{ course.monitor_name }}</strong></span>
                  <span>{{ 'dashboard.participants' | translate }}: <strong>{{ course.participants }}</strong></span>
                </div>
                <div class="course-row-meta">
                  <span *ngIf="course.duration_hours">{{ 'dashboard.hours' | translate }}: <strong>{{ course.duration_hours | number:'1.0-1' }}</strong></span>
                  <span *ngIf="course.date">{{ 'dashboard.date' | translate }}: <strong>{{ course.date }}</strong></span>
                </div>
              </div>
            </div>
          </div>
          </div>
        </div>
      </section>

      <!-- ========== 7-DAY FORECAST SECTION ========== -->
      <section class="forecast-section" *ngIf="forecastDays().length > 0">
        <div class="card forecast-card">
          <div class="forecast-card-header">
            <div>
              <h3>{{ 'dashboard.seven_day_forecast' | translate }}</h3>
              <p>{{ 'dashboard.forecast_subtitle' | translate }}</p>
            </div>
          </div>

          <div class="forecast-list">
            <div class="forecast-row" *ngFor="let day of forecastDays()">
              <div class="forecast-date">
                <strong>{{ formatForecastLabel(day) }}</strong>
                <span>{{ formatForecastDate(day) }}</span>
              </div>

              <div class="forecast-metrics">
                <div class="forecast-metric">
                  <span class="metric-label">{{ 'dashboard.courses' | translate }}</span>
                  <span class="metric-value">{{ day.courses }}</span>
                </div>
                <div class="forecast-metric">
                  <span class="metric-label">{{ 'dashboard.private_courses' | translate }}</span>
                  <span class="metric-value">{{ day.private_courses }}</span>
                </div>
                <div class="forecast-metric">
                  <span class="metric-label">{{ 'dashboard.group_courses' | translate }}</span>
                  <span class="metric-value">{{ day.group_courses }}</span>
                </div>
                <div class="forecast-metric">
                  <span class="metric-label">{{ 'dashboard.participants' | translate }}</span>
                  <span class="metric-value">{{ day.participants }}</span>
                </div>
                <div class="forecast-metric">
                  <span class="metric-label">{{ 'dashboard.assigned_monitors' | translate }}</span>
                  <span class="metric-value">{{ day.assigned_monitors }}</span>
                </div>
                <div class="forecast-metric">
                  <span class="metric-label">{{ 'dashboard.unassigned_courses' | translate }}</span>
                  <span class="metric-value">{{ day.unassigned }}</span>
                </div>
                <div class="forecast-metric">
                  <span class="metric-label">{{ 'dashboard.free_monitors' | translate }}</span>
                  <span class="metric-value">{{ day.free_monitors }}</span>
                </div>
                <div class="forecast-metric">
                  <span class="metric-label">{{ 'common.unpaid' | translate }}</span>
                  <span class="metric-value">{{ day.unpaid }}</span>
                </div>
                <div class="forecast-metric">
                  <span class="metric-label">{{ 'dashboard.revenue' | translate }}</span>
                  <span class="metric-value">{{ formatCurrency(day.expected_revenue, forecastCurrency()) }}</span>
                </div>
              </div>

              <div class="forecast-track-container">
                <div class="forecast-track">
                  <div
                    class="forecast-track-fill"
                    [style.width.%]="getForecastPercent(day)"
                  ></div>
                </div>
                <span class="forecast-percent">{{ getForecastPercent(day) | number: '1.0-0' }}%</span>
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- ========== COMMERCIAL PERFORMANCE SECTION (TEMP DISABLED) ========== -->
      <!--
      <section class="commercial-section" *ngIf="commercial()">
        <div class="section-header">
          <div>
            <h3>{{ 'dashboard.commercial_performance' | translate }}</h3>
            <p>{{ 'dashboard.commercial_subtitle' | translate }}</p>
          </div>
        </div>

        <div class="card">
          <div class="commercial-grid">
            <div class="commercial-card" *ngFor="let card of commercialCards">
              <span class="label">{{ card.label }}</span>
              <span class="value">{{ card.value }}</span>
            </div>
          </div>

          <div class="summary-row">
            <span>
              {{ 'dashboard.trend' | translate }}:
              <span class="trend-chip" [ngClass]="commercial()!.trend">
                <mat-icon>{{ getTrendIcon(commercial()!.trend) }}</mat-icon>
                {{ getTrendLabel(commercial()!.trend) }}
              </span>
            </span>
          </div>

          <div class="sub-summary">
            <span>
              {{ 'dashboard.pending_payments' | translate }}:
              <strong>{{ formatCurrency(commercial()!.pending_payments, commercial()!.currency) }}</strong>
            </span>
            <span>
              {{ 'dashboard.expected_revenue_today' | translate }}:
              <strong>{{ formatCurrency(commercial()!.expected_revenue_today, commercial()!.currency) }}</strong>
            </span>
            <span>
              {{ 'dashboard.total_bookings_today' | translate }}:
              <strong>{{ commercial()!.total_bookings_today }}</strong>
            </span>
            <span>
              {{ 'dashboard.boukii_revenue_estimate' | translate }}:
              <strong>{{ formatCurrency(commercial()!.boukii_revenue_estimate, commercial()!.currency) }}</strong>
            </span>
          </div>
        </div>
      </section>
      -->

    </div>
  </vex-page-layout-content>
</vex-page-layout>
