<mat-dialog-actions align="end">
  <button mat-button mat-dialog-close>X</button>
</mat-dialog-actions>
<div [@stagger]="true"class="p-gutter container"style="max-width: none" *ngIf="!loading">
  <div class="flex flex-col sm:flex-row gap-4" style="width: 100%;float:left;padding: 2%">
    <div @fadeInUp class="card flex-auto">
      <mat-tab-group>
        <mat-tab label="Cours">
          <mat-card style="padding: 3% 5% 0 5%;">
            <mat-card-header style="display:block">
              <div style="float: left; width: 100%;">
                <div style="float: left;width: 50%;">
                  <div style="float: left; margin-right: 2%">
                    <img [src]="'https://school.boukii.com/assets/icons/collectif_'+ defaults?.sport?.name.toLowerCase() +'2x.png'" width="100" height="100" *ngIf="defaults.course_type === 1">
                    <img [src]="'https://school.boukii.com/assets/icons/prive_'+ defaults?.sport?.name.toLowerCase() +'2x.png'" width="100" height="100" *ngIf="defaults.course_type === 2">
                  </div>
                  <div style="float: left; width: 75%;">
                    <p><strong>{{defaults.name}}</strong></p>
                    <p>{{defaults.course_type === 1 ? 'Collectif' : 'Privee'}}  {{defaults?.sport?.name}}</p>
                    <p>{{defaults?.station?.name}}</p>
                  </div>

                  <div style="float: right;" style="float: right;cursor:pointer" (click)="goTo('/courses/update/'+this.id)">
                    <i class="fa fa-edit" style="color: #ff3085;font-size: 30px;"></i>
                  </div>
                </div>
                <div style="float: left;width: 50%;">
                  <div style="float:right;width: 100%">

                    <div style="float: right;margin: 0 0 0 25px;">
                      <mat-slide-toggle [checked]="true">
                        {{'options' | translate}}
                      </mat-slide-toggle>
                    </div>
                    <div style="float: right;margin: 0;">
                      <mat-slide-toggle [checked]="true">
                        Online
                      </mat-slide-toggle>
                    </div>
                    <div style="float: right;margin: 0 25px 0 0;">
                      <mat-slide-toggle [checked]="true">
                        {{'status' | translate}}
                      </mat-slide-toggle>
                    </div>
                  </div>
                </div>
              </div>

            </mat-card-header>
            <mat-card-content>

              <div style="float: left; width: 47%;margin: 2% 3% 0 0;">
                <img [src]="defaults.image !== null ? defaults.image : '../../../../assets/img/defult.jpg'">
                <ul style="margin: 2% 0 0 0;" *ngIf="defaults.course_type === 2">
                  <li style="margin: 0 0 2% 0"><strong>{{'dates' | translate}}</strong></li>
                  <li>{{parseDateToDay(defaults.course_dates[0].date, 'YYYY-MM-DD', 'dddd')}}, {{parseDateToDay(defaults.course_dates[0].date, 'YYYY-MM-DD', 'LL')}}
                    <i style="text-align: right;float:right">{{parseDateToDay(defaults.course_dates[0].hour_start, 'HH:mm:ss', 'HH:mm')}}h - {{parseDateToDay(defaults.course_dates[0].hour_end, 'HH:mm:ss', 'HH:mm')}}h</i>
                  </li>
                  <li>{{parseDateToDay(defaults.course_dates[defaults.course_dates.length-1].date, 'YYYY-MM-DD', 'dddd')}}, {{parseDateToDay(defaults.course_dates[defaults.course_dates.length-1].date, 'YYYY-MM-DD', 'LL')}}
                    <i style="text-align: right;float:right">{{parseDateToDay(defaults.course_dates[defaults.course_dates.length-1].hour_start, 'HH:mm:ss', 'HH:mm')}}h - {{parseDateToDay(defaults.course_dates[defaults.course_dates.length-1].hour_end, 'HH:mm:ss', 'HH:mm')}}h</i>
                  </li>
                </ul>

                <ul style="margin: 2% 0 0 0;" *ngIf="defaults.course_type === 1">
                  <li style="margin: 0 0 2% 0"><strong>{{'dates' | translate}}</strong></li>
                  <li *ngFor="let item of defaults.course_dates">{{parseDateToDay(item.date, 'YYYY-MM-DD', 'dddd')}}, {{parseDateToDay(item.date, 'YYYY-MM-DD', 'LL')}} <i style="text-align: right;float:right">{{parseDateToDay(item.hour_start, 'HH:mm:ss', 'HH:mm')}}h - {{parseDateToDay(item.hour_end, 'HH:mm:ss', 'HH:mm')}}h</i></li>
                </ul>
              </div>
              <div style="width:50%; margin-top:2%;float:left">
                <div style="width: 100%;">
                  <p style="float: left;width: 80%;text-align: left;"><b>{{'summary' | translate}}</b></p>
                  <p style="float: left;width: 20%;text-align: right;"><b>{{'price' | translate}}</b></p>
                </div>
                <div style="width: 100%;">
                  <p style="float: left;width: 50%;text-align: left;" [innerHTML]="defaults.short_description">

                  </p>
                  <p style="float: left;width: 50%;text-align: right;color:#ff3085"><b>{{defaults.price}}</b> CHF</p>
                </div>
              </div>
              <div style="width:50%; margin-top:2%;float:left">
                <div style="width: 100%;">
                  <p style="float: left;width: 80%;text-align: left;"><b>{{'desc' | translate}}</b></p>
                  <p style="float: left;width: 20%;text-align: right;"><b>{{'age' | translate}}</b></p>
                </div>
                <div style="width: 100%;">
                  <p style="float: left;width: 50%;text-align: left;" [innerHTML]="defaults.description">
                  </p>
                  <p style="float: left;width: 50%;text-align: right;" *ngIf="defaults.course_type === 2">{{'from' | translate}} {{defaults.age_min}} {{'to' | translate}} {{defaults.age_max}} años</p>
                  <p style="float: left;width: 50%;text-align: right;" *ngIf="defaults.course_type === 1">FLEX</p>
                </div>
              </div>

              <div style="width:50%; margin-top:2%;float:left">
                <div class="flex flex-col sm:flex-row gap-2 sm:gap-6">

                  <div class="flex-auto">

                    <label for="dateFrom">{{'courses.date_reservable' | translate}}</label>
                    <mat-form-field style="width: 100%">

                      <input matInput id="dateFrom" [value]="defaults.date_start_res | date: 'dd/MM/YYYY'" [readonly]="true">
                    </mat-form-field>
                  </div>
                  <div class="flex-auto">

                    <label for="dateTo">{{'courses.date_reservable_to' | translate}}</label>
                    <mat-form-field style="width: 100%">

                      <input matInput id="dateTo" [value]="defaults.date_end_res | date: 'dd/MM/YYYY'" [readonly]="true">
                    </mat-form-field>
                  </div>
                </div>

                <div class="flex flex-col sm:flex-row gap-2 sm:gap-6">
                  <div class="flex-auto" style="width: 50%; float:left">
                    <label for="duration">{{'duration' | translate}}</label>
                    <mat-form-field style="width: 100%">

                      <input id="duration" matInput required type="text" placeholder="DURÉE" [value]="defaults.duration ? defaults.duration : 'FLEXIBLE'" [readonly]="true">
                    </mat-form-field>
                  </div>
                  <div class="flex-auto" style="width: 50%; float:left">
                    <label for="participants">{{'max_pax' | translate}}</label>

                    <mat-form-field style="width: 100%">
                      <mat-label>{{'max_pax' | translate}}</mat-label>
                      <input id="participants" matInput required type="number" [value]="defaults.max_participants" [(ngModel)]="defaults.max_participants" [readonly]="true">
                    </mat-form-field>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </mat-tab>

        <mat-tab label="{{'level' | translate }}" *ngIf="defaults.course_type === 1">

          <mat-card style="padding: 0 3%;">
            <mat-card-header style="display:block">
              <div style="width: 100%;float:left;">
                <mat-card-title style="float: left;width: 35%;">{{'course_detail' | translate }}</mat-card-title>
                <div style="float:right;width: 65%">
                  <div style="float: right;margin: 0 0 0 25px;">
                    <mat-slide-toggle [checked]="true">
                      {{'options' | translate }}
                    </mat-slide-toggle>
                  </div>
                  <div style="float: right;margin: 0;">
                    <mat-slide-toggle [checked]="true">
                      Online
                    </mat-slide-toggle>
                  </div>
                  <div style="float: right;margin: 0 25px 0 0;">
                    <mat-slide-toggle [checked]="true">
                      {{'status' | translate }}
                    </mat-slide-toggle>
                  </div>
                </div>
              </div>
              <mat-divider style="float: left;width: 100%;margin: 2% 0 0 0;"></mat-divider>
            </mat-card-header>
            <mat-card-content style="margin-top: 5%;">
              <button mat-raised-button color="accent" style="color: #fff;background: #f53d7c;padding: 1%;width: 15%;border-radius: 0;height: 50px;margin: 0 0 1% 0;float: right;" (click)="save()">{{'save_changes' | translate}}</button>

              <div class="flex flex-col sm:flex-row gap-4" style="width: 100%;float:left;" *ngIf="!loading">
                <div @fadeInUp class="card flex-auto">
                  <mat-card style="padding: 0 3%;">
                    <mat-card-content style="margin-top: 5%;">

                      <div style="width: 100%;float:left;">

                        <ng-container *ngFor="let colorKey of colorKeys">

                          <div  *ngFor="let groupLevel of groupedByColor[colorKey]; let groupIndex = index">
                            <i class="fa fa-edit" style="color: #ff3085;font-size: 30px;float:right;cursor:pointer" *ngIf="!groupLevel.visible && groupLevel.active" (click)="groupLevel.visible = true; checkAvailableMonitors(groupLevel);"></i>
                            <i class="fa fa-close" style="color: #ff3085;font-size: 30px;float:right;cursor:pointer" *ngIf="groupLevel.visible && groupLevel.active" (click)="groupLevel.visible = false"></i>

                            <div style="float: left; width: 100%;margin-top:3%">
                              <div style="float: left;width: 10%;border-radius: 11%;height: 100px;padding: 2%;color: #fff;text-align: center;"
                                  [title]="disableActive(groupLevel) ? 'Este grupo no puede eliminarse porque tiene reservas asociadas' : ''">
                                <mat-slide-toggle (change)="activeGroup($event, groupLevel)" [disabled]="disableActive(groupLevel)" [checked]="groupLevel.active"></mat-slide-toggle>
                              </div>
                              <div style="float: left;width: 16%;">
                                <div style="width:100%;text-align: center;border-radius:10px;height: 100px;padding: 2%;color: #fff;" [style.background-color]="colorKey">
                                  {{groupLevel.annotation}} - {{groupLevel.name}}
                                </div>
                                <mat-form-field class="flex-auto" style="width: 100%; margin-top: 10%;" *ngIf="groupLevel.active && groupLevel.visible">
                                  <mat-select placeholder="Nivel minimo del profesor" (selectionChange)="setLevelTeacher($event, groupLevel)" [value]="calculateMonitorLevel(groupLevel)">
                                    <mat-option *ngFor="let item of levels" [value]="item">
                                      {{ item.league }} - {{ item.name }}
                                    </mat-option>
                                  </mat-select>
                                </mat-form-field>
                              </div>
                              <div  style="float: left;width: 16%;margin: 0 0 0 2%;" *ngIf="groupLevel.active && groupLevel.visible">
                                <div style="width:100%;border-radius: 0;height: 100px;padding: 2%;color: #000;background: #e6e6e6;text-align: center;border-radius:10px" >
                                  {{'groups' | translate}} {{defaults?.course_dates[0]?.groups[groupIndex]?.subgroups.length}}g
                                </div>
                                <div style="width: 100%; margin-top: 10%;height: 60px">
                                  <button mat-button color="accent" style="width: 100%;border-radius: 5px;color:#fff;background: #ff3085;height: 100%" (click)="addSubGroup(groupLevel)">Añadir subgrupo</button>
                                </div>
                              </div>

                              <div  style="float: left;width: 16%;margin: 0 0 0 2%;" *ngIf="groupLevel.active && groupLevel.visible">
                                <div style="width:100%;border-radius: 0;height: 100px;padding: 2%;color: #000;background: #e6e6e6;text-align: center;border-radius:10px" >
                                  {{'age' | translate}}
                                </div>
                                <form [formGroup]="rangeForm" novalidate>
                                  <mat-form-field style="width: 45%; margin-top: 10%;margin-right: 10%">
                                    <input type="number" placeholder="Min." aria-label="Number" matInput [min]="0" (blur)="setMinAge($event, groupLevel)" [value]="groupLevel.age_min"
                                    [value]="calculateAgeMin(groupLevel)"/>
                                    <mat-error *ngIf="minAge.errors?.['min']">
                                      {{'courses.errors.min_age_levels' | translate}}
                                    </mat-error>
                                    <mat-error *ngIf="minAge.errors?.['required']">
                                      {{'mandatory' | translate}}
                                    </mat-error>
                                  </mat-form-field>
                                  <mat-form-field style="width: 45%; margin-top: 10%">
                                    <input type="number" placeholder="Max" aria-label="Number" matInput [min]="0" (blur)="setMaxAge($event, groupLevel)" [value]="groupLevel.age_max"
                                    [value]="calculateAgeMax(groupLevel)"/>
                                    <mat-error *ngIf="maxAge.errors?.['ageRange']">
                                      {{'courses.errors.max_age_range' | translate}}
                                    </mat-error>
                                    <mat-error *ngIf="maxAge.errors?.['max']">
                                      {{'courses.errors.max_age_levels' | translate}}
                                    </mat-error>
                                    <mat-error *ngIf="maxAge.errors?.['required']">
                                      {{'mandatory' | translate}}
                                    </mat-error>
                                  </mat-form-field>
                                </form>
                              </div>
                              <div  style="float: left;width: 16%;margin: 0 0 0 2%;" *ngIf="groupLevel.active && groupLevel.visible">
                                <div style="width:100%;border-radius: 0;height: 100px;padding: 2%;color: #000;background: #e6e6e6;text-align: center;border-radius:10px" >
                                  Duracion<br>
                                  {{calculateFormattedDuration(defaults.course_dates[daySelectedIndex].hour_start, defaults.course_dates[daySelectedIndex].hour_end)}}
                                </div>
                                <mat-form-field style="width: 100%; margin-top: 10%;margin-right: 10%">
                                  <input type="text" placeholder="Duración" aria-label="Number" matInput
                                    [value]="calculateFormattedDuration(defaults.course_dates[daySelectedIndex].hour_start, defaults.course_dates[daySelectedIndex].hour_end)" [readonly]="true"/>
                                </mat-form-field>
                              </div>
                              <div  style="float: left;width: 16%;margin: 0 0 0 2%;" *ngIf="groupLevel.active && groupLevel.visible">
                                <div style="width:100%;border-radius: 0%;height: 100px;padding: 2%;color: #000;background: #e6e6e6;text-align: center;border-radius:10px" >
                                  {{'students' | translate}} <strong>{{calculateStudentsGroup(groupLevel)}}/{{calculateMaxGroup(groupLevel)}}</strong>
                                </div>
                                <mat-form-field class="flex-auto" style="width: 100%; margin-top: 10%">
                                  <input type="number" placeholder="Max per Group" [value]="calculateMaxGroup(groupLevel)" aria-label="Number" matInput (blur)="setSubGroupPax($event, groupLevel)" />
                                  <mat-error *ngIf="groupLevel.max_participants > this.defaults.max_participants">
                                    {{'courses.errors.students' | translate }}
                                  </mat-error>
                                </mat-form-field>
                              </div>

                              <ng-container *ngIf="groupLevel.active && groupLevel.visible">

                                  <div style="width:100%;float:left;overflow: scroll;" *ngFor="let subGroup of readSubGroups(groupLevel.id); let subGroupIndex = index">
                                    <div style="float:left; width: 100%; margin-top: 5%;padding: 0 0% 0 10%">
                                      <div>
                                        <ul style="display: flex">
                                          <li style="float: left; width: 20%;font-size: 14px" >
                                            <mat-icon svgIcon="mat:delete" style="color:red;cursor: pointer;float:left;" (click)="deleteSubGroup(subGroup)"></mat-icon>

                                            <span [style.color]="colorKey"><strong>{{groupLevel.annotation}}</strong> - {{groupLevel.name}} - {{ subGroupIndex + 1 }}</span>
                                          </li>
                                          <li *ngFor="let dayLevel of daysDatesLevels; let dayIndex = index;"
                                              (click)="selectItem(dayLevel, dayIndex, subGroupIndex, subGroup)"
                                              [style.color]="selectedItem === dayLevel.dateString && dayIndex === daySelectedIndex && subGroupIndex === subGroupSelectedIndex ? '#FF3085' : ''"
                                              style="float: left; width: 13%; text-align: center; cursor: pointer;">
                                            {{ dayLevel.dateString }}
                                          </li>

                                        </ul>
                                      </div>
                                    </div>
                                    <div style="float:left; width: 100%; margin-top: 5%;padding: 0 0% 0 10%" *ngIf="subGroupSelectedIndex !== null">
                                      <div>
                                        <ul>
                                          <li style="float: left; width: 20%;" (click)="subGroupSelectedIndex = subGroupIndex;">
                                            <label for="monitor" style="font-size: 20px;">{{'monitor' | translate}}</label>

                                            <mat-spinner *ngIf="loadingMonitors"> </mat-spinner>
                                            <mat-form-field class="flex-auto" *ngIf="!loadingMonitors">

                                              <input type="text" id="monitor" placeholder="Select monitor" matInput [matAutocomplete]="autoMoniteur" [value]="getMonitorValue(groupLevel, subGroupIndex, daySelectedIndex)"/>
                                              <mat-autocomplete #autoMoniteur="matAutocomplete" [displayWith]="displayFnMoniteurs" >

                                                <ng-container *ngFor="let monitor of filteredMonitors | async">
                                                  <mat-option *ngIf="!checkIfExistInDate(daySelectedIndex, monitor, groupLevel)"
                                                    (onSelectionChange)="setSubGroupMonitor($event, monitor, groupLevel, subGroupSelectedIndex, daySelectedIndex)">
                                                    {{monitor && monitor?.first_name ? monitor?.first_name : '' }} {{monitor && monitor?.last_name ? monitor?.last_name : ''}}
                                                  </mat-option>
                                                </ng-container>
                                              </mat-autocomplete>
                                              <mat-icon matPrefix svgIcon="mat:person"></mat-icon>
                                            </mat-form-field>
                                          </li>
                                          <li style="float: left; width: 13%;margin: 3% 0 0 0;" *ngFor="let item of daysDatesLevels">
                                            <div style="background-color: #CEE741;width: 25px;border-radius: 100%;height: 25px;margin: 0 auto;"
                                            [ngStyle]="{'background-color': hasMonitorAssigned(item, groupLevel)? '#CEE741': 'red'}"></div>
                                          </li>
                                        </ul>
                                      </div>
                                    </div>
                                    <mat-divider class="text-border" style="float: left;width: 100%;border: 4px solid #f0f0f0;"></mat-divider>

                                    <!-- n iteraciones por alumno-->
                                    <div style="float:left; width: 100%; margin: 5% 0 5% 0;padding: 0 0 0 10%" *ngFor="let courseUser of getCourseUsers(subGroup); let courseUserIndex = index" >
                                      <p *ngIf="courseUserIndex === 0" style="font-size: 20px;margin: 0 0 2% 0;">
                                        <img (click)="openUserTransfer(groupLevel, subGroup, subGroupIndex + 1)" src="../../../../assets/img/icons/change.svg" style="float:left;cursor: pointer;">Alumnos </p>

                                      <ng-container>

                                        <div>
                                          <ul>
                                            <li style="float: left; width: 20%;" >
                                              <div style="float: left; width: 100%;">
                                                <div style="float: left; width: 25%;">
                                                  <img [src]="getClient(courseUser.client_id)?.image || userAvatar" style="border-radius: 100%;height: 50px;width: 110px;">
                                                </div>
                                                <div style="float: left; width: 75%;">
                                                  <p style="font-size: 16px;">{{getClient(courseUser.client_id)?.first_name}} {{getClient(courseUser.client_id)?.last_name}}</p>
                                                  <p style="font-size: 10px;">{{getLanguage(getClient(courseUser.client_id).language1_id)}} · {{ getCountry(getClient(courseUser.client_id).country) }} · {{calculateAge(getClient(courseUser.client_id).birth_date)}}{{'years' | translate }}</p>
                                                </div>
                                              </div>
                                            </li>

                                            <li style="float: left; width: 13%;" *ngFor="let item of daysDatesLevels">
                                              <div style="width: 25px;border-radius: 100%;height: 25px;margin: 0 auto;"
                                              [ngStyle]="{'background-color': isInDay(item.date, courseUser.client_id) ? '#CEE741': 'red'}">
                                            </div>
                                            </li>
                                          </ul>
                                        </div>
                                      </ng-container>
                                      </div>
                                  </div>

                                </ng-container>
                            </div>
                          </div>
                        </ng-container>
                      </div>
                    </mat-card-content>
                  </mat-card>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </mat-tab>
        <mat-tab label="Reservations" *ngIf="false">

        </mat-tab>
        <mat-tab label="Statistiques" *ngIf="false">

        </mat-tab>

      </mat-tab-group>
    </div>


  </div>
</div>
