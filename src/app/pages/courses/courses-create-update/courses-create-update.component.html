<vex-secondary-toolbar current="Courses">
  <vex-breadcrumbs
    [crumbs]="['Courses', 'Nouvelle course']"
    class="flex-auto"
  ></vex-breadcrumbs>
  <button class="ml-2" color="primary" mat-icon-button type="button">
    <mat-icon svgIcon="mat:more_vert"></mat-icon>
  </button>
</vex-secondary-toolbar>
<div
  [@stagger]="true"
  class="p-gutter container"
  style="max-width: none"
  *ngIf="!loading"
>
  <div class="flex flex-col sm:flex-row gap-4">
    <div @fadeInUp class="card flex-auto">
      <div class="px-6 py-4 border-b flex items-center">
        <h2 class="title m-0">Nouvelle réservation</h2>
      </div>
      <mat-vertical-stepper #stepper="matHorizontalStepper" [linear]="true">
        <ng-template matStepperIcon="edit">
          <mat-icon svgIcon="mat:done_all"></mat-icon>
        </ng-template>

        <ng-template matStepperIcon="done">
          <mat-icon svgIcon="mat:done_all"></mat-icon>
        </ng-template>

        <mat-step [stepControl]="courseInformationFormGroup">
          <form [formGroup]="courseInformationFormGroup">
            <ng-template matStepLabel>Info de cours</ng-template>

            <h2 class="title m-0" style="width:100%">Type</h2>
            <div class="subheading-1">Set up your course type.</div>

            <div class="mt-4 flex flex-col gap-2">
              <mat-form-field>
                <mat-label>Sport type</mat-label>

                <input type="text" placeholder="Selecciona una opción" matInput [formControl]="myControlSportType" [matAutocomplete]="autoSportType" formControlName="sportType">
                <mat-autocomplete #autoSportType="matAutocomplete" [displayWith]="displayFn" (optionSelected)="filterSportsByType($event)">
                  <mat-option *ngFor="let option of filteredSportTypes | async" [value]="option">
                    {{option.name}}
                  </mat-option>
                </mat-autocomplete>
              </mat-form-field>
            </div>

            <div class="mt-4 flex flex-col gap-2">
              <mat-form-field class="flex-auto" *ngIf="sportTypeSelected > -1">
                <mat-label>Sport</mat-label>
                <input type="text"
                 placeholder="Elije uno"
                 matInput
                 formControlName="sport"
                 [formControl]="myControlSport"
                 [matAutocomplete]="autoSport">
                <mat-autocomplete #autoSport="matAutocomplete" [displayWith]="displayFnSport">
                  <mat-option *ngFor="let sport of filteredSports | async" [value]="sport">
                    {{ sport.name }}
                  </mat-option>
                </mat-autocomplete>

                <mat-icon matPrefix svgIcon="mat:sports"></mat-icon>
              </mat-form-field>
            </div>

            <div class="actions flex items-center justify-end gap-2">
              <button (click)="stepper.reset()" [disabled]="courseInformationFormGroup.pristine" color="primary" mat-button type="button">Reset
              </button>
              <button [disabled]="courseInformationFormGroup.invalid" color="primary" mat-raised-button matStepperNext>
                Next
              </button>
            </div>
          </form>
        </mat-step>

        <mat-step [stepControl]="courseTypeFormGroup" >
          <form [formGroup]="courseTypeFormGroup">
            <ng-template matStepLabel>Course Type</ng-template>
            <h2 class="title m-0" style="width:100%">Données générales</h2>
            <div class="subheading-1">Configura los datos y fechas del curso.</div>

            <div class="mt-4 flex flex-col gap-2">
              <div class="flex-auto">
                <mat-label>Cours avec des dates séparables?</mat-label><br>
                <mat-slide-toggle formControlName="separatedDates"></mat-slide-toggle>
              </div>

            </div>

            <div class="mt-4 flex flex-col gap-2">
              <mat-form-field>
                <mat-label>Course Type</mat-label>

                <input class="flex-auto" type="text" placeholder="Selecciona una opción" matInput [formControl]="myControl" [matAutocomplete]="auto" formControlName="courseType">
                <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFnSport">
                  <mat-option *ngFor="let option of filteredOptions | async" [value]="option">
                    {{option.name}}
                  </mat-option>
                </mat-autocomplete>
              </mat-form-field>
            </div>
            <div class="flex-auto">
              <button mat-raised-button (click)="openDialog()">Add date</button>

              <table *ngIf="dataSource.data.length > 0" mat-table [dataSource]="dataSource" matSort>

                <!-- Columna Fecha -->
                <ng-container matColumnDef="date">
                  <th mat-header-cell *matHeaderCellDef mat-sort-header> Date </th>
                  <td mat-cell *matCellDef="let element"> {{element.date}} </td>
                </ng-container>

                <!-- Columna Hora -->
                <ng-container matColumnDef="hour">
                  <th mat-header-cell *matHeaderCellDef> Hour </th>
                  <td mat-cell *matCellDef="let element"> {{element.hour}} </td>
                </ng-container>

                <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
              </table>

            </div>


            <div class="actions flex items-center justify-end gap-2">
              <button (click)="stepper.reset()" [disabled]="courseTypeFormGroup.pristine" color="primary" mat-button type="button">Reset
              </button>

              <button [disabled]="courseTypeFormGroup.invalid" color="primary" mat-raised-button matStepperNext>
                Next
              </button>
            </div>
          </form>
        </mat-step>

        <mat-step [stepControl]="courseInfoFormGroup" *ngIf="!courseTypeFormGroup.value.separatedDates && courseTypeFormGroup.value?.courseType?.id === 1">
          <form [formGroup]="courseInfoFormGroup">
            <ng-template matStepLabel>Données générales</ng-template>

            <h2 class="title m-0" style="width:100%">Données générales</h2>
            <div class="subheading-1">Configura los datos y fechas del curso.</div>

            <div class="mt-4 flex flex-col gap-2">

              <div class="flex flex-col sm:flex-row gap-2 sm:gap-6">
                <mat-form-field class="flex-auto">
                  <mat-label>NOM DU COURS</mat-label>
                  <input formControlName="course_name" matInput required>
                </mat-form-field>

                <div class="flex-auto flex gap-2">
                  <mat-form-field class="flex-auto">
                    <mat-label>PRIX (CHF)</mat-label>
                    <input formControlName="price" type="number" matInput required>
                  </mat-form-field>

                  <mat-form-field class="vex-flex-form-field flex-auto">
                    <mat-label>Station</mat-label>

                    <input type="text" placeholder="Selecciona una opción" matInput [formControl]="myControlStations" [matAutocomplete]="autoStation" formControlName="station">

                    <mat-autocomplete #autoStation="matAutocomplete">
                      <mat-option *ngFor="let option of filteredStations | async" [value]="option">
                        {{option}}
                      </mat-option>
                    </mat-autocomplete>
                  </mat-form-field>
                </div>

              </div>

              <mat-form-field class="flex-auto">
                <mat-label>RÉSUMÉ</mat-label>
                <textarea formControlName="summary" matInput></textarea>
              </mat-form-field>

              <mat-form-field class="flex-auto">
                <mat-label>LA DESCRIPTION</mat-label>
                <textarea formControlName="description" matInput></textarea>
              </mat-form-field>


              <div class="flex flex-col sm:flex-row gap-2 sm:gap-6">

              <mat-form-field class="flex-auto">
                  <input type="text" formControlName="duration" placeholder="DURÉE" matInput [matAutocomplete]="autoTimes">
                  <mat-autocomplete #autoTimes="matAutocomplete">
                    <mat-option *ngFor="let duration of durations" [value]="duration">
                      {{duration}}
                    </mat-option>
                  </mat-autocomplete>
              </mat-form-field>

                <mat-form-field class="flex-auto">
                  <mat-label>PARTICIPANTS MÁX.</mat-label>
                  <input formControlName="participants" matInput required type="number">
                </mat-form-field>
              </div>


              <div>

                <div *ngIf="imagePreviewUrl" class="image-container">
                  <img [src]="imagePreviewUrl" alt="Image Preview" width="400" height="290">
                </div>
                <div class="input-container">

                  <input type="file" formControlName="image" placeholder="Select an image" (change)="onFileChanged($event)" id="file"/>
                  <label for="file" class="btn-1">upload file</label>
                  <p>Maximum 1mb</p>
                  <p>Formats supportés: PNG, JPG</p>
                  <p>Taille recommandée: 400x290px</p>
                </div>
              </div>
              <mat-divider class="text-border"></mat-divider>

            </div>

            <div class="actions flex items-center justify-end gap-2">
              <button (click)="stepper.reset()" [disabled]="courseInfoFormGroup.pristine" color="primary" mat-button type="button">Reset</button>
              <button [disabled]="courseInfoFormGroup.invalid" color="primary" mat-raised-button matStepperNext>
                Next
              </button>
            </div>


          </form>
        </mat-step>

        <mat-step [stepControl]="courseInfoCollecDateSplitFormGroup" *ngIf="courseTypeFormGroup.value.separatedDates && courseTypeFormGroup.value?.courseType?.id === 1">
          <form [formGroup]="courseInfoCollecDateSplitFormGroup">
            <ng-template matStepLabel>Données générales</ng-template>

            <h2 class="title m-0" style="width:100%">Données générales</h2>
            <div class="subheading-1">Configura los datos y fechas del curso.</div>

            <div class="mt-4 flex flex-col gap-2">

              <div class="flex flex-col sm:flex-row gap-2 sm:gap-6">
                <mat-form-field class="flex-auto">
                  <mat-label>NOM DU COURS GLOBAL</mat-label>
                  <input formControlName="course_name" matInput required>
                </mat-form-field>

                <div class="flex-auto flex gap-2">
                  <mat-form-field class="flex-auto">
                    <mat-label>PRIX PAR DATE (CHF)</mat-label>
                    <input formControlName="price" type="number" matInput required>
                  </mat-form-field>

                  <mat-form-field class="vex-flex-form-field flex-auto">
                    <mat-label>Station</mat-label>

                    <input type="text" placeholder="Selecciona una opción" matInput [formControl]="myControlStations" [matAutocomplete]="autoStation" formControlName="station">

                    <mat-autocomplete #autoStation="matAutocomplete">
                      <mat-option *ngFor="let option of filteredStations | async" [value]="option">
                        {{option}}
                      </mat-option>
                    </mat-autocomplete>
                  </mat-form-field>
                </div>

              </div>

              <mat-form-field class="flex-auto">
                <mat-label>RÉSUMÉ</mat-label>
                <textarea formControlName="summary" matInput></textarea>
              </mat-form-field>

              <mat-form-field class="flex-auto">
                <mat-label>LA DESCRIPTION</mat-label>
                <textarea formControlName="description" matInput></textarea>
              </mat-form-field>


              <div class="flex flex-col sm:flex-row gap-2 sm:gap-6">

              <mat-form-field class="flex-auto">
                  <input type="text" formControlName="duration" placeholder="DURÉE" matInput [matAutocomplete]="autoTimes">
                  <mat-autocomplete #autoTimes="matAutocomplete">
                    <mat-option *ngFor="let duration of durations" [value]="duration">
                      {{duration}}
                    </mat-option>
                  </mat-autocomplete>
              </mat-form-field>

                <mat-form-field class="flex-auto">
                  <mat-label>PARTICIPANTS MÁX.</mat-label>
                  <input formControlName="participants" matInput required type="number">
                </mat-form-field>
              </div>


              <div>

                <div *ngIf="imagePreviewUrl" class="image-container">
                  <img [src]="imagePreviewUrl" alt="Image Preview" width="400" height="290">
                </div>
                <div class="input-container">

                  <input type="file" formControlName="image" placeholder="Select an image" (change)="onFileChanged($event)" id="file"/>
                  <label for="file" class="btn-1">upload file</label>
                  <p>Maximum 1mb</p>
                  <p>Formats supportés: PNG, JPG</p>
                  <p>Taille recommandée: 400x290px</p>
                </div>
              </div>
              <mat-divider class="text-border"></mat-divider>

            </div>

            <div class="actions flex items-center justify-end gap-2">
              <button (click)="stepper.reset()" [disabled]="courseInfoFormGroup.pristine" color="primary" mat-button type="button">Reset</button>
              <button [disabled]="courseInfoFormGroup.invalid" color="primary" mat-raised-button matStepperNext>
                Next
              </button>
            </div>


          </form>
        </mat-step>

        <mat-step [stepControl]="courseInfoFormGroup" *ngIf="!courseTypeFormGroup.value.separatedDates && courseTypeFormGroup.value?.courseType?.id === 1">
          <div>

            <ng-template matStepLabel>Level</ng-template>
            <h2 class="title m-0" style="width:100%">Level</h2>
            <div class="subheading-1">Configura los niveles del curso.</div>

            <div *ngFor="let colorKey of colorKeys">
              <mat-chip-listbox>
                <mat-chip *ngFor="let level of groupedByColor[colorKey]" [style.background-color]="colorKey" [style.color]="'#ffffff'" [style.width]="'250px'"
                (click)="onChipClick(level)">
                  {{ level.name }}
                </mat-chip>
              </mat-chip-listbox>
              <br> <!-- espacio entre grupos -->
            </div>

            <!-- Mat Table para los contenedores seleccionados -->
            <mat-table #levelTable [dataSource]="selectedCourses" *ngIf="selectedCourses.data.length > 0">
              <!-- Nombre de Curso -->
              <ng-container matColumnDef="course">
                <mat-header-cell *matHeaderCellDef> Curso </mat-header-cell>
                <mat-cell *matCellDef="let element"> {{element.annotation}} - {{element.name}} </mat-cell>
              </ng-container>

              <!-- Otros contenedores según tu descripción -->

              <ng-container matColumnDef="min">
                <mat-header-cell *matHeaderCellDef> PROF EXPO MIN </mat-header-cell>
                <mat-cell *matCellDef="let element">
                  <mat-form-field>

                    <input matInput [(ngModel)]="element.min" type="number">
                  </mat-form-field>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="max">
                <mat-header-cell *matHeaderCellDef> PROF EXPO MAX </mat-header-cell>
                <mat-cell *matCellDef="let element">
                  <mat-form-field>
                    <input matInput [(ngModel)]="element.max" type="number">
                  </mat-form-field>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="levels">
                <mat-header-cell *matHeaderCellDef> NIVEAUS MIN. DU PROF </mat-header-cell>
                <mat-cell *matCellDef="let element">
                  <mat-form-field>
                    <input type="text" matInput [matAutocomplete]="auto" [(ngModel)]="element.level">
                    <mat-autocomplete #auto="matAutocomplete" [displayWith]="displayFnLevel">
                      <mat-option *ngFor="let level of mockLevels" [value]="level">
                        {{level.annotation}} - {{level.name}}
                      </mat-option>
                    </mat-autocomplete>
                  </mat-form-field>
                </mat-cell>
              </ng-container>

              <ng-container matColumnDef="checkbox">
                <mat-header-cell *matHeaderCellDef> AJOUTER GROUPE </mat-header-cell>
                <mat-cell *matCellDef="let element">
                  <mat-slide-toggle></mat-slide-toggle>
                </mat-cell>
              </ng-container>

              <!-- Ícono para eliminar -->
              <ng-container matColumnDef="delete">
                <mat-header-cell *matHeaderCellDef> Eliminar </mat-header-cell>
                <mat-cell *matCellDef="let element">
                  <!-- Aquí el ícono para eliminar -->
                  <mat-icon svgIcon="mat:delete" (click)="removeCourse(element)"></mat-icon>
                </mat-cell>
              </ng-container>

              <mat-header-row *matHeaderRowDef="displayedCourseColumns"></mat-header-row>
              <mat-row *matRowDef="let row; columns: displayedCourseColumns;"></mat-row>
            </mat-table>
          </div>
        </mat-step>
      </mat-vertical-stepper>
    </div>
  </div>
</div>
