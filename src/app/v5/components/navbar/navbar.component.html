<div class="topbar">
  <!-- Search -->
  <div class="search-container">
    <div class="search-wrapper">
      <mat-icon class="search-icon">search</mat-icon>
      <input
        type="text"
        placeholder="Buscar reservas, instructores, cursos..."
        class="search-input"
        [(ngModel)]="searchTerm"
        (input)="onSearch($event)"
      >
    </div>
  </div>

  <!-- Season Selector -->
  <div class="season-selector" *ngIf="currentSeason || availableSeasons.length > 0">
    <button class="season-btn-v2" [matMenuTriggerFor]="seasonMenu" (menuOpened)="onSeasonMenuOpen()">
      <div class="season-compact-info">
        <span class="season-name-compact">{{ currentSeason?.name || 'Seleccionar Temporada' }}</span>
        <div class="season-status-compact" [class]="getSeasonStatusClass()" *ngIf="currentSeason">
          {{ getSeasonStatusText() }}
        </div>
      </div>
      <mat-icon class="chevron-icon-v2">expand_more</mat-icon>
    </button>

    <mat-menu #seasonMenu="matMenu" class="season-dropdown-v2" xPosition="before" yPosition="below">
      <!-- Header similar to modal -->
      <div class="dropdown-header-v2">
        <div class="header-content-v2">
          <mat-icon class="header-icon-v2">event</mat-icon>
          <div class="header-text-v2">
            <h3>Seleccionar Temporada</h3>
            <p>Elige la temporada activa</p>
          </div>
        </div>
      </div>
      
      <!-- Loading state -->
      <div *ngIf="isLoadingSeasons" class="loading-container-v2">
        <mat-spinner diameter="20"></mat-spinner>
        <span>Cargando...</span>
      </div>
      
      <!-- Season list with modal-like design -->
      <div *ngIf="!isLoadingSeasons" class="seasons-container-v2">
        <div *ngFor="let season of availableSeasons" class="season-item-v2">
          <button 
            mat-menu-item 
            (click)="selectSeason(season)"
            class="season-button-v2"
            [class.selected]="isSeasonSelected(season)"
          >
            <div class="season-card-v2">
              <div class="season-header-v2">
                <h4 class="season-title-v2">{{ season.name }}</h4>
                <div class="season-status-v2" [class]="getSeasonStatusClass(season)">
                  {{ getSeasonStatusText(season) }}
                </div>
              </div>
              <div class="season-dates-v2">{{ season.start_date }} - {{ season.end_date }}</div>
              <mat-icon *ngIf="isSeasonSelected(season)" class="check-icon-v2">check_circle</mat-icon>
            </div>
          </button>
        </div>
        
        <!-- Empty state -->
        <div *ngIf="availableSeasons.length === 0" class="empty-state-v2">
          <mat-icon>event_busy</mat-icon>
          <p>No hay temporadas disponibles</p>
        </div>
      </div>
      
      <!-- Add New Season Option -->
      <div class="add-season-section-v2" *ngIf="!isLoadingSeasons">
        <mat-divider></mat-divider>
        <button mat-menu-item class="add-season-btn-v2" (click)="openCreateSeasonDialog()">
          <mat-icon class="add-icon-v2">add</mat-icon>
          <span>Crear Nueva Temporada</span>
        </button>
      </div>
    </mat-menu>
  </div>

  <!-- Controls -->
  <div class="controls">
    <!-- Language Selector -->
    <button class="control-btn language-btn" [matMenuTriggerFor]="languageMenu">
      <mat-icon class="globe-icon">language</mat-icon>
      <span class="language-code">ES</span>
      <mat-icon class="chevron-icon">keyboard_arrow_down</mat-icon>
    </button>

    <mat-menu #languageMenu="matMenu" class="language-dropdown">
      <button mat-menu-item (click)="setLanguage('es')">
        <span class="flag">ðŸ‡ªðŸ‡¸</span>
        EspaÃ±ol
      </button>
      <button mat-menu-item (click)="setLanguage('en')">
        <span class="flag">ðŸ‡ºðŸ‡¸</span>
        English
      </button>
      <button mat-menu-item (click)="setLanguage('fr')">
        <span class="flag">ðŸ‡«ðŸ‡·</span>
        FranÃ§ais
      </button>
    </mat-menu>

    <!-- Dark Mode Toggle -->
    <button class="control-btn toggle-btn" (click)="toggleDarkMode()">
      <mat-icon>{{ darkMode ? 'light_mode' : 'dark_mode' }}</mat-icon>
    </button>

    <!-- Notifications -->
    <button class="control-btn notifications-btn" [matMenuTriggerFor]="notificationsMenu">
      <mat-icon>notifications</mat-icon>
      <div class="notification-badge" *ngIf="notificationCount > 0">
        {{ notificationCount > 99 ? '99+' : notificationCount }}
      </div>
    </button>

    <mat-menu #notificationsMenu="matMenu" class="notifications-dropdown">
      <div class="notifications-header">
        <span class="notifications-title">Notificaciones</span>
        <button mat-button class="mark-read-btn">Marcar todas como leÃ­das</button>
      </div>
      <mat-divider></mat-divider>
      <div class="notifications-list">
        <button mat-menu-item *ngFor="let notification of recentNotifications" class="notification-item">
          <div class="notification-content">
            <p class="notification-title">{{ notification.title }} xd</p>
            <p class="notification-message">{{ notification.message }}</p>
            <span class="notification-time">{{ notification.time }}</span>
          </div>
        </button>
      </div>
    </mat-menu>

    <!-- User Menu -->
    <button class="user-menu-btn" [matMenuTriggerFor]="userMenu" *ngIf="currentUser" (click)="onUserMenuClick()">
      <div class="user-avatar">
        <img [src]="currentUser.avatar" [alt]="currentUser.name" class="avatar-image">
      </div>
      <div class="user-info">
        <p class="user-name">{{ currentUser.name }}</p>
        <p class="user-role">{{ currentUser.role }}</p>
      </div>
      <mat-icon class="chevron-icon">keyboard_arrow_down</mat-icon>
    </button>

    <mat-menu #userMenu="matMenu" class="user-dropdown">
      <div class="user-menu-header" *ngIf="currentUser">
        <div class="user-avatar-large">
          <img [src]="currentUser.avatar" [alt]="currentUser.name" class="avatar-image">
        </div>
        <div class="user-details">
          <p class="user-name">{{ currentUser.name }}</p>
          <p class="user-email">{{ currentUser.email }}</p>
        </div>
      </div>
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="goToProfile()">
        <mat-icon>person</mat-icon>
        <span>Perfil</span>
      </button>
      <button mat-menu-item (click)="goToNotifications()">
        <mat-icon>notifications</mat-icon>
        <span>Notificaciones</span>
      </button>
      <button mat-menu-item (click)="showUserInfo()">
        <mat-icon>info</mat-icon>
        <span>Info de Usuario (Debug)</span>
      </button>
      <mat-divider></mat-divider>
      <button mat-menu-item (click)="logout()" class="logout-item">
        <mat-icon>logout</mat-icon>
        <span>Cerrar SesiÃ³n</span>
      </button>
    </mat-menu>
  </div>
</div>
