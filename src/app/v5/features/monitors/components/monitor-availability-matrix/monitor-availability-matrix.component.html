<div class="availability-matrix-container">
  <!-- Header Controls -->
  <div class="matrix-header">
    <div class="header-content">
      <h2 class="matrix-title">
        {{ 'monitor.availability_matrix' | translate }}
        <span class="monitor-count" *ngIf="selectedMonitors.length > 0">
          ({{ selectedMonitors.length }} {{ 'monitor.monitors' | translate }})
        </span>
      </h2>

      <div class="season-indicator" *ngIf="currentSeason$ | async as currentSeason">
        <mat-icon>schedule</mat-icon>
        <span>{{ currentSeason.name }}</span>
      </div>
    </div>

    <div class="header-actions">
      <mat-button-toggle-group #viewMode="matButtonToggleGroup"
                               value="weekly"
                               (change)="onViewModeChange(viewMode.value)">
        <mat-button-toggle value="daily">
          <mat-icon>today</mat-icon>
          {{ 'monitor.daily' | translate }}
        </mat-button-toggle>
        <mat-button-toggle value="weekly">
          <mat-icon>view_week</mat-icon>
          {{ 'monitor.weekly' | translate }}
        </mat-button-toggle>
        <mat-button-toggle value="monthly">
          <mat-icon>calendar_month</mat-icon>
          {{ 'monitor.monthly' | translate }}
        </mat-button-toggle>
      </mat-button-toggle-group>

      <mat-button-toggle-group #zoomLevel="matButtonToggleGroup"
                               value="hours"
                               (change)="onZoomChange(zoomLevel.value)">
        <mat-button-toggle value="hours">1h</mat-button-toggle>
        <mat-button-toggle value="half-hours">30m</mat-button-toggle>
        <mat-button-toggle value="quarter-hours">15m</mat-button-toggle>
      </mat-button-toggle-group>

      <button mat-icon-button
              (click)="onRefreshMatrix()"
              [disabled]="isLoading"
              matTooltip="{{ 'monitor.refresh_matrix' | translate }}">
        <mat-icon>refresh</mat-icon>
      </button>

      <button mat-icon-button
              (click)="onExportMatrix()"
              matTooltip="{{ 'monitor.export_matrix' | translate }}">
        <mat-icon>download</mat-icon>
      </button>
    </div>
  </div>

  <!-- Filters Panel -->
  <mat-card class="filters-card">
    <mat-card-content>
      <form [formGroup]="filtersForm" class="filters-form">
        <div class="filter-row">
          <mat-form-field appearance="outline" class="date-field">
            <mat-label>{{ 'monitor.date_from' | translate }}</mat-label>
            <input matInput [matDatepicker]="dateFromPicker" formControlName="date_from">
            <mat-datepicker-toggle matSuffix [for]="dateFromPicker"></mat-datepicker-toggle>
            <mat-datepicker #dateFromPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline" class="date-field">
            <mat-label>{{ 'monitor.date_to' | translate }}</mat-label>
            <input matInput [matDatepicker]="dateToPicker" formControlName="date_to">
            <mat-datepicker-toggle matSuffix [for]="dateToPicker"></mat-datepicker-toggle>
            <mat-datepicker #dateToPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'monitor.course_group' | translate }}</mat-label>
            <mat-select formControlName="course_group_id">
              <mat-option value="">{{ 'monitor.all_course_groups' | translate }}</mat-option>
              <!-- Course group options would be populated here -->
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>{{ 'monitor.location' | translate }}</mat-label>
            <mat-select formControlName="location_id">
              <mat-option value="">{{ 'monitor.all_locations' | translate }}</mat-option>
              <!-- Location options would be populated here -->
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline" class="rating-field">
            <mat-label>{{ 'monitor.min_rating' | translate }}</mat-label>
            <mat-select formControlName="min_rating">
              <mat-option value="">{{ 'monitor.any_rating' | translate }}</mat-option>
              <mat-option value="4.5">4.5+</mat-option>
              <mat-option value="4.0">4.0+</mat-option>
              <mat-option value="3.5">3.5+</mat-option>
            </mat-select>
          </mat-form-field>

          <mat-checkbox formControlName="show_only_available" class="checkbox-filter">
            {{ 'monitor.show_only_available' | translate }}
          </mat-checkbox>
        </div>
      </form>

      <!-- View Options -->
      <mat-expansion-panel class="view-options-panel">
        <mat-expansion-panel-header>
          <mat-panel-title>
            <mat-icon>settings</mat-icon>
            {{ 'monitor.view_options' | translate }}
          </mat-panel-title>
        </mat-expansion-panel-header>

        <form [formGroup]="viewOptionsForm" class="view-options-form">
          <div class="options-row">
            <mat-checkbox formControlName="show_unavailable">
              {{ 'monitor.show_unavailable_slots' | translate }}
            </mat-checkbox>

            <mat-checkbox formControlName="show_travel_time">
              {{ 'monitor.show_travel_time' | translate }}
            </mat-checkbox>

            <mat-checkbox formControlName="show_hourly_rates">
              {{ 'monitor.show_hourly_rates' | translate }}
            </mat-checkbox>

            <mat-checkbox formControlName="highlight_conflicts">
              {{ 'monitor.highlight_conflicts' | translate }}
            </mat-checkbox>

            <mat-checkbox formControlName="group_by_location">
              {{ 'monitor.group_by_location' | translate }}
            </mat-checkbox>
          </div>

          <div class="options-row">
            <mat-form-field appearance="outline" class="time-field">
              <mat-label>{{ 'monitor.start_hour' | translate }}</mat-label>
              <mat-select formControlName="start_hour">
                <mat-option *ngFor="let hour of [6,7,8,9,10]" [value]="hour">
                  {{ hour }}:00
                </mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline" class="time-field">
              <mat-label>{{ 'monitor.end_hour' | translate }}</mat-label>
              <mat-select formControlName="end_hour">
                <mat-option *ngFor="let hour of [18,19,20,21,22]" [value]="hour">
                  {{ hour }}:00
                </mat-option>
              </mat-select>
            </mat-form-field>
          </div>
        </form>
      </mat-expansion-panel>
    </mat-card-content>
  </mat-card>

  <!-- Conflict Alert -->
  <mat-card class="alert-card" *ngIf="hasConflicts && currentViewOptions.highlight_conflicts">
    <mat-card-content>
      <div class="alert-content">
        <mat-icon class="alert-icon">warning</mat-icon>
        <div class="alert-text">
          <h4>{{ 'monitor.conflicts_detected' | translate }}</h4>
          <p>{{ 'monitor.conflicts_description' | translate }}</p>
        </div>
        <button mat-button color="warn" class="resolve-conflicts-btn">
          {{ 'monitor.resolve_conflicts' | translate }}
        </button>
      </div>
    </mat-card-content>
  </mat-card>

  <!-- Availability Matrix -->
  <mat-card class="matrix-card">
    <mat-card-content>
      <!-- Loading Indicator -->
      <div class="loading-container" *ngIf="isLoading">
        <mat-progress-bar mode="indeterminate"></mat-progress-bar>
        <span>{{ 'monitor.loading_matrix' | translate }}</span>
      </div>

      <!-- Matrix Table -->
      <div class="matrix-container" [class.loading]="isLoading">
        <div class="matrix-scroll-container">
          <table class="availability-matrix" *ngIf="availabilityMatrix.length > 0">
            <!-- Header Row with Dates -->
            <thead>
              <tr class="date-header-row">
                <th class="monitor-header">{{ 'monitor.monitor' | translate }}</th>
                <th *ngFor="let date of dateHeaders"
                    class="date-header"
                    [class.weekend]="isWeekend(date)"
                    [class.today]="isSameDate(date, now)"
                    [attr.colspan]="timeSlots.length">
                  <div class="date-content">
                    <span class="date-text">{{ formatDate(date) }}</span>
                    <span class="weekday">{{ date | date:'EEEE' }}</span>
                  </div>
                </th>
              </tr>

              <!-- Time Slots Header -->
              <tr class="time-header-row">
                <th class="monitor-header-time"></th>
                <ng-container *ngFor="let date of dateHeaders">
                  <th *ngFor="let timeSlot of timeSlots"
                      class="time-header"
                      [class.current-hour]="isCurrentTimeSlot(date, timeSlot.display_time)">
                    <span class="time-text">{{ timeSlot.display_time }}</span>
                  </th>
                </ng-container>
              </tr>
            </thead>

            <!-- Matrix Body -->
            <tbody>
              <tr *ngFor="let monitorRow of availabilityMatrix; let monitorIndex = index"
                  class="monitor-row">

                <!-- Monitor Name Column -->
                <td class="monitor-name-cell">
                  <div class="monitor-info">
                    <div class="monitor-avatar">
                      <img *ngIf="selectedMonitors[monitorIndex].profile_picture; else defaultAvatar"
                           [src]="selectedMonitors[monitorIndex].profile_picture"
                           [alt]="selectedMonitors[monitorIndex].full_name"
                           class="avatar-image">
                      <ng-template #defaultAvatar>
                        <div class="avatar-placeholder">
                          {{ selectedMonitors[monitorIndex].first_name?.[0] }}{{ selectedMonitors[monitorIndex].last_name?.[0] }}
                        </div>
                      </ng-template>
                    </div>

                    <div class="monitor-details">
                      <span class="monitor-name">{{ selectedMonitors[monitorIndex].full_name }}</span>
                      <span class="monitor-rating" *ngIf="selectedMonitors[monitorIndex].performance_stats?.average_rating">
                        <mat-icon class="star-icon">star</mat-icon>
                        {{ selectedMonitors[monitorIndex].performance_stats.average_rating | number:'1.1-1' }}
                      </span>
                      <span class="monitor-status"
                            [class]="'status-' + selectedMonitors[monitorIndex].status">
                        {{ selectedMonitors[monitorIndex].status | translate }}
                      </span>
                    </div>
                  </div>
                </td>

                <!-- Time Slot Cells -->
                <td *ngFor="let cell of monitorRow"
                    class="matrix-cell"
                    [class]="getCellClass(cell)"
                    [matTooltip]="getCellTooltip(cell)"
                    matTooltipPosition="above"
                    (click)="onCellClick(cell)"
                    (dblclick)="onCellDoubleClick(cell)">

                  <!-- Cell Content -->
                  <div class="cell-content">
                    <!-- Status Indicator -->
                    <div class="status-indicator" [style.background-color]="statusConfig[cell.status]?.color">
                      <mat-icon class="status-icon">{{ statusConfig[cell.status]?.icon }}</mat-icon>
                    </div>

                    <!-- Additional Information -->
                    <div class="cell-info" *ngIf="cell.status === 'booked'">
                      <span class="course-info" *ngIf="cell.course_name">
                        {{ cell.course_name }}
                      </span>
                      <span class="participant-count" *ngIf="cell.participant_count">
                        <mat-icon class="people-icon">people</mat-icon>
                        {{ cell.participant_count }}
                      </span>
                    </div>

                    <!-- Hourly Rate -->
                    <div class="hourly-rate" *ngIf="currentViewOptions.show_hourly_rates && cell.hourly_rate">
                      {{ cell.hourly_rate | currency:'EUR':'symbol':'1.0-0' }}/h
                    </div>

                    <!-- Travel Time -->
                    <div class="travel-time" *ngIf="currentViewOptions.show_travel_time && cell.travel_time_minutes">
                      <mat-icon class="travel-icon">directions_car</mat-icon>
                      {{ cell.travel_time_minutes }}min
                    </div>

                    <!-- Conflict Indicator -->
                    <div class="conflict-indicator" *ngIf="cell.has_conflict">
                      <mat-icon class="conflict-icon">error</mat-icon>
                    </div>

                    <!-- Preferred Time Indicator -->
                    <div class="preferred-indicator" *ngIf="cell.is_preferred_time">
                      <mat-icon class="preferred-icon">favorite</mat-icon>
                    </div>
                  </div>

                  <!-- Context Menu -->
                  <mat-menu #cellMenu="matMenu">
                    <ng-container *ngIf="editable">
                      <button mat-menu-item
                              *ngIf="cell.status === 'available'"
                              (click)="onBlockTimeSlot(cell)">
                        <mat-icon>block</mat-icon>
                        {{ 'monitor.block_time_slot' | translate }}
                      </button>

                      <button mat-menu-item
                              *ngIf="cell.status === 'blocked'"
                              (click)="onUnblockTimeSlot(cell)">
                        <mat-icon>check_circle</mat-icon>
                        {{ 'monitor.unblock_time_slot' | translate }}
                      </button>

                      <button mat-menu-item
                              *ngIf="cell.status === 'available'">
                        <mat-icon>event</mat-icon>
                        {{ 'monitor.schedule_booking' | translate }}
                      </button>
                    </ng-container>

                    <button mat-menu-item>
                      <mat-icon>info</mat-icon>
                      {{ 'monitor.view_details' | translate }}
                    </button>
                  </mat-menu>

                  <!-- Right-click context menu trigger -->
                  <div class="context-menu-trigger"
                       [matMenuTriggerFor]="cellMenu"
                       (contextmenu)="$event.preventDefault(); $event.stopPropagation();">
                  </div>
                </td>
              </tr>
            </tbody>
          </table>

          <!-- No Data Message -->
          <div class="no-data" *ngIf="!isLoading && selectedMonitors.length === 0">
            <mat-icon>people_outline</mat-icon>
            <h3>{{ 'monitor.no_monitors_selected' | translate }}</h3>
            <p>{{ 'monitor.select_monitors_description' | translate }}</p>
          </div>

          <!-- No Availability Message -->
          <div class="no-data" *ngIf="!isLoading && selectedMonitors.length > 0 && availabilityMatrix.length === 0">
            <mat-icon>schedule</mat-icon>
            <h3>{{ 'monitor.no_availability_data' | translate }}</h3>
            <p>{{ 'monitor.no_availability_description' | translate }}</p>
          </div>
        </div>
      </div>

      <!-- Legend -->
      <div class="matrix-legend">
        <h4>{{ 'monitor.legend' | translate }}</h4>
        <div class="legend-items">
          <div class="legend-item" *ngFor="let status of statusConfig | keyvalue">
            <div class="legend-color" [style.background-color]="status.value.color">
              <mat-icon class="legend-icon">{{ status.value.icon }}</mat-icon>
            </div>
            <span class="legend-label">{{ status.value.label | translate }}</span>
          </div>

          <div class="legend-item" *ngIf="currentViewOptions.highlight_conflicts">
            <div class="legend-color conflict-color">
              <mat-icon class="legend-icon">error</mat-icon>
            </div>
            <span class="legend-label">{{ 'monitor.conflict' | translate }}</span>
          </div>

          <div class="legend-item">
            <div class="legend-color preferred-color">
              <mat-icon class="legend-icon">favorite</mat-icon>
            </div>
            <span class="legend-label">{{ 'monitor.preferred_time' | translate }}</span>
          </div>
        </div>
      </div>
    </mat-card-content>
  </mat-card>
</div>
