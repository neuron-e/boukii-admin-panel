<div class="booking-wizard-container">
  <!-- Header -->
  <div class="wizard-header">
    <h1 class="wizard-title">
      {{ isEditMode ? ('booking.edit_booking' | translate) : ('booking.new_booking' | translate) }}
    </h1>
    <div class="season-indicator" *ngIf="currentSeason$ | async as currentSeason">
      <mat-icon>schedule</mat-icon>
      <span>{{ currentSeason.name }}</span>
    </div>
  </div>

  <!-- Progress Indicator -->
  <div class="wizard-progress">
    <div class="progress-bar">
      <div class="progress-fill" [style.width.%]="((stepper?.selectedIndex || 0) + 1) / 5 * 100"></div>
    </div>
    <span class="progress-text">
      {{ ('booking.step' | translate) }} {{ (stepper?.selectedIndex || 0) + 1 }} {{ ('booking.of' | translate) }} 5
    </span>
  </div>

  <!-- Stepper -->
  <mat-stepper #stepper
               orientation="horizontal"
               [linear]="true"
               (selectionChange)="onStepChange($event)"
               class="booking-stepper">

    <!-- Step 1: Course Selection -->
    <mat-step [stepControl]="courseSelectionForm"
              [completed]="courseSelectionForm.valid"
              errorMessage="{{ 'booking.course_selection_required' | translate }}">
      <form [formGroup]="courseSelectionForm">
        <ng-template matStepLabel>
          <mat-icon>school</mat-icon>
          {{ 'booking.course_selection' | translate }}
        </ng-template>

        <div class="step-content">
          <h2>{{ 'booking.select_course_and_client' | translate }}</h2>

          <!-- Course Selection -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'booking.course' | translate }}</mat-label>
            <mat-select formControlName="course_id" [disabled]="isLoadingCourses">
              <mat-option *ngFor="let course of availableCourses$ | async" [value]="course.id">
                <div class="course-option">
                  <span class="course-name">{{ course.name }}</span>
                  <span class="course-price">{{ course.pricing?.base_price | currency:'EUR':'symbol':'1.2-2' }}</span>
                </div>
              </mat-option>
            </mat-select>
            <mat-error *ngIf="courseSelectionForm.get('course_id')?.hasError('required')">
              {{ 'booking.course_required' | translate }}
            </mat-error>
            <mat-progress-bar mode="indeterminate" *ngIf="isLoadingCourses"></mat-progress-bar>
          </mat-form-field>

          <!-- Client Selection -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'booking.client' | translate }}</mat-label>
            <mat-select formControlName="client_id">
              <!-- Client options would be loaded from client service -->
              <mat-option value="">Select client...</mat-option>
            </mat-select>
            <mat-error *ngIf="courseSelectionForm.get('client_id')?.hasError('required')">
              {{ 'booking.client_required' | translate }}
            </mat-error>
          </mat-form-field>

          <!-- Course Details Preview -->
          <div class="course-preview" *ngIf="selectedCourse">
            <mat-card>
              <mat-card-header>
                <mat-card-title>{{ selectedCourse.name }}</mat-card-title>
                <mat-card-subtitle>{{ selectedCourse.description }}</mat-card-subtitle>
              </mat-card-header>
              <mat-card-content>
                <div class="course-details">
                  <div class="detail-item">
                    <mat-icon>schedule</mat-icon>
                    <span>{{ selectedCourse.settings?.duration || 'N/A' }}</span>
                  </div>
                  <div class="detail-item">
                    <mat-icon>people</mat-icon>
                    <span>{{ selectedCourse.pricing?.min_participants }} - {{ selectedCourse.pricing?.max_participants }} participants</span>
                  </div>
                  <div class="detail-item">
                    <mat-icon>location_on</mat-icon>
                    <span>{{ selectedCourse.settings?.location?.name || 'Location TBD' }}</span>
                  </div>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>

        <div class="step-actions">
          <button mat-raised-button
                  color="primary"
                  [disabled]="!courseSelectionForm.valid"
                  (click)="nextStep()">
            {{ 'booking.continue' | translate }}
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Step 2: Date & Time Selection -->
    <mat-step [stepControl]="dateTimeForm"
              [completed]="dateTimeForm.valid"
              errorMessage="{{ 'booking.date_time_required' | translate }}">
      <form [formGroup]="dateTimeForm">
        <ng-template matStepLabel>
          <mat-icon>event</mat-icon>
          {{ 'booking.date_time' | translate }}
        </ng-template>

        <div class="step-content">
          <h2>{{ 'booking.select_date_and_time' | translate }}</h2>

          <!-- Date Selection -->
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>{{ 'booking.course_date' | translate }}</mat-label>
            <input matInput
                   [matDatepicker]="datePicker"
                   formControlName="course_date">
            <mat-datepicker-toggle matSuffix [for]="datePicker"></mat-datepicker-toggle>
            <mat-datepicker #datePicker></mat-datepicker>
            <mat-error *ngIf="dateTimeForm.get('course_date')?.hasError('required')">
              {{ 'booking.date_required' | translate }}
            </mat-error>
            <mat-error *ngIf="dateTimeForm.get('course_date')?.hasError('dateInFuture')">
              {{ 'booking.date_future_required' | translate }}
            </mat-error>
          </mat-form-field>

          <!-- Participant Count -->
          <mat-form-field appearance="outline" class="half-width">
            <mat-label>{{ 'booking.participants' | translate }}</mat-label>
            <input matInput
                   type="number"
                   formControlName="participant_count"
                   min="1"
                   max="50">
            <mat-error *ngIf="dateTimeForm.get('participant_count')?.hasError('required')">
              {{ 'booking.participants_required' | translate }}
            </mat-error>
            <mat-error *ngIf="dateTimeForm.get('participant_count')?.hasError('min')">
              {{ 'booking.min_participants' | translate }}
            </mat-error>
          </mat-form-field>

          <!-- Time Slot Selection -->
          <div class="time-slots-section" *ngIf="dateTimeForm.get('course_date')?.value">
            <h3>{{ 'booking.available_times' | translate }}</h3>

            <div class="loading-indicator" *ngIf="isLoadingAvailability">
              <mat-progress-bar mode="indeterminate"></mat-progress-bar>
              <span>{{ 'booking.checking_availability' | translate }}</span>
            </div>

            <mat-form-field appearance="outline" class="full-width" *ngIf="!isLoadingAvailability">
              <mat-label>{{ 'booking.time_slot' | translate }}</mat-label>
              <mat-select formControlName="time_slot_id">
                <!-- Time slots would be populated based on availability -->
                <mat-option value="">Select time slot...</mat-option>
              </mat-select>
              <mat-error *ngIf="dateTimeForm.get('time_slot_id')?.hasError('required')">
                {{ 'booking.time_slot_required' | translate }}
              </mat-error>
            </mat-form-field>
          </div>

          <!-- Availability Warnings -->
          <div class="availability-warnings" *ngIf="availabilityResult$ | async as availability">
            <mat-card class="warning-card" *ngFor="let restriction of availability.restrictions">
              <mat-card-content>
                <div class="warning-content">
                  <mat-icon [class]="'warning-' + restriction.severity">warning</mat-icon>
                  <span>{{ restriction.message }}</span>
                </div>
              </mat-card-content>
            </mat-card>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button (click)="previousStep()">
            {{ 'booking.back' | translate }}
          </button>
          <button mat-raised-button
                  color="primary"
                  [disabled]="!dateTimeForm.valid"
                  (click)="nextStep()">
            {{ 'booking.continue' | translate }}
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Step 3: Participants Information -->
    <mat-step [stepControl]="participantsForm"
              [completed]="participantsForm.valid"
              errorMessage="{{ 'booking.participants_info_required' | translate }}">
      <form [formGroup]="participantsForm">
        <ng-template matStepLabel>
          <mat-icon>people</mat-icon>
          {{ 'booking.participants' | translate }}
        </ng-template>

        <div class="step-content">
          <h2>{{ 'booking.participant_information' | translate }}</h2>

          <div formArrayName="participants">
            <mat-expansion-panel *ngFor="let participantForm of participantsArray.controls; let i = index"
                                 [formGroupName]="i"
                                 class="participant-panel">
              <mat-expansion-panel-header>
                <mat-panel-title>
                  {{ 'booking.participant' | translate }} {{ i + 1 }}
                </mat-panel-title>
                <mat-panel-description>
                  {{ participantForm.get('name')?.value || ('booking.enter_details' | translate) }}
                </mat-panel-description>
              </mat-expansion-panel-header>

              <div class="participant-form">
                <!-- Participant Basic Info -->
                <div class="form-row">
                  <mat-form-field appearance="outline" class="half-width">
                    <mat-label>{{ 'booking.full_name' | translate }}</mat-label>
                    <input matInput formControlName="name">
                    <mat-error *ngIf="participantForm.get('name')?.hasError('required')">
                      {{ 'booking.name_required' | translate }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="quarter-width">
                    <mat-label>{{ 'booking.age' | translate }}</mat-label>
                    <input matInput type="number" formControlName="age" min="5" max="99">
                    <mat-error *ngIf="participantForm.get('age')?.hasError('required')">
                      {{ 'booking.age_required' | translate }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="quarter-width">
                    <mat-label>{{ 'booking.birth_date' | translate }}</mat-label>
                    <input matInput [matDatepicker]="birthPicker" formControlName="birth_date">
                    <mat-datepicker-toggle matSuffix [for]="birthPicker"></mat-datepicker-toggle>
                    <mat-datepicker #birthPicker></mat-datepicker>
                  </mat-form-field>
                </div>

                <!-- Emergency Contact -->
                <div class="form-row">
                  <mat-form-field appearance="outline" class="half-width">
                    <mat-label>{{ 'booking.emergency_contact' | translate }}</mat-label>
                    <input matInput formControlName="emergency_contact">
                    <mat-error *ngIf="participantForm.get('emergency_contact')?.hasError('required')">
                      {{ 'booking.emergency_contact_required' | translate }}
                    </mat-error>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="half-width">
                    <mat-label>{{ 'booking.emergency_phone' | translate }}</mat-label>
                    <input matInput formControlName="emergency_phone" type="tel">
                    <mat-error *ngIf="participantForm.get('emergency_phone')?.hasError('required')">
                      {{ 'booking.emergency_phone_required' | translate }}
                    </mat-error>
                  </mat-form-field>
                </div>

                <!-- Additional Information -->
                <div class="form-row">
                  <mat-form-field appearance="outline" class="half-width">
                    <mat-label>{{ 'booking.skill_level' | translate }}</mat-label>
                    <mat-select formControlName="skill_level">
                      <mat-option value="beginner">{{ 'booking.beginner' | translate }}</mat-option>
                      <mat-option value="intermediate">{{ 'booking.intermediate' | translate }}</mat-option>
                      <mat-option value="advanced">{{ 'booking.advanced' | translate }}</mat-option>
                      <mat-option value="expert">{{ 'booking.expert' | translate }}</mat-option>
                    </mat-select>
                  </mat-form-field>

                  <div class="half-width checkbox-field">
                    <mat-checkbox formControlName="previous_experience">
                      {{ 'booking.previous_experience' | translate }}
                    </mat-checkbox>
                  </div>
                </div>

                <!-- Medical Conditions and Dietary Restrictions -->
                <div class="form-row">
                  <mat-form-field appearance="outline" class="half-width">
                    <mat-label>{{ 'booking.medical_conditions' | translate }}</mat-label>
                    <textarea matInput formControlName="medical_conditions" rows="3"></textarea>
                  </mat-form-field>

                  <mat-form-field appearance="outline" class="half-width">
                    <mat-label>{{ 'booking.dietary_restrictions' | translate }}</mat-label>
                    <textarea matInput formControlName="dietary_restrictions" rows="3"></textarea>
                  </mat-form-field>
                </div>
              </div>
            </mat-expansion-panel>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button (click)="previousStep()">
            {{ 'booking.back' | translate }}
          </button>
          <button mat-raised-button
                  color="primary"
                  [disabled]="!participantsForm.valid"
                  (click)="nextStep()">
            {{ 'booking.continue' | translate }}
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Step 4: Extras and Equipment -->
    <mat-step [stepControl]="extrasForm"
              [completed]="extrasForm.valid">
      <form [formGroup]="extrasForm">
        <ng-template matStepLabel>
          <mat-icon>add_circle</mat-icon>
          {{ 'booking.extras' | translate }}
        </ng-template>

        <div class="step-content">
          <h2>{{ 'booking.additional_services' | translate }}</h2>

          <!-- Equipment Rental -->
          <div class="equipment-section">
            <h3>{{ 'booking.equipment_rental' | translate }}</h3>
            <!-- Equipment rental options would be populated here -->
          </div>

          <!-- Special Requirements -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'booking.special_requirements' | translate }}</mat-label>
            <textarea matInput formControlName="special_requirements" rows="4"></textarea>
          </mat-form-field>

          <!-- Notes -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'booking.notes' | translate }}</mat-label>
            <textarea matInput formControlName="notes" rows="3"></textarea>
          </mat-form-field>

          <!-- Insurance Option -->
          <div class="insurance-section">
            <mat-checkbox formControlName="insurance_required">
              {{ 'booking.insurance_required' | translate }}
            </mat-checkbox>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button (click)="previousStep()">
            {{ 'booking.back' | translate }}
          </button>
          <button mat-raised-button
                  color="primary"
                  (click)="nextStep()">
            {{ 'booking.continue' | translate }}
          </button>
        </div>
      </form>
    </mat-step>

    <!-- Step 5: Payment and Confirmation -->
    <mat-step [stepControl]="paymentForm"
              [completed]="paymentForm.valid"
              errorMessage="{{ 'booking.payment_info_required' | translate }}">
      <form [formGroup]="paymentForm">
        <ng-template matStepLabel>
          <mat-icon>payment</mat-icon>
          {{ 'booking.payment' | translate }}
        </ng-template>

        <div class="step-content">
          <h2>{{ 'booking.review_and_confirm' | translate }}</h2>

          <!-- Pricing Summary -->
          <div class="pricing-summary" *ngIf="currentPricing$ | async as pricing">
            <mat-card>
              <mat-card-header>
                <mat-card-title>{{ 'booking.pricing_summary' | translate }}</mat-card-title>
              </mat-card-header>
              <mat-card-content>
                <div class="pricing-line" *ngFor="let item of pricing.pricing_breakdown">
                  <span>{{ item.description }}</span>
                  <span>{{ item.total_price | currency:'EUR':'symbol':'1.2-2' }}</span>
                </div>
                <mat-divider></mat-divider>
                <div class="pricing-total">
                  <span>{{ 'booking.total' | translate }}</span>
                  <span class="total-amount">{{ pricing.total_amount | currency:'EUR':'symbol':'1.2-2' }}</span>
                </div>
              </mat-card-content>
            </mat-card>
          </div>

          <!-- Loading Indicator -->
          <div class="pricing-loading" *ngIf="isCalculatingPricing">
            <mat-progress-bar mode="indeterminate"></mat-progress-bar>
            <span>{{ 'booking.calculating_pricing' | translate }}</span>
          </div>

          <!-- Discount Code -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'booking.discount_code' | translate }}</mat-label>
            <input matInput formControlName="discount_code">
            <button mat-button matSuffix type="button">{{ 'booking.apply' | translate }}</button>
          </mat-form-field>

          <!-- Payment Method -->
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>{{ 'booking.payment_method' | translate }}</mat-label>
            <mat-select formControlName="payment_method">
              <mat-option value="card">{{ 'booking.card' | translate }}</mat-option>
              <mat-option value="transfer">{{ 'booking.bank_transfer' | translate }}</mat-option>
              <mat-option value="cash">{{ 'booking.cash' | translate }}</mat-option>
            </mat-select>
            <mat-error *ngIf="paymentForm.get('payment_method')?.hasError('required')">
              {{ 'booking.payment_method_required' | translate }}
            </mat-error>
          </mat-form-field>

          <!-- Terms and Conditions -->
          <div class="terms-section">
            <mat-checkbox formControlName="accept_terms">
              {{ 'booking.accept_terms' | translate }}
              <a href="#" target="_blank">{{ 'booking.terms_and_conditions' | translate }}</a>
            </mat-checkbox>
            <mat-error *ngIf="paymentForm.get('accept_terms')?.hasError('required')">
              {{ 'booking.terms_acceptance_required' | translate }}
            </mat-error>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button (click)="previousStep()">
            {{ 'booking.back' | translate }}
          </button>
          <button mat-raised-button
                  color="primary"
                  [disabled]="!paymentForm.valid || isSubmitting"
                  (click)="onSubmit()">
            <mat-progress-spinner diameter="20" *ngIf="isSubmitting"></mat-progress-spinner>
            {{ isEditMode ? ('booking.update_booking' | translate) : ('booking.create_booking' | translate) }}
          </button>
        </div>
      </form>
    </mat-step>
  </mat-stepper>
</div>
