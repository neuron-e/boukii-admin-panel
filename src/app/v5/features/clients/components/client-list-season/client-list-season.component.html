<div class="client-list-container" [class.loading]="loading$ | async">
  <!-- Header Section -->
  <div class="page-header">
    <div class="header-content">
      <div class="title-section">
        <h1 class="page-title">
          <mat-icon>people</mat-icon>
          {{ 'client_list.title' | translate }}
        </h1>
        <p class="page-subtitle">{{ 'client_list.subtitle' | translate }}</p>
      </div>

      <!-- Season Info -->
      <div class="season-info" *ngIf="currentSeason$ | async as season">
        <mat-chip-list>
          <mat-chip selected>
            <mat-icon matChipAvatar>event</mat-icon>
            {{ season.name }} {{ season.year }}
          </mat-chip>
        </mat-chip-list>
      </div>

      <!-- Action Buttons -->
      <div class="header-actions">
        <button mat-icon-button (click)="refreshData()" [disabled]="loading$ | async" matTooltip="{{ 'common.refresh' | translate }}">
          <mat-icon>refresh</mat-icon>
        </button>
        <button mat-raised-button color="primary" (click)="createClient()">
          <mat-icon>person_add</mat-icon>
          {{ 'client_list.new_client' | translate }}
        </button>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="stats-section" *ngIf="stats$ | async as stats" @slideInOut>
    <div class="stats-grid">
      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon class="stat-icon primary">people</mat-icon>
            <div class="stat-data">
              <span class="stat-number">{{ stats.total_clients | number }}</span>
              <span class="stat-label">{{ 'client_list.total_clients' | translate }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon class="stat-icon success">check_circle</mat-icon>
            <div class="stat-data">
              <span class="stat-number">{{ stats.active_clients | number }}</span>
              <span class="stat-label">{{ 'client_list.active_clients' | translate }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon class="stat-icon accent">trending_up</mat-icon>
            <div class="stat-data">
              <span class="stat-number">{{ stats.new_clients_this_month | number }}</span>
              <span class="stat-label">{{ 'client_list.new_this_month' | translate }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>

      <mat-card class="stat-card">
        <mat-card-content>
          <div class="stat-content">
            <mat-icon class="stat-icon warn">star</mat-icon>
            <div class="stat-data">
              <span class="stat-number">{{ stats.vip_clients | number }}</span>
              <span class="stat-label">{{ 'client_list.vip_clients' | translate }}</span>
            </div>
          </div>
        </mat-card-content>
      </mat-card>
    </div>
  </div>

  <!-- Search and Filters Section -->
  <mat-card class="filters-card">
    <mat-card-content>
      <form [formGroup]="filterForm" class="filters-form">
        <!-- Main Search Bar -->
        <div class="search-section">
          <mat-form-field appearance="outline" class="search-field">
            <mat-label>{{ 'client_list.search_placeholder' | translate }}</mat-label>
            <input matInput
                   formControlName="search"
                   (input)="onSearchChange($event.target)"
                   placeholder="{{ 'client_list.search_hint' | translate }}">
            <mat-icon matPrefix>search</mat-icon>
            <button matSuffix mat-icon-button (click)="clearSearch()" *ngIf="searchQuery">
              <mat-icon>clear</mat-icon>
            </button>
          </mat-form-field>

          <!-- Quick Filter Buttons -->
          <div class="quick-filters">
            <button mat-stroked-button (click)="applyQuickFilter('status', 'active')" class="quick-filter-btn">
              <mat-icon>check_circle</mat-icon>
              {{ 'client_list.active_only' | translate }}
            </button>
            <button mat-stroked-button (click)="applyQuickFilter('vip', true)" class="quick-filter-btn">
              <mat-icon>star</mat-icon>
              {{ 'client_list.vip_only' | translate }}
            </button>
            <button mat-stroked-button (click)="applyQuickFilter('new_clients', true)" class="quick-filter-btn">
              <mat-icon>new_releases</mat-icon>
              {{ 'client_list.new_clients' | translate }}
            </button>
            <button mat-stroked-button (click)="applyQuickFilter('with_bookings', true)" class="quick-filter-btn">
              <mat-icon>event_available</mat-icon>
              {{ 'client_list.with_bookings' | translate }}
            </button>
          </div>

          <!-- Advanced Filters Toggle -->
          <button mat-icon-button
                  (click)="toggleAdvancedFilters()"
                  [class.active]="showAdvancedFilters"
                  matTooltip="{{ 'client_list.advanced_filters' | translate }}">
            <mat-icon>tune</mat-icon>
          </button>
        </div>

        <!-- Advanced Filters Panel -->
        <div class="advanced-filters" *ngIf="showAdvancedFilters" @slideInOut>
          <div class="filters-grid">
            <!-- Status Filter -->
            <mat-form-field appearance="outline">
              <mat-label>{{ 'client_list.status' | translate }}</mat-label>
              <mat-select formControlName="status" multiple>
                <mat-option *ngFor="let status of statusOptions" [value]="status.value">
                  {{ status.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Client Type Filter -->
            <mat-form-field appearance="outline">
              <mat-label>{{ 'client_list.client_type' | translate }}</mat-label>
              <mat-select formControlName="client_type" multiple>
                <mat-option *ngFor="let type of clientTypeOptions" [value]="type.value">
                  {{ type.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Loyalty Level Filter -->
            <mat-form-field appearance="outline">
              <mat-label>{{ 'client_list.loyalty_level' | translate }}</mat-label>
              <mat-select formControlName="loyalty_level" multiple>
                <mat-option *ngFor="let level of loyaltyLevelOptions" [value]="level.value">
                  {{ level.label }}
                </mat-option>
              </mat-select>
            </mat-form-field>

            <!-- Location Filters -->
            <mat-form-field appearance="outline">
              <mat-label>{{ 'client_list.city' | translate }}</mat-label>
              <input matInput formControlName="city">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{ 'client_list.province' | translate }}</mat-label>
              <input matInput formControlName="province">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{ 'client_list.country' | translate }}</mat-label>
              <input matInput formControlName="country">
            </mat-form-field>

            <!-- Age Range -->
            <mat-form-field appearance="outline">
              <mat-label>{{ 'client_list.age_from' | translate }}</mat-label>
              <input matInput type="number" formControlName="age_from" min="0" max="120">
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{ 'client_list.age_to' | translate }}</mat-label>
              <input matInput type="number" formControlName="age_to" min="0" max="120">
            </mat-form-field>

            <!-- Spending Range -->
            <mat-form-field appearance="outline">
              <mat-label>{{ 'client_list.total_spent_from' | translate }}</mat-label>
              <input matInput type="number" formControlName="total_spent_from" min="0">
              <span matPrefix>â‚¬&nbsp;</span>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{ 'client_list.total_spent_to' | translate }}</mat-label>
              <input matInput type="number" formControlName="total_spent_to" min="0">
              <span matPrefix>â‚¬&nbsp;</span>
            </mat-form-field>

            <!-- Date Ranges -->
            <mat-form-field appearance="outline">
              <mat-label>{{ 'client_list.registration_from' | translate }}</mat-label>
              <input matInput [matDatepicker]="regFromPicker" formControlName="registration_from">
              <mat-datepicker-toggle matSuffix [for]="regFromPicker"></mat-datepicker-toggle>
              <mat-datepicker #regFromPicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>{{ 'client_list.registration_to' | translate }}</mat-label>
              <input matInput [matDatepicker]="regToPicker" formControlName="registration_to">
              <mat-datepicker-toggle matSuffix [for]="regToPicker"></mat-datepicker-toggle>
              <mat-datepicker #regToPicker></mat-datepicker>
            </mat-form-field>
          </div>

          <!-- Boolean Filters -->
          <div class="boolean-filters">
            <mat-checkbox formControlName="vip_only">{{ 'client_list.vip_only' | translate }}</mat-checkbox>
            <mat-checkbox formControlName="has_upcoming_bookings">{{ 'client_list.has_upcoming_bookings' | translate }}</mat-checkbox>
            <mat-checkbox formControlName="has_outstanding_balance">{{ 'client_list.has_outstanding_balance' | translate }}</mat-checkbox>
            <mat-checkbox formControlName="with_email">{{ 'client_list.with_email' | translate }}</mat-checkbox>
            <mat-checkbox formControlName="with_phone">{{ 'client_list.with_phone' | translate }}</mat-checkbox>
            <mat-checkbox formControlName="with_emergency_contact">{{ 'client_list.with_emergency_contact' | translate }}</mat-checkbox>
          </div>

          <!-- Filter Actions -->
          <div class="filter-actions">
            <button mat-stroked-button (click)="clearFilters()">
              <mat-icon>clear_all</mat-icon>
              {{ 'common.clear_filters' | translate }}
            </button>
          </div>
        </div>
      </form>
    </mat-card-content>
  </mat-card>

  <!-- Bulk Actions Bar -->
  <div class="bulk-actions-bar" *ngIf="getSelectedCount() > 0" @slideInOut>
    <div class="selection-info">
      <mat-checkbox
        [checked]="selectAll"
        [indeterminate]="getSelectedCount() > 0 && !selectAll"
        (change)="toggleSelectAll()">
      </mat-checkbox>
      <span class="selection-text">
        {{ getSelectedCount() }} {{ 'client_list.selected' | translate }}
      </span>
    </div>

    <div class="bulk-actions">
      <button mat-stroked-button (click)="bulkExportSelected()">
        <mat-icon>file_download</mat-icon>
        {{ 'client_list.export_selected' | translate }}
      </button>
      <button mat-stroked-button color="warn" (click)="bulkDeleteSelected()">
        <mat-icon>delete</mat-icon>
        {{ 'client_list.delete_selected' | translate }}
      </button>
      <button mat-icon-button (click)="clearSelection()" matTooltip="{{ 'common.clear_selection' | translate }}">
        <mat-icon>close</mat-icon>
      </button>
    </div>
  </div>

  <!-- Data Table -->
  <mat-card class="table-card">
    <mat-card-content>
      <!-- Loading Overlay -->
      <div class="loading-overlay" *ngIf="loading$ | async" @fadeInOut>
        <mat-spinner diameter="50"></mat-spinner>
        <p>{{ 'client_list.loading' | translate }}</p>
      </div>

      <!-- Table -->
      <div class="table-container">
        <table mat-table [dataSource]="dataSource" matSort (matSortChange)="onSortChange($event)" class="clients-table">

          <!-- Selection Column -->
          <ng-container matColumnDef="select">
            <th mat-header-cell *matHeaderCellDef class="select-column">
              <mat-checkbox
                [checked]="selectAll"
                [indeterminate]="getSelectedCount() > 0 && !selectAll"
                (change)="toggleSelectAll()">
              </mat-checkbox>
            </th>
            <td mat-cell *matCellDef="let client" class="select-column">
              <mat-checkbox
                [checked]="isClientSelected(client.id)"
                (change)="toggleClientSelection(client.id)">
              </mat-checkbox>
            </td>
          </ng-container>

          <!-- Avatar Column -->
          <ng-container matColumnDef="avatar">
            <th mat-header-cell *matHeaderCellDef class="avatar-column">{{ 'client_list.avatar' | translate }}</th>
            <td mat-cell *matCellDef="let client" class="avatar-column">
              <div class="client-avatar">
                <img *ngIf="client.profile_picture" [src]="client.profile_picture" [alt]="getClientFullName(client)" />
                <div *ngIf="!client.profile_picture" class="avatar-placeholder">
                  {{ client.first_name?.charAt(0) }}{{ client.last_name?.charAt(0) }}
                </div>
              </div>
            </td>
          </ng-container>

          <!-- Name Column -->
          <ng-container matColumnDef="name">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="last_name">{{ 'client_list.name' | translate }}</th>
            <td mat-cell *matCellDef="let client">
              <div class="client-name">
                <span class="name-text">{{ getClientFullName(client) }}</span>
                <mat-icon *ngIf="client.vip_status" class="vip-icon" matTooltip="{{ 'client_list.vip_client' | translate }}">star</mat-icon>
              </div>
            </td>
          </ng-container>

          <!-- Email Column -->
          <ng-container matColumnDef="email">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="email">{{ 'client_list.email' | translate }}</th>
            <td mat-cell *matCellDef="let client">
              <a [href]="'mailto:' + client.email" class="email-link">{{ client.email }}</a>
            </td>
          </ng-container>

          <!-- Phone Column -->
          <ng-container matColumnDef="phone">
            <th mat-header-cell *matHeaderCellDef>{{ 'client_list.phone' | translate }}</th>
            <td mat-cell *matCellDef="let client">
              <a *ngIf="client.phone" [href]="'tel:' + client.phone" class="phone-link">{{ client.phone }}</a>
              <span *ngIf="!client.phone" class="no-data">-</span>
            </td>
          </ng-container>

          <!-- City Column -->
          <ng-container matColumnDef="city">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="city">{{ 'client_list.city' | translate }}</th>
            <td mat-cell *matCellDef="let client">
              <span *ngIf="client.address?.city">{{ client.address.city }}</span>
              <span *ngIf="!client.address?.city" class="no-data">-</span>
            </td>
          </ng-container>

          <!-- Status Column -->
          <ng-container matColumnDef="status">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="status">{{ 'client_list.status' | translate }}</th>
            <td mat-cell *matCellDef="let client">
              <mat-chip [class]="'status-' + client.status" [color]="getStatusColor(client.status)">
                {{ getClientStatusLabel(client.status) }}
              </mat-chip>
            </td>
          </ng-container>

          <!-- Client Type Column -->
          <ng-container matColumnDef="client_type">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="client_type">{{ 'client_list.client_type' | translate }}</th>
            <td mat-cell *matCellDef="let client">
              <mat-chip class="type-chip">{{ getClientTypeLabel(client.client_type) }}</mat-chip>
            </td>
          </ng-container>

          <!-- Loyalty Level Column -->
          <ng-container matColumnDef="loyalty_level">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="loyalty_level">{{ 'client_list.loyalty_level' | translate }}</th>
            <td mat-cell *matCellDef="let client">
              <div class="loyalty-badge" [style.background-color]="getLoyaltyColor(client.loyalty_level)">
                <mat-icon>{{ client.loyalty_level === 'diamond' ? 'diamond' : 'star' }}</mat-icon>
                <span>{{ getLoyaltyLevelLabel(client.loyalty_level) }}</span>
              </div>
            </td>
          </ng-container>

          <!-- Total Bookings Column -->
          <ng-container matColumnDef="total_bookings">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="total_bookings">{{ 'client_list.total_bookings' | translate }}</th>
            <td mat-cell *matCellDef="let client">
              <span class="metric-number">{{ client.booking_stats?.total_bookings || 0 }}</span>
            </td>
          </ng-container>

          <!-- Total Spent Column -->
          <ng-container matColumnDef="total_spent">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="total_spent">{{ 'client_list.total_spent' | translate }}</th>
            <td mat-cell *matCellDef="let client">
              <span class="currency-amount">{{ formatCurrency(client.booking_stats?.total_spent || 0) }}</span>
            </td>
          </ng-container>

          <!-- Last Booking Column -->
          <ng-container matColumnDef="last_booking">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="last_booking_date">{{ 'client_list.last_booking' | translate }}</th>
            <td mat-cell *matCellDef="let client">
              <span *ngIf="client.booking_stats?.last_booking_date" class="date-text">
                {{ formatDate(client.booking_stats.last_booking_date) }}
              </span>
              <span *ngIf="!client.booking_stats?.last_booking_date" class="no-data">-</span>
            </td>
          </ng-container>

          <!-- Created At Column -->
          <ng-container matColumnDef="created_at">
            <th mat-header-cell *matHeaderCellDef mat-sort-header="created_at">{{ 'client_list.created_at' | translate }}</th>
            <td mat-cell *matCellDef="let client">
              <span class="date-text">{{ formatDate(client.created_at) }}</span>
            </td>
          </ng-container>

          <!-- Actions Column -->
          <ng-container matColumnDef="actions">
            <th mat-header-cell *matHeaderCellDef class="actions-column">{{ 'common.actions' | translate }}</th>
            <td mat-cell *matCellDef="let client" class="actions-column">
              <div class="action-buttons">
                <button mat-icon-button (click)="viewClient(client)" matTooltip="{{ 'common.view' | translate }}">
                  <mat-icon>visibility</mat-icon>
                </button>
                <button mat-icon-button (click)="editClient(client)" matTooltip="{{ 'common.edit' | translate }}">
                  <mat-icon>edit</mat-icon>
                </button>
                <button mat-icon-button (click)="viewClientBookings(client)" matTooltip="{{ 'client_list.view_bookings' | translate }}">
                  <mat-icon>event</mat-icon>
                </button>
                <button mat-icon-button [matMenuTriggerFor]="clientMenu" matTooltip="{{ 'common.more_actions' | translate }}">
                  <mat-icon>more_vert</mat-icon>
                </button>

                <mat-menu #clientMenu="matMenu">
                  <button mat-menu-item (click)="deleteClient(client)">
                    <mat-icon color="warn">delete</mat-icon>
                    <span>{{ 'common.delete' | translate }}</span>
                  </button>
                </mat-menu>
              </div>
            </td>
          </ng-container>

          <tr mat-header-row *matHeaderRowDef="displayedColumns; sticky: true"></tr>
          <tr mat-row *matRowDef="let client; columns: displayedColumns;"
              [class.selected]="isClientSelected(client.id)"
              (click)="viewClient(client)"></tr>
        </table>

        <!-- No Data Message -->
        <div class="no-data-message" *ngIf="!loading$ && dataSource.data.length === 0" @fadeInOut>
          <mat-icon>people_outline</mat-icon>
          <h3>{{ 'client_list.no_clients' | translate }}</h3>
          <p>{{ 'client_list.no_clients_description' | translate }}</p>
          <button mat-raised-button color="primary" (click)="createClient()">
            <mat-icon>person_add</mat-icon>
            {{ 'client_list.create_first_client' | translate }}
          </button>
        </div>
      </div>

      <!-- Pagination -->
      <mat-paginator
        [length]="totalItems"
        [pageSize]="pageSize"
        [pageSizeOptions]="pageSizeOptions"
        [pageIndex]="currentPage"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>
    </mat-card-content>
  </mat-card>
</div>
