<div class="reservation-dialog">
  <div class="dialog-header">
    <h2>Nueva Reserva</h2>
    <div class="step-indicator">
      <span>Paso {{ currentStep }} de {{ totalSteps }}</span>
    </div>
    <button mat-icon-button mat-dialog-close>
      <mat-icon>close</mat-icon>
    </button>
  </div>

  <mat-horizontal-stepper #stepper [linear]="true" class="reservation-stepper">
    <!-- Step 1: Client Selection -->
    <mat-step [stepControl]="clientForm" label="Cliente">
      <form [formGroup]="clientForm" class="step-form">
        <h3>Selecciona el cliente</h3>
        <p>Elige para quien crear la reserva. Puedes buscar por nombre o email.</p>

        <mat-form-field appearance="outline" class="client-search">
          <mat-label>Buscar cliente por nombre o email...</mat-label>
          <input matInput
                 formControlName="clientSearch"
                 [matAutocomplete]="clientAutocomplete">
          <mat-icon matSuffix>search</mat-icon>
          <mat-autocomplete #clientAutocomplete="matAutocomplete" [displayWith]="displayClientFn">
            <mat-option *ngFor="let client of filteredClients" [value]="client" class="client-option">
              <div class="client-avatar">{{ client.initials }}</div>
              <div class="client-details">
                <div class="client-name">{{ client.name }}</div>
                <div class="client-info">
                  <span class="client-age">{{ client.age }} años</span>
                  <span class="client-level">• {{ client.level }}</span>
                  <span class="client-location">• {{ client.location }}</span>
                </div>
              </div>
            </mat-option>
          </mat-autocomplete>
        </mat-form-field>

        <div class="selected-client" *ngIf="selectedClient">
          <div class="client-card">
            <div class="client-avatar">{{ selectedClient.initials }}</div>
            <div class="client-info">
              <div class="client-name">{{ selectedClient.name }}</div>
              <div class="client-details">{{ selectedClient.age }} años • {{ selectedClient.level }} • {{ selectedClient.location }}</div>
            </div>
            <button mat-icon-button (click)="clearClient()">
              <mat-icon>clear</mat-icon>
            </button>
          </div>
        </div>

        <div class="create-client-section">
          <button mat-button class="create-client-btn" type="button">
            <mat-icon>person_add</mat-icon>
            Crear nuevo cliente
          </button>
        </div>

        <div class="step-actions">
          <button mat-button matStepperPrevious disabled>Anterior</button>
          <button mat-raised-button color="primary" matStepperNext [disabled]="!clientForm.valid">Siguiente</button>
        </div>
      </form>
    </mat-step>

    <!-- Step 2: Service Type -->
    <mat-step [stepControl]="typeForm" label="Tipo">
      <form [formGroup]="typeForm" class="step-form">
        <h3>Tipo de reserva</h3>
        <p>Selecciona el tipo de servicio para {{ selectedClient?.name }}</p>

        <div class="service-types">
          <mat-radio-group formControlName="serviceType" class="service-radio-group">
            <div class="service-option" *ngFor="let service of serviceTypes">
              <mat-radio-button [value]="service.id" class="service-radio">
                <div class="service-content">
                  <div class="service-icon" [ngClass]="service.iconClass">
                    <mat-icon>{{ service.icon }}</mat-icon>
                  </div>
                  <div class="service-info">
                    <div class="service-name">{{ service.name }}</div>
                    <div class="service-description">{{ service.description }}</div>
                  </div>
                </div>
              </mat-radio-button>
            </div>
          </mat-radio-group>
        </div>

        <div class="step-actions">
          <button mat-button matStepperPrevious>Anterior</button>
          <button mat-raised-button color="primary" matStepperNext [disabled]="!typeForm.valid">Siguiente</button>
        </div>
      </form>
    </mat-step>

    <!-- Step 3: Details -->
    <mat-step [stepControl]="detailsForm" label="Detalles">
      <form [formGroup]="detailsForm" class="step-form">
        <h3>Detalles</h3>
        <p>Resumen</p>

        <div class="details-section" [ngSwitch]="selectedServiceType">
          <!-- Course Details -->
          <div *ngSwitchCase="'curso'" class="course-details">
            <mat-form-field appearance="outline">
              <mat-label>Curso</mat-label>
              <mat-select formControlName="courseId">
                <mat-option value="principiante">Curso Principiante</mat-option>
                <mat-option value="intermedio">Curso Intermedio</mat-option>
                <mat-option value="avanzado">Curso Avanzado</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Fecha</mat-label>
              <input matInput [matDatepicker]="datePicker" formControlName="date">
              <mat-datepicker-toggle matSuffix [for]="datePicker"></mat-datepicker-toggle>
              <mat-datepicker #datePicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Nivel</mat-label>
              <mat-select formControlName="level">
                <mat-option value="principiante">Principiante</mat-option>
                <mat-option value="intermedio">Intermedio</mat-option>
                <mat-option value="avanzado">Avanzado</mat-option>
              </mat-select>
            </mat-form-field>
          </div>

          <!-- Activity Details -->
          <div *ngSwitchCase="'actividad'" class="activity-details">
            <mat-form-field appearance="outline">
              <mat-label>Actividad</mat-label>
              <mat-select formControlName="activityId">
                <mat-option value="raquetas">Excursión con Raquetas</mat-option>
                <mat-option value="esqui-fondo">Esquí de Fondo</mat-option>
                <mat-option value="snowboard">Snowboard</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Fecha</mat-label>
              <input matInput [matDatepicker]="activityDatePicker" formControlName="date">
              <mat-datepicker-toggle matSuffix [for]="activityDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #activityDatePicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Participantes</mat-label>
              <input matInput type="number" formControlName="participants" min="1">
            </mat-form-field>
          </div>

          <!-- Material Details -->
          <div *ngSwitchCase="'material'" class="material-details">
            <mat-form-field appearance="outline">
              <mat-label>Pack de Material</mat-label>
              <mat-select formControlName="materialPack">
                <mat-option value="completo">Pack Esquí Completo</mat-option>
                <mat-option value="esquis">Solo Esquís</mat-option>
                <mat-option value="snowboard">Pack Snowboard</mat-option>
              </mat-select>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Fecha inicio</mat-label>
              <input matInput [matDatepicker]="startDatePicker" formControlName="startDate">
              <mat-datepicker-toggle matSuffix [for]="startDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #startDatePicker></mat-datepicker>
            </mat-form-field>

            <mat-form-field appearance="outline">
              <mat-label>Fecha fin</mat-label>
              <input matInput [matDatepicker]="endDatePicker" formControlName="endDate">
              <mat-datepicker-toggle matSuffix [for]="endDatePicker"></mat-datepicker-toggle>
              <mat-datepicker #endDatePicker></mat-datepicker>
            </mat-form-field>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button matStepperPrevious>Anterior</button>
          <button mat-raised-button color="primary" matStepperNext [disabled]="!detailsForm.valid">Siguiente</button>
        </div>
      </form>
    </mat-step>

    <!-- Step 4: Summary & Confirmation -->
    <mat-step label="Confirmación">
      <div class="step-form">
        <h3>Resumen de la reserva</h3>
        <p>Revisa los detalles antes de confirmar</p>

        <div class="reservation-summary">
          <div class="summary-section">
            <h4>Cliente</h4>
            <div class="client-summary">
              <div class="client-avatar">{{ selectedClient?.initials }}</div>
              <div class="client-info">
                <div class="client-name">{{ selectedClient?.name }}</div>
                <div class="client-details">{{ selectedClient?.age }} años • {{ selectedClient?.level }}</div>
              </div>
            </div>
          </div>

          <div class="summary-section">
            <h4>Servicio</h4>
            <div class="service-summary">
              <div class="service-type">{{ getSelectedServiceName() }}</div>
              <div class="service-details">{{ getServiceSummary() }}</div>
            </div>
          </div>

          <div class="summary-section">
            <h4>Precio</h4>
            <div class="price-summary">
              <div class="total-price">{{ calculateTotalPrice() }}€</div>
            </div>
          </div>
        </div>

        <div class="step-actions">
          <button mat-button matStepperPrevious>Anterior</button>
          <button mat-raised-button color="primary" (click)="confirmReservation()">
            Confirmar Reserva
          </button>
        </div>
      </div>
    </mat-step>
  </mat-horizontal-stepper>
</div>