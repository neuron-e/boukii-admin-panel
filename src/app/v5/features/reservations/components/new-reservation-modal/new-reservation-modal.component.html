<!-- Nueva Reserva Modal - V5 Figma Design -->
<div class="modal-overlay" [class.open]="isOpen" (click)="onOverlayClick($event)">
  <div class="modal-container" (click)="$event.stopPropagation()">
    <!-- Modal Header -->
    <div class="modal-header">
      <h2 class="modal-title">Nueva Reserva</h2>
      <div class="modal-step-indicator">
        Paso {{ currentStep }} de {{ totalSteps }}
      </div>
      <button class="modal-close-btn" (click)="closeModal()">
        <mat-icon>close</mat-icon>
      </button>
    </div>

    <!-- Progress Bar -->
    <div class="progress-container">
      <div class="progress-bar">
        <div class="progress-fill" [style.width.%]="progressPercentage"></div>
      </div>
    </div>

    <!-- Step Navigation -->
    <div class="step-navigation">
      <div class="step-tabs">
        <div 
          class="step-tab" 
          [class.active]="currentStep === 1"
          [class.completed]="currentStep > 1">
          Cliente
        </div>
        <div 
          class="step-tab" 
          [class.active]="currentStep === 2"
          [class.completed]="currentStep > 2">
          Tipo
        </div>
        <div 
          class="step-tab" 
          [class.active]="currentStep === 3"
          [class.completed]="currentStep > 3">
          Detalles
        </div>
        <div 
          class="step-tab" 
          [class.active]="currentStep === 4"
          [class.completed]="currentStep > 4">
          Resumen
        </div>
        <div 
          class="step-tab" 
          [class.active]="currentStep === 5"
          [class.completed]="currentStep > 5">
          Confirmación
        </div>
      </div>
    </div>

    <!-- Modal Content -->
    <div class="modal-content">
      
      <!-- Step 1: Cliente -->
      <div class="step-content" *ngIf="currentStep === 1">
        <h3 class="step-title">Seleccionar Cliente</h3>
        <p class="step-description">Selecciona el cliente para la reserva</p>
        
        <div class="client-selection">
          <!-- Client Search -->
          <div class="client-search">
            <div class="search-field">
              <mat-icon class="search-icon">search</mat-icon>
              <input 
                type="text" 
                placeholder="Buscar cliente por nombre, email o teléfono..." 
                [(ngModel)]="clientSearchTerm" 
                (input)="onClientSearch()"
                class="search-input">
            </div>
          </div>

          <!-- Client Results -->
          <div class="client-results" *ngIf="filteredClients.length > 0">
            <div class="client-list">
              <div 
                class="client-item" 
                *ngFor="let client of filteredClients"
                [class.selected]="selectedClient?.id === client.id"
                (click)="selectClient(client)">
                <div class="client-avatar">
                  <img [src]="client.avatar" [alt]="client.name" *ngIf="client.avatar">
                  <div class="avatar-placeholder" *ngIf="!client.avatar">
                    {{ getClientInitials(client.name) }}
                  </div>
                </div>
                <div class="client-info">
                  <h4 class="client-name">{{ client.name }}</h4>
                  <p class="client-email">{{ client.email }}</p>
                  <p class="client-phone">{{ client.phone }}</p>
                </div>
                <div class="client-selection-icon" *ngIf="selectedClient?.id === client.id">
                  <mat-icon>check_circle</mat-icon>
                </div>
              </div>
            </div>
          </div>

          <!-- No Results -->
          <div class="no-results" *ngIf="clientSearchTerm && filteredClients.length === 0">
            <mat-icon>person_search</mat-icon>
            <p>No se encontraron clientes</p>
            <button class="create-client-btn" (click)="createNewClient()">
              <mat-icon>add</mat-icon>
              Crear nuevo cliente
            </button>
          </div>

          <!-- Create New Client -->
          <div class="create-client" *ngIf="!clientSearchTerm">
            <button class="create-client-btn" (click)="createNewClient()">
              <mat-icon>add</mat-icon>
              Crear nuevo cliente
            </button>
          </div>
        </div>
      </div>

      <!-- Step 2: Tipo de Reserva -->
      <div class="step-content" *ngIf="currentStep === 2">
        <h3 class="step-title">Tipo de reserva</h3>
        <p class="step-description">Selecciona el tipo de servicio para {{ selectedClientName }}</p>
        
        <div class="service-options">
          <!-- Curso Colectivo -->
          <div class="service-card" 
               [class.selected]="selectedServiceType === 'colectivo'"
               (click)="selectServiceType('colectivo')">
            <div class="service-icon">
              <mat-icon>group</mat-icon>
            </div>
            <div class="service-info">
              <h4 class="service-title">Curso Colectivo</h4>
              <p class="service-description">Clases en grupo por niveles</p>
            </div>
          </div>

          <!-- Curso Privado -->
          <div class="service-card" 
               [class.selected]="selectedServiceType === 'privado'"
               (click)="selectServiceType('privado')">
            <div class="service-icon">
              <mat-icon>person</mat-icon>
            </div>
            <div class="service-info">
              <h4 class="service-title">Curso Privado</h4>
              <p class="service-description">Clases personalizadas 1:1</p>
            </div>
          </div>

          <!-- Actividad -->
          <div class="service-card" 
               [class.selected]="selectedServiceType === 'actividad'"
               (click)="selectServiceType('actividad')">
            <div class="service-icon activity-icon">
              <span>M</span>
            </div>
            <div class="service-info">
              <h4 class="service-title">Actividad</h4>
              <p class="service-description">Raquetas, excursiones, etc.</p>
            </div>
          </div>

          <!-- Alquiler de Material -->
          <div class="service-card" 
               [class.selected]="selectedServiceType === 'alquiler'"
               (click)="selectServiceType('alquiler')">
            <div class="service-icon rental-icon">
              <mat-icon>inventory_2</mat-icon>
            </div>
            <div class="service-info">
              <h4 class="service-title">Alquiler de Material</h4>
              <p class="service-description">Esquís, botas, bastones, etc.</p>
            </div>
          </div>
        </div>

        <!-- Selected Service Details -->
        <div class="selected-service-details" *ngIf="selectedServiceType === 'colectivo'">
          <div class="selection-indicator">
            <mat-icon>check_circle</mat-icon>
            <span>Curso Colectivo seleccionado</span>
          </div>
          
          <div class="available-groups">
            <h4 class="groups-title">Grupos disponibles</h4>
            
            <div class="group-option" 
                 *ngFor="let group of availableGroups"
                 [class.selected]="selectedGroup?.id === group.id"
                 (click)="selectGroup(group)">
              <div class="group-info">
                <h5 class="group-name">{{ group.name }}</h5>
                <p class="group-schedule">{{ group.schedule }}</p>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 3: Detalles -->
      <div class="step-content" *ngIf="currentStep === 3">
        <h3 class="step-title">Detalles de la Reserva</h3>
        <p class="step-description">Configura los detalles específicos de la reserva</p>
        
        <div class="details-form">
          <!-- Service Summary -->
          <div class="service-summary">
            <div class="summary-card">
              <div class="service-type-info">
                <div class="service-icon-small">
                  <mat-icon *ngIf="selectedServiceType === 'colectivo'">group</mat-icon>
                  <mat-icon *ngIf="selectedServiceType === 'privado'">person</mat-icon>
                  <span *ngIf="selectedServiceType === 'actividad'" class="activity-icon-small">M</span>
                  <mat-icon *ngIf="selectedServiceType === 'alquiler'">inventory_2</mat-icon>
                </div>
                <div class="service-details">
                  <h4>{{ getServiceTypeLabel(selectedServiceType) }}</h4>
                  <p *ngIf="selectedGroup">{{ selectedGroup.name }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Date and Time Selection -->
          <div class="form-section">
            <h4 class="section-title">Fecha y Horario</h4>
            <div class="form-row">
              <div class="form-field">
                <label class="field-label">Fecha de inicio</label>
                <input 
                  type="date" 
                  [(ngModel)]="reservationDetails.startDate"
                  class="date-input">
              </div>
              <div class="form-field">
                <label class="field-label">Hora de inicio</label>
                <select [(ngModel)]="reservationDetails.startTime" class="time-select">
                  <option value="">Seleccionar hora</option>
                  <option value="09:00">09:00</option>
                  <option value="10:00">10:00</option>
                  <option value="11:00">11:00</option>
                  <option value="12:00">12:00</option>
                  <option value="14:00">14:00</option>
                  <option value="15:00">15:00</option>
                  <option value="16:00">16:00</option>
                  <option value="17:00">17:00</option>
                </select>
              </div>
            </div>
            
            <div class="form-row" *ngIf="selectedServiceType === 'alquiler'">
              <div class="form-field">
                <label class="field-label">Fecha de devolución</label>
                <input 
                  type="date" 
                  [(ngModel)]="reservationDetails.endDate"
                  class="date-input">
              </div>
            </div>
          </div>

          <!-- Participants -->
          <div class="form-section" *ngIf="selectedServiceType !== 'alquiler'">
            <h4 class="section-title">Participantes</h4>
            <div class="form-row">
              <div class="form-field">
                <label class="field-label">Número de participantes</label>
                <select [(ngModel)]="reservationDetails.participants" class="participants-select">
                  <option value="1">1 persona</option>
                  <option value="2">2 personas</option>
                  <option value="3">3 personas</option>
                  <option value="4">4 personas</option>
                  <option value="5">5 personas</option>
                </select>
              </div>
            </div>
          </div>

          <!-- Special Requirements -->
          <div class="form-section">
            <h4 class="section-title">Información Adicional</h4>
            <div class="form-field">
              <label class="field-label">Notas especiales (opcional)</label>
              <textarea 
                [(ngModel)]="reservationDetails.notes"
                placeholder="Cualquier información adicional, requisitos especiales, etc."
                class="notes-textarea"
                rows="3">
              </textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 4: Resumen -->
      <div class="step-content" *ngIf="currentStep === 4">
        <h3 class="step-title">Resumen de la Reserva</h3>
        <p class="step-description">Revisa los detalles antes de confirmar</p>
        
        <div class="reservation-summary">
          <!-- Client Summary -->
          <div class="summary-section">
            <h4 class="summary-section-title">Cliente</h4>
            <div class="client-summary">
              <div class="client-avatar-small">
                <img [src]="selectedClient?.avatar" [alt]="selectedClient?.name" *ngIf="selectedClient?.avatar">
                <div class="avatar-placeholder-small" *ngIf="!selectedClient?.avatar">
                  {{ getClientInitials(selectedClient?.name || '') }}
                </div>
              </div>
              <div class="client-summary-info">
                <h5>{{ selectedClient?.name }}</h5>
                <p>{{ selectedClient?.email }}</p>
                <p>{{ selectedClient?.phone }}</p>
              </div>
            </div>
          </div>

          <!-- Service Summary -->
          <div class="summary-section">
            <h4 class="summary-section-title">Servicio</h4>
            <div class="service-summary-card">
              <div class="service-type-summary">
                <div class="service-icon-summary">
                  <mat-icon *ngIf="selectedServiceType === 'colectivo'">group</mat-icon>
                  <mat-icon *ngIf="selectedServiceType === 'privado'">person</mat-icon>
                  <span *ngIf="selectedServiceType === 'actividad'" class="activity-icon-summary">M</span>
                  <mat-icon *ngIf="selectedServiceType === 'alquiler'">inventory_2</mat-icon>
                </div>
                <div>
                  <h5>{{ getServiceTypeLabel(selectedServiceType) }}</h5>
                  <p *ngIf="selectedGroup">{{ selectedGroup.name }}</p>
                  <p *ngIf="selectedGroup">{{ selectedGroup.schedule }}</p>
                </div>
              </div>
            </div>
          </div>

          <!-- Details Summary -->
          <div class="summary-section">
            <h4 class="summary-section-title">Detalles</h4>
            <div class="details-summary">
              <div class="detail-item">
                <span class="detail-label">Fecha:</span>
                <span class="detail-value">{{ formatDate(reservationDetails.startDate) }}</span>
              </div>
              <div class="detail-item">
                <span class="detail-label">Hora:</span>
                <span class="detail-value">{{ reservationDetails.startTime }}</span>
              </div>
              <div class="detail-item" *ngIf="reservationDetails.endDate">
                <span class="detail-label">Fecha devolución:</span>
                <span class="detail-value">{{ formatDate(reservationDetails.endDate) }}</span>
              </div>
              <div class="detail-item" *ngIf="reservationDetails.participants">
                <span class="detail-label">Participantes:</span>
                <span class="detail-value">{{ reservationDetails.participants }} {{ reservationDetails.participants === '1' ? 'persona' : 'personas' }}</span>
              </div>
              <div class="detail-item" *ngIf="reservationDetails.notes">
                <span class="detail-label">Notas:</span>
                <span class="detail-value">{{ reservationDetails.notes }}</span>
              </div>
            </div>
          </div>

          <!-- Price Summary -->
          <div class="summary-section">
            <h4 class="summary-section-title">Precio</h4>
            <div class="price-summary">
              <div class="price-breakdown">
                <div class="price-item">
                  <span>{{ getServiceTypeLabel(selectedServiceType) }}</span>
                  <span>{{ calculateBasePrice() }}€</span>
                </div>
                <div class="price-item" *ngIf="reservationDetails.participants && reservationDetails.participants !== '1'">
                  <span>Participantes adicionales ({{ parseInt(reservationDetails.participants) - 1 }})</span>
                  <span>{{ calculateAdditionalParticipantsPrice() }}€</span>
                </div>
              </div>
              <div class="price-total">
                <span class="total-label">Total:</span>
                <span class="total-amount">{{ calculateTotalPrice() }}€</span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 5: Confirmación -->
      <div class="step-content" *ngIf="currentStep === 5">
        <div class="confirmation-content">
          <div class="success-icon">
            <mat-icon>check_circle</mat-icon>
          </div>
          <h3 class="confirmation-title">¡Reserva Creada Exitosamente!</h3>
          <p class="confirmation-message">
            La reserva ha sido creada y se ha enviado una confirmación por email a {{ selectedClient?.email }}
          </p>
          
          <div class="reservation-id-card">
            <div class="reservation-id-info">
              <span class="id-label">ID de Reserva:</span>
              <span class="id-value">{{ generatedReservationId }}</span>
            </div>
            <button class="copy-id-btn" (click)="copyReservationId()">
              <mat-icon>content_copy</mat-icon>
            </button>
          </div>

          <div class="next-steps">
            <h4>Próximos pasos:</h4>
            <ul>
              <li>El cliente recibirá un email con los detalles de la reserva</li>
              <li>Puedes ver y editar la reserva desde la lista de reservas</li>
              <li>Se enviará un recordatorio 24h antes de la fecha programada</li>
            </ul>
          </div>

          <div class="confirmation-actions">
            <button class="btn-secondary" (click)="viewReservationList()">
              <mat-icon>list</mat-icon>
              Ver todas las reservas
            </button>
            <button class="btn-primary" (click)="createAnotherReservation()">
              <mat-icon>add</mat-icon>
              Crear otra reserva
            </button>
          </div>
        </div>
      </div>
    </div>

    <!-- Modal Footer -->
    <div class="modal-footer">
      <button 
        class="btn-secondary" 
        (click)="previousStep()"
        [disabled]="currentStep === 1">
        <mat-icon>arrow_back</mat-icon>
        Anterior
      </button>
      
      <button 
        class="btn-primary" 
        (click)="nextStep()"
        [disabled]="!canProceed()">
        <span *ngIf="currentStep < totalSteps">Siguiente</span>
        <span *ngIf="currentStep === totalSteps">Finalizar</span>
        <mat-icon *ngIf="currentStep < totalSteps">arrow_forward</mat-icon>
      </button>
    </div>
  </div>
</div>